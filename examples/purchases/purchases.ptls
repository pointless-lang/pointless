-- https://www.sumsar.net/blog/pandas-feels-clunky-when-coming-from-r/

purchases = import "csv:purchases.csv"

fn calcTotal(group)
  threshold = List.median(group.amount) * 10

  total = group
    ? arg.amount <= threshold
    $ arg.amount - arg.discount
    | sum

  { total }
end

purchases
  | Table.summarize("country", calcTotal)
  | sortDescBy("total")
  | print
