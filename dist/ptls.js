import{dirname,resolve}from"node:path";import{createInterface,emitKeypressEvents}from"node:readline";import{stdin,stdout,argv}from"node:process";import{writeFile,readFile,readdir,realpath}from"node:fs/promises";import{tmpdir}from"node:os";import{Buffer as Buffer$1}from"node:buffer";function checkPositive(n){if(checkType(n,"number"),Number.isNaN(n)||n<0)throw new Panic$1("expected a positive number");return n}function checkWhole(n){if(checkType(n,"number"),!Number.isInteger(n))throw new Panic$1("expected a whole number");return n}function checkNumResult(result,...args){if(args.some(arg=>!Number.isFinite(arg)))return result;switch(result){case 1/0:case-1/0:throw new Panic$1("result out of range")}if(Number.isNaN(result))throw new Panic$1("invalid arguments");return result}function isIndexed(maybeIndexed){return Boolean(maybeIndexed&&maybeIndexed["@@__IMMUTABLE_INDEXED__@@"])}function isKeyed(maybeKeyed){return Boolean(maybeKeyed&&maybeKeyed["@@__IMMUTABLE_KEYED__@@"])}function isAssociative(maybeAssociative){return isKeyed(maybeAssociative)||isIndexed(maybeAssociative)}function isCollection(maybeCollection){return Boolean(maybeCollection&&maybeCollection["@@__IMMUTABLE_ITERABLE__@@"])}var Collection=function(value){return isCollection(value)?value:Seq(value)},KeyedCollection=function(Collection){function KeyedCollection(value){return isKeyed(value)?value:KeyedSeq(value)}return Collection&&(KeyedCollection.__proto__=Collection),KeyedCollection.prototype=Object.create(Collection&&Collection.prototype),KeyedCollection.prototype.constructor=KeyedCollection,KeyedCollection}(Collection),IndexedCollection=function(Collection){function IndexedCollection(value){return isIndexed(value)?value:IndexedSeq(value)}return Collection&&(IndexedCollection.__proto__=Collection),IndexedCollection.prototype=Object.create(Collection&&Collection.prototype),IndexedCollection.prototype.constructor=IndexedCollection,IndexedCollection}(Collection),SetCollection=function(Collection){function SetCollection(value){return isCollection(value)&&!isAssociative(value)?value:SetSeq(value)}return Collection&&(SetCollection.__proto__=Collection),SetCollection.prototype=Object.create(Collection&&Collection.prototype),SetCollection.prototype.constructor=SetCollection,SetCollection}(Collection);Collection.Keyed=KeyedCollection,Collection.Indexed=IndexedCollection,Collection.Set=SetCollection;var REAL_ITERATOR_SYMBOL="function"==typeof Symbol&&Symbol.iterator,ITERATOR_SYMBOL=REAL_ITERATOR_SYMBOL||"@@iterator",Iterator=function(next){this.next=next};function iteratorValue(type,k,v,iteratorResult){var value=0===type?k:1===type?v:[k,v];return iteratorResult?iteratorResult.value=value:iteratorResult={value:value,done:!1},iteratorResult}function iteratorDone(){return{value:void 0,done:!0}}function hasIterator(maybeIterable){return!!Array.isArray(maybeIterable)||!!getIteratorFn(maybeIterable)}function isIterator(maybeIterator){return!(!maybeIterator||"function"!=typeof maybeIterator.next)}function getIterator(iterable){var iteratorFn=getIteratorFn(iterable);return iteratorFn&&iteratorFn.call(iterable)}function getIteratorFn(iterable){var iteratorFn=iterable&&(REAL_ITERATOR_SYMBOL&&iterable[REAL_ITERATOR_SYMBOL]||iterable["@@iterator"]);if("function"==typeof iteratorFn)return iteratorFn}Iterator.prototype.toString=function(){return"[Iterator]"},Iterator.KEYS=0,Iterator.VALUES=1,Iterator.ENTRIES=2,Iterator.prototype.inspect=Iterator.prototype.toSource=function(){return this.toString()},Iterator.prototype[ITERATOR_SYMBOL]=function(){return this};var NOT_SET={};function SetRef(ref){ref&&(ref.value=!0)}function OwnerID(){}function ensureSize(iter){return void 0===iter.size&&(iter.size=iter.__iterate(returnTrue)),iter.size}function wrapIndex(iter,index){if("number"!=typeof index){var uint32Index=index>>>0;if(""+uint32Index!==index||4294967295===uint32Index)return NaN;index=uint32Index}return index<0?ensureSize(iter)+index:index}function returnTrue(){return!0}function wholeSlice(begin,end,size){return(0===begin&&!isNeg(begin)||void 0!==size&&begin<=-size)&&(void 0===end||void 0!==size&&end>=size)}function resolveBegin(begin,size){return resolveIndex(begin,size,0)}function resolveEnd(end,size){return resolveIndex(end,size,size)}function resolveIndex(index,size,defaultIndex){return void 0===index?defaultIndex:isNeg(index)?size===1/0?size:0|Math.max(0,size+index):void 0===size||size===index?index:0|Math.min(size,index)}function isNeg(value){return value<0||0===value&&1/value==-1/0}function isRecord(maybeRecord){return Boolean(maybeRecord&&maybeRecord["@@__IMMUTABLE_RECORD__@@"])}function isImmutable(maybeImmutable){return isCollection(maybeImmutable)||isRecord(maybeImmutable)}var IS_ORDERED_SYMBOL="@@__IMMUTABLE_ORDERED__@@";function isOrdered(maybeOrdered){return Boolean(maybeOrdered&&maybeOrdered[IS_ORDERED_SYMBOL])}function isSeq(maybeSeq){return Boolean(maybeSeq&&maybeSeq["@@__IMMUTABLE_SEQ__@@"])}var hasOwnProperty=Object.prototype.hasOwnProperty;function isArrayLike(value){return!(!Array.isArray(value)&&"string"!=typeof value)||value&&"object"==typeof value&&Number.isInteger(value.length)&&value.length>=0&&(0===value.length?1===Object.keys(value).length:value.hasOwnProperty(value.length-1))}var Seq=function(Collection){function Seq(value){return null==value?emptySequence():isImmutable(value)?value.toSeq():function(value){var seq=maybeIndexedSeqFromValue(value);if(seq)return(iteratorFn=getIteratorFn(maybeIterable=value))&&iteratorFn===maybeIterable.entries?seq.fromEntrySeq():function(maybeIterable){var iteratorFn=getIteratorFn(maybeIterable);return iteratorFn&&iteratorFn===maybeIterable.keys}(value)?seq.toSetSeq():seq;var maybeIterable,iteratorFn;if("object"==typeof value)return new ObjectSeq(value);throw new TypeError("Expected Array or collection object of values, or keyed object: "+value)}(value)}return Collection&&(Seq.__proto__=Collection),Seq.prototype=Object.create(Collection&&Collection.prototype),Seq.prototype.constructor=Seq,Seq.prototype.toSeq=function(){return this},Seq.prototype.toString=function(){return this.__toString("Seq {","}")},Seq.prototype.cacheResult=function(){return!this._cache&&this.__iterateUncached&&(this._cache=this.entrySeq().toArray(),this.size=this._cache.length),this},Seq.prototype.__iterate=function(fn,reverse){var cache=this._cache;if(cache){for(var size=cache.length,i=0;i!==size;){var entry=cache[reverse?size-++i:i++];if(!1===fn(entry[1],entry[0],this))break}return i}return this.__iterateUncached(fn,reverse)},Seq.prototype.__iterator=function(type,reverse){var cache=this._cache;if(cache){var size=cache.length,i=0;return new Iterator(function(){if(i===size)return{value:void 0,done:!0};var entry=cache[reverse?size-++i:i++];return iteratorValue(type,entry[0],entry[1])})}return this.__iteratorUncached(type,reverse)},Seq}(Collection),KeyedSeq=function(Seq){function KeyedSeq(value){return null==value?emptySequence().toKeyedSeq():isCollection(value)?isKeyed(value)?value.toSeq():value.fromEntrySeq():isRecord(value)?value.toSeq():keyedSeqFromValue(value)}return Seq&&(KeyedSeq.__proto__=Seq),KeyedSeq.prototype=Object.create(Seq&&Seq.prototype),KeyedSeq.prototype.constructor=KeyedSeq,KeyedSeq.prototype.toKeyedSeq=function(){return this},KeyedSeq}(Seq),IndexedSeq=function(Seq){function IndexedSeq(value){return null==value?emptySequence():isCollection(value)?isKeyed(value)?value.entrySeq():value.toIndexedSeq():isRecord(value)?value.toSeq().entrySeq():indexedSeqFromValue(value)}return Seq&&(IndexedSeq.__proto__=Seq),IndexedSeq.prototype=Object.create(Seq&&Seq.prototype),IndexedSeq.prototype.constructor=IndexedSeq,IndexedSeq.of=function(){return IndexedSeq(arguments)},IndexedSeq.prototype.toIndexedSeq=function(){return this},IndexedSeq.prototype.toString=function(){return this.__toString("Seq [","]")},IndexedSeq}(Seq),SetSeq=function(Seq){function SetSeq(value){return(isCollection(value)&&!isAssociative(value)?value:IndexedSeq(value)).toSetSeq()}return Seq&&(SetSeq.__proto__=Seq),SetSeq.prototype=Object.create(Seq&&Seq.prototype),SetSeq.prototype.constructor=SetSeq,SetSeq.of=function(){return SetSeq(arguments)},SetSeq.prototype.toSetSeq=function(){return this},SetSeq}(Seq);Seq.isSeq=isSeq,Seq.Keyed=KeyedSeq,Seq.Set=SetSeq,Seq.Indexed=IndexedSeq,Seq.prototype["@@__IMMUTABLE_SEQ__@@"]=!0;var ArraySeq=function(IndexedSeq){function ArraySeq(array){this._array=array,this.size=array.length}return IndexedSeq&&(ArraySeq.__proto__=IndexedSeq),ArraySeq.prototype=Object.create(IndexedSeq&&IndexedSeq.prototype),ArraySeq.prototype.constructor=ArraySeq,ArraySeq.prototype.get=function(index,notSetValue){return this.has(index)?this._array[wrapIndex(this,index)]:notSetValue},ArraySeq.prototype.__iterate=function(fn,reverse){for(var array=this._array,size=array.length,i=0;i!==size;){var ii=reverse?size-++i:i++;if(!1===fn(array[ii],ii,this))break}return i},ArraySeq.prototype.__iterator=function(type,reverse){var array=this._array,size=array.length,i=0;return new Iterator(function(){if(i===size)return{value:void 0,done:!0};var ii=reverse?size-++i:i++;return iteratorValue(type,ii,array[ii])})},ArraySeq}(IndexedSeq),ObjectSeq=function(KeyedSeq){function ObjectSeq(object){var keys=Object.keys(object).concat(Object.getOwnPropertySymbols?Object.getOwnPropertySymbols(object):[]);this._object=object,this._keys=keys,this.size=keys.length}return KeyedSeq&&(ObjectSeq.__proto__=KeyedSeq),ObjectSeq.prototype=Object.create(KeyedSeq&&KeyedSeq.prototype),ObjectSeq.prototype.constructor=ObjectSeq,ObjectSeq.prototype.get=function(key,notSetValue){return void 0===notSetValue||this.has(key)?this._object[key]:notSetValue},ObjectSeq.prototype.has=function(key){return hasOwnProperty.call(this._object,key)},ObjectSeq.prototype.__iterate=function(fn,reverse){for(var object=this._object,keys=this._keys,size=keys.length,i=0;i!==size;){var key=keys[reverse?size-++i:i++];if(!1===fn(object[key],key,this))break}return i},ObjectSeq.prototype.__iterator=function(type,reverse){var object=this._object,keys=this._keys,size=keys.length,i=0;return new Iterator(function(){if(i===size)return{value:void 0,done:!0};var key=keys[reverse?size-++i:i++];return iteratorValue(type,key,object[key])})},ObjectSeq}(KeyedSeq);ObjectSeq.prototype[IS_ORDERED_SYMBOL]=!0;var EMPTY_SEQ,CollectionSeq=function(IndexedSeq){function CollectionSeq(collection){this._collection=collection,this.size=collection.length||collection.size}return IndexedSeq&&(CollectionSeq.__proto__=IndexedSeq),CollectionSeq.prototype=Object.create(IndexedSeq&&IndexedSeq.prototype),CollectionSeq.prototype.constructor=CollectionSeq,CollectionSeq.prototype.__iterateUncached=function(fn,reverse){if(reverse)return this.cacheResult().__iterate(fn,reverse);var iterator=getIterator(this._collection),iterations=0;if(isIterator(iterator))for(var step;!(step=iterator.next()).done&&!1!==fn(step.value,iterations++,this););return iterations},CollectionSeq.prototype.__iteratorUncached=function(type,reverse){if(reverse)return this.cacheResult().__iterator(type,reverse);var iterator=getIterator(this._collection);if(!isIterator(iterator))return new Iterator(iteratorDone);var iterations=0;return new Iterator(function(){var step=iterator.next();return step.done?step:iteratorValue(type,iterations++,step.value)})},CollectionSeq}(IndexedSeq);function emptySequence(){return EMPTY_SEQ||(EMPTY_SEQ=new ArraySeq([]))}function keyedSeqFromValue(value){var seq=maybeIndexedSeqFromValue(value);if(seq)return seq.fromEntrySeq();if("object"==typeof value)return new ObjectSeq(value);throw new TypeError("Expected Array or collection object of [k, v] entries, or keyed object: "+value)}function indexedSeqFromValue(value){var seq=maybeIndexedSeqFromValue(value);if(seq)return seq;throw new TypeError("Expected Array or collection object of values: "+value)}function maybeIndexedSeqFromValue(value){return isArrayLike(value)?new ArraySeq(value):hasIterator(value)?new CollectionSeq(value):void 0}function asImmutable(){return this.__ensureOwner()}function asMutable(){return this.__ownerID?this:this.__ensureOwner(new OwnerID)}var imul="function"==typeof Math.imul&&-2===Math.imul(4294967295,2)?Math.imul:function(a,b){var c=65535&(a|=0),d=65535&(b|=0);return c*d+((a>>>16)*d+c*(b>>>16)<<16>>>0)|0};function smi(i32){return i32>>>1&1073741824|3221225471&i32}var defaultValueOf=Object.prototype.valueOf;function hash(o){if(null==o)return hashNullish(o);if("function"==typeof o.hashCode)return smi(o.hashCode(o));var obj,v=(obj=o).valueOf!==defaultValueOf&&"function"==typeof obj.valueOf?obj.valueOf(obj):obj;if(null==v)return hashNullish(v);switch(typeof v){case"boolean":return v?1108378657:1108378656;case"number":return function(n){if(n!=n||n===1/0)return 0;var hash=0|n;hash!==n&&(hash^=4294967295*n);for(;n>4294967295;)hash^=n/=4294967295;return smi(hash)}(v);case"string":return v.length>STRING_HASH_CACHE_MIN_STRLEN?function(string){var hashed=stringHashCache[string];void 0===hashed&&(hashed=hashString(string),STRING_HASH_CACHE_SIZE===STRING_HASH_CACHE_MAX_SIZE&&(STRING_HASH_CACHE_SIZE=0,stringHashCache={}),STRING_HASH_CACHE_SIZE++,stringHashCache[string]=hashed);return hashed}(v):hashString(v);case"object":case"function":return function(obj){var hashed;if(usingWeakMap&&void 0!==(hashed=weakMap.get(obj)))return hashed;if(hashed=obj[UID_HASH_KEY],void 0!==hashed)return hashed;if(!canDefineProperty){if(void 0!==(hashed=obj.propertyIsEnumerable&&obj.propertyIsEnumerable[UID_HASH_KEY]))return hashed;if(void 0!==(hashed=function(node){if(node&&node.nodeType>0)switch(node.nodeType){case 1:return node.uniqueID;case 9:return node.documentElement&&node.documentElement.uniqueID}}(obj)))return hashed}if(hashed=nextHash(),usingWeakMap)weakMap.set(obj,hashed);else{if(void 0!==isExtensible&&!1===isExtensible(obj))throw new Error("Non-extensible objects are not allowed as keys.");if(canDefineProperty)Object.defineProperty(obj,UID_HASH_KEY,{enumerable:!1,configurable:!1,writable:!1,value:hashed});else if(void 0!==obj.propertyIsEnumerable&&obj.propertyIsEnumerable===obj.constructor.prototype.propertyIsEnumerable)obj.propertyIsEnumerable=function(){return this.constructor.prototype.propertyIsEnumerable.apply(this,arguments)},obj.propertyIsEnumerable[UID_HASH_KEY]=hashed;else{if(void 0===obj.nodeType)throw new Error("Unable to set a non-enumerable property on object.");obj[UID_HASH_KEY]=hashed}}return hashed}(v);case"symbol":return function(sym){var hashed=symbolMap[sym];if(void 0!==hashed)return hashed;return hashed=nextHash(),symbolMap[sym]=hashed,hashed}(v);default:if("function"==typeof v.toString)return hashString(v.toString());throw new Error("Value type "+typeof v+" cannot be hashed.")}}function hashNullish(nullish){return null===nullish?1108378658:1108378659}function hashString(string){for(var hashed=0,ii=0;ii<string.length;ii++)hashed=31*hashed+string.charCodeAt(ii)|0;return smi(hashed)}var isExtensible=Object.isExtensible,canDefineProperty=function(){try{return Object.defineProperty({},"@",{}),!0}catch(e){return!1}}();function nextHash(){var nextHash=++_objHashUID;return 1073741824&_objHashUID&&(_objHashUID=0),nextHash}var weakMap,usingWeakMap="function"==typeof WeakMap;usingWeakMap&&(weakMap=new WeakMap);var symbolMap=Object.create(null),_objHashUID=0,UID_HASH_KEY="__immutablehash__";"function"==typeof Symbol&&(UID_HASH_KEY=Symbol(UID_HASH_KEY));var STRING_HASH_CACHE_MIN_STRLEN=16,STRING_HASH_CACHE_MAX_SIZE=255,STRING_HASH_CACHE_SIZE=0,stringHashCache={},ToKeyedSequence=function(KeyedSeq){function ToKeyedSequence(indexed,useKeys){this._iter=indexed,this._useKeys=useKeys,this.size=indexed.size}return KeyedSeq&&(ToKeyedSequence.__proto__=KeyedSeq),ToKeyedSequence.prototype=Object.create(KeyedSeq&&KeyedSeq.prototype),ToKeyedSequence.prototype.constructor=ToKeyedSequence,ToKeyedSequence.prototype.get=function(key,notSetValue){return this._iter.get(key,notSetValue)},ToKeyedSequence.prototype.has=function(key){return this._iter.has(key)},ToKeyedSequence.prototype.valueSeq=function(){return this._iter.valueSeq()},ToKeyedSequence.prototype.reverse=function(){var this$1$1=this,reversedSequence=reverseFactory(this,!0);return this._useKeys||(reversedSequence.valueSeq=function(){return this$1$1._iter.toSeq().reverse()}),reversedSequence},ToKeyedSequence.prototype.map=function(mapper,context){var this$1$1=this,mappedSequence=mapFactory(this,mapper,context);return this._useKeys||(mappedSequence.valueSeq=function(){return this$1$1._iter.toSeq().map(mapper,context)}),mappedSequence},ToKeyedSequence.prototype.__iterate=function(fn,reverse){var this$1$1=this;return this._iter.__iterate(function(v,k){return fn(v,k,this$1$1)},reverse)},ToKeyedSequence.prototype.__iterator=function(type,reverse){return this._iter.__iterator(type,reverse)},ToKeyedSequence}(KeyedSeq);ToKeyedSequence.prototype[IS_ORDERED_SYMBOL]=!0;var ToIndexedSequence=function(IndexedSeq){function ToIndexedSequence(iter){this._iter=iter,this.size=iter.size}return IndexedSeq&&(ToIndexedSequence.__proto__=IndexedSeq),ToIndexedSequence.prototype=Object.create(IndexedSeq&&IndexedSeq.prototype),ToIndexedSequence.prototype.constructor=ToIndexedSequence,ToIndexedSequence.prototype.includes=function(value){return this._iter.includes(value)},ToIndexedSequence.prototype.__iterate=function(fn,reverse){var this$1$1=this,i=0;return reverse&&ensureSize(this),this._iter.__iterate(function(v){return fn(v,reverse?this$1$1.size-++i:i++,this$1$1)},reverse)},ToIndexedSequence.prototype.__iterator=function(type,reverse){var this$1$1=this,iterator=this._iter.__iterator(1,reverse),i=0;return reverse&&ensureSize(this),new Iterator(function(){var step=iterator.next();return step.done?step:iteratorValue(type,reverse?this$1$1.size-++i:i++,step.value,step)})},ToIndexedSequence}(IndexedSeq),ToSetSequence=function(SetSeq){function ToSetSequence(iter){this._iter=iter,this.size=iter.size}return SetSeq&&(ToSetSequence.__proto__=SetSeq),ToSetSequence.prototype=Object.create(SetSeq&&SetSeq.prototype),ToSetSequence.prototype.constructor=ToSetSequence,ToSetSequence.prototype.has=function(key){return this._iter.includes(key)},ToSetSequence.prototype.__iterate=function(fn,reverse){var this$1$1=this;return this._iter.__iterate(function(v){return fn(v,v,this$1$1)},reverse)},ToSetSequence.prototype.__iterator=function(type,reverse){var iterator=this._iter.__iterator(1,reverse);return new Iterator(function(){var step=iterator.next();return step.done?step:iteratorValue(type,step.value,step.value,step)})},ToSetSequence}(SetSeq),FromEntriesSequence=function(KeyedSeq){function FromEntriesSequence(entries){this._iter=entries,this.size=entries.size}return KeyedSeq&&(FromEntriesSequence.__proto__=KeyedSeq),FromEntriesSequence.prototype=Object.create(KeyedSeq&&KeyedSeq.prototype),FromEntriesSequence.prototype.constructor=FromEntriesSequence,FromEntriesSequence.prototype.entrySeq=function(){return this._iter.toSeq()},FromEntriesSequence.prototype.__iterate=function(fn,reverse){var this$1$1=this;return this._iter.__iterate(function(entry){if(entry){validateEntry(entry);var indexedCollection=isCollection(entry);return fn(indexedCollection?entry.get(1):entry[1],indexedCollection?entry.get(0):entry[0],this$1$1)}},reverse)},FromEntriesSequence.prototype.__iterator=function(type,reverse){var iterator=this._iter.__iterator(1,reverse);return new Iterator(function(){for(;;){var step=iterator.next();if(step.done)return step;var entry=step.value;if(entry){validateEntry(entry);var indexedCollection=isCollection(entry);return iteratorValue(type,indexedCollection?entry.get(0):entry[0],indexedCollection?entry.get(1):entry[1],step)}}})},FromEntriesSequence}(KeyedSeq);function flipFactory(collection){var flipSequence=makeSequence(collection);return flipSequence._iter=collection,flipSequence.size=collection.size,flipSequence.flip=function(){return collection},flipSequence.reverse=function(){var reversedSequence=collection.reverse.apply(this);return reversedSequence.flip=function(){return collection.reverse()},reversedSequence},flipSequence.has=function(key){return collection.includes(key)},flipSequence.includes=function(key){return collection.has(key)},flipSequence.cacheResult=cacheResultThrough,flipSequence.__iterateUncached=function(fn,reverse){var this$1$1=this;return collection.__iterate(function(v,k){return!1!==fn(k,v,this$1$1)},reverse)},flipSequence.__iteratorUncached=function(type,reverse){if(2===type){var iterator=collection.__iterator(type,reverse);return new Iterator(function(){var step=iterator.next();if(!step.done){var k=step.value[0];step.value[0]=step.value[1],step.value[1]=k}return step})}return collection.__iterator(1===type?0:1,reverse)},flipSequence}function mapFactory(collection,mapper,context){var mappedSequence=makeSequence(collection);return mappedSequence.size=collection.size,mappedSequence.has=function(key){return collection.has(key)},mappedSequence.get=function(key,notSetValue){var v=collection.get(key,NOT_SET);return v===NOT_SET?notSetValue:mapper.call(context,v,key,collection)},mappedSequence.__iterateUncached=function(fn,reverse){var this$1$1=this;return collection.__iterate(function(v,k,c){return!1!==fn(mapper.call(context,v,k,c),k,this$1$1)},reverse)},mappedSequence.__iteratorUncached=function(type,reverse){var iterator=collection.__iterator(2,reverse);return new Iterator(function(){var step=iterator.next();if(step.done)return step;var entry=step.value,key=entry[0];return iteratorValue(type,key,mapper.call(context,entry[1],key,collection),step)})},mappedSequence}function reverseFactory(collection,useKeys){var this$1$1=this,reversedSequence=makeSequence(collection);return reversedSequence._iter=collection,reversedSequence.size=collection.size,reversedSequence.reverse=function(){return collection},collection.flip&&(reversedSequence.flip=function(){var flipSequence=flipFactory(collection);return flipSequence.reverse=function(){return collection.flip()},flipSequence}),reversedSequence.get=function(key,notSetValue){return collection.get(useKeys?key:-1-key,notSetValue)},reversedSequence.has=function(key){return collection.has(useKeys?key:-1-key)},reversedSequence.includes=function(value){return collection.includes(value)},reversedSequence.cacheResult=cacheResultThrough,reversedSequence.__iterate=function(fn,reverse){var this$1$1=this,i=0;return reverse&&ensureSize(collection),collection.__iterate(function(v,k){return fn(v,useKeys?k:reverse?this$1$1.size-++i:i++,this$1$1)},!reverse)},reversedSequence.__iterator=function(type,reverse){var i=0;reverse&&ensureSize(collection);var iterator=collection.__iterator(2,!reverse);return new Iterator(function(){var step=iterator.next();if(step.done)return step;var entry=step.value;return iteratorValue(type,useKeys?entry[0]:reverse?this$1$1.size-++i:i++,entry[1],step)})},reversedSequence}function filterFactory(collection,predicate,context,useKeys){var filterSequence=makeSequence(collection);return useKeys&&(filterSequence.has=function(key){var v=collection.get(key,NOT_SET);return v!==NOT_SET&&!!predicate.call(context,v,key,collection)},filterSequence.get=function(key,notSetValue){var v=collection.get(key,NOT_SET);return v!==NOT_SET&&predicate.call(context,v,key,collection)?v:notSetValue}),filterSequence.__iterateUncached=function(fn,reverse){var this$1$1=this,iterations=0;return collection.__iterate(function(v,k,c){if(predicate.call(context,v,k,c))return iterations++,fn(v,useKeys?k:iterations-1,this$1$1)},reverse),iterations},filterSequence.__iteratorUncached=function(type,reverse){var iterator=collection.__iterator(2,reverse),iterations=0;return new Iterator(function(){for(;;){var step=iterator.next();if(step.done)return step;var entry=step.value,key=entry[0],value=entry[1];if(predicate.call(context,value,key,collection))return iteratorValue(type,useKeys?key:iterations++,value,step)}})},filterSequence}function sliceFactory(collection,begin,end,useKeys){var originalSize=collection.size;if(wholeSlice(begin,end,originalSize))return collection;if(void 0===originalSize&&(begin<0||end<0))return sliceFactory(collection.toSeq().cacheResult(),begin,end,useKeys);var sliceSize,resolvedBegin=resolveBegin(begin,originalSize),resolvedSize=resolveEnd(end,originalSize)-resolvedBegin;resolvedSize==resolvedSize&&(sliceSize=resolvedSize<0?0:resolvedSize);var sliceSeq=makeSequence(collection);return sliceSeq.size=0===sliceSize?sliceSize:collection.size&&sliceSize||void 0,!useKeys&&isSeq(collection)&&sliceSize>=0&&(sliceSeq.get=function(index,notSetValue){return(index=wrapIndex(this,index))>=0&&index<sliceSize?collection.get(index+resolvedBegin,notSetValue):notSetValue}),sliceSeq.__iterateUncached=function(fn,reverse){var this$1$1=this;if(0===sliceSize)return 0;if(reverse)return this.cacheResult().__iterate(fn,reverse);var skipped=0,isSkipping=!0,iterations=0;return collection.__iterate(function(v,k){if(!isSkipping||!(isSkipping=skipped++<resolvedBegin))return iterations++,!1!==fn(v,useKeys?k:iterations-1,this$1$1)&&iterations!==sliceSize}),iterations},sliceSeq.__iteratorUncached=function(type,reverse){if(0!==sliceSize&&reverse)return this.cacheResult().__iterator(type,reverse);if(0===sliceSize)return new Iterator(iteratorDone);var iterator=collection.__iterator(type,reverse),skipped=0,iterations=0;return new Iterator(function(){for(;skipped++<resolvedBegin;)iterator.next();if(++iterations>sliceSize)return{value:void 0,done:!0};var step=iterator.next();return useKeys||1===type||step.done?step:iteratorValue(type,iterations-1,0===type?void 0:step.value[1],step)})},sliceSeq}function skipWhileFactory(collection,predicate,context,useKeys){var skipSequence=makeSequence(collection);return skipSequence.__iterateUncached=function(fn,reverse){var this$1$1=this;if(reverse)return this.cacheResult().__iterate(fn,reverse);var isSkipping=!0,iterations=0;return collection.__iterate(function(v,k,c){if(!isSkipping||!(isSkipping=predicate.call(context,v,k,c)))return iterations++,fn(v,useKeys?k:iterations-1,this$1$1)}),iterations},skipSequence.__iteratorUncached=function(type,reverse){var this$1$1=this;if(reverse)return this.cacheResult().__iterator(type,reverse);var iterator=collection.__iterator(2,reverse),skipping=!0,iterations=0;return new Iterator(function(){var step,k,v;do{if((step=iterator.next()).done)return useKeys||1===type?step:iteratorValue(type,iterations++,0===type?void 0:step.value[1],step);var entry=step.value;k=entry[0],v=entry[1],skipping&&(skipping=predicate.call(context,v,k,this$1$1))}while(skipping);return 2===type?step:iteratorValue(type,k,v,step)})},skipSequence}ToIndexedSequence.prototype.cacheResult=ToKeyedSequence.prototype.cacheResult=ToSetSequence.prototype.cacheResult=FromEntriesSequence.prototype.cacheResult=cacheResultThrough;var ConcatSeq=function(Seq){function ConcatSeq(iterables){this._wrappedIterables=iterables.flatMap(function(iterable){return iterable._wrappedIterables?iterable._wrappedIterables:[iterable]}),this.size=this._wrappedIterables.reduce(function(sum,iterable){if(void 0!==sum){var size=iterable.size;if(void 0!==size)return sum+size}},0),this["@@__IMMUTABLE_KEYED__@@"]=this._wrappedIterables[0]["@@__IMMUTABLE_KEYED__@@"],this["@@__IMMUTABLE_INDEXED__@@"]=this._wrappedIterables[0]["@@__IMMUTABLE_INDEXED__@@"],this[IS_ORDERED_SYMBOL]=this._wrappedIterables[0][IS_ORDERED_SYMBOL]}return Seq&&(ConcatSeq.__proto__=Seq),ConcatSeq.prototype=Object.create(Seq&&Seq.prototype),ConcatSeq.prototype.constructor=ConcatSeq,ConcatSeq.prototype.__iterateUncached=function(fn,reverse){if(0!==this._wrappedIterables.length){if(reverse)return this.cacheResult().__iterate(fn,reverse);for(var iterableIndex=0,useKeys=isKeyed(this),iteratorType=useKeys?2:1,currentIterator=this._wrappedIterables[iterableIndex].__iterator(iteratorType,reverse),keepGoing=!0,index=0;keepGoing;){for(var next=currentIterator.next();next.done;){if(++iterableIndex===this._wrappedIterables.length)return index;next=(currentIterator=this._wrappedIterables[iterableIndex].__iterator(iteratorType,reverse)).next()}keepGoing=!1!==(useKeys?fn(next.value[1],next.value[0],this):fn(next.value,index,this)),index++}return index}},ConcatSeq.prototype.__iteratorUncached=function(type,reverse){var this$1$1=this;if(0===this._wrappedIterables.length)return new Iterator(iteratorDone);if(reverse)return this.cacheResult().__iterator(type,reverse);var iterableIndex=0,currentIterator=this._wrappedIterables[iterableIndex].__iterator(type,reverse);return new Iterator(function(){for(var next=currentIterator.next();next.done;){if(++iterableIndex===this$1$1._wrappedIterables.length)return next;next=(currentIterator=this$1$1._wrappedIterables[iterableIndex].__iterator(type,reverse)).next()}return next})},ConcatSeq}(Seq);function flattenFactory(collection,depth,useKeys){var flatSequence=makeSequence(collection);return flatSequence.__iterateUncached=function(fn,reverse){if(reverse)return this.cacheResult().__iterate(fn,reverse);var iterations=0,stopped=!1;return function flatDeep(iter,currentDepth){iter.__iterate(function(v,k){return(!depth||currentDepth<depth)&&isCollection(v)?flatDeep(v,currentDepth+1):(iterations++,!1===fn(v,useKeys?k:iterations-1,flatSequence)&&(stopped=!0)),!stopped},reverse)}(collection,0),iterations},flatSequence.__iteratorUncached=function(type,reverse){if(reverse)return this.cacheResult().__iterator(type,reverse);var iterator=collection.__iterator(type,reverse),stack=[],iterations=0;return new Iterator(function(){for(;iterator;){var step=iterator.next();if(!1===step.done){var v=step.value;if(2===type&&(v=v[1]),depth&&!(stack.length<depth)||!isCollection(v))return useKeys?step:iteratorValue(type,iterations++,v,step);stack.push(iterator),iterator=v.__iterator(type,reverse)}else iterator=stack.pop()}return{value:void 0,done:!0}})},flatSequence}function sortFactory(collection,comparator,mapper){comparator||(comparator=defaultComparator);var isKeyedCollection=isKeyed(collection),index=0,entries=collection.toSeq().map(function(v,k){return[k,v,index++,mapper?mapper(v,k,collection):v]}).valueSeq().toArray();return entries.sort(function(a,b){return comparator(a[3],b[3])||a[2]-b[2]}).forEach(isKeyedCollection?function(v,i){entries[i].length=2}:function(v,i){entries[i]=v[1]}),isKeyedCollection?KeyedSeq(entries):isIndexed(collection)?IndexedSeq(entries):SetSeq(entries)}function maxFactory(collection,comparator,mapper){if(comparator||(comparator=defaultComparator),mapper){var entry=collection.toSeq().map(function(v,k){return[v,mapper(v,k,collection)]}).reduce(function(a,b){return maxCompare(comparator,a[1],b[1])?b:a});return entry&&entry[0]}return collection.reduce(function(a,b){return maxCompare(comparator,a,b)?b:a})}function maxCompare(comparator,a,b){var comp=comparator(b,a);return 0===comp&&b!==a&&(null==b||b!=b)||comp>0}function zipWithFactory(keyIter,zipper,iters,zipAll){var zipSequence=makeSequence(keyIter),sizes=new ArraySeq(iters).map(function(i){return i.size});return zipSequence.size=zipAll?sizes.max():sizes.min(),zipSequence.__iterate=function(fn,reverse){for(var step,iterator=this.__iterator(1,reverse),iterations=0;!(step=iterator.next()).done&&!1!==fn(step.value,iterations++,this););return iterations},zipSequence.__iteratorUncached=function(type,reverse){var iterators=iters.map(function(i){return i=Collection(i),getIterator(reverse?i.reverse():i)}),iterations=0,isDone=!1;return new Iterator(function(){var steps;return isDone||(steps=iterators.map(function(i){return i.next()}),isDone=zipAll?steps.every(function(s){return s.done}):steps.some(function(s){return s.done})),isDone?{value:void 0,done:!0}:iteratorValue(type,iterations++,zipper.apply(null,steps.map(function(s){return s.value})))})},zipSequence}function reify(iter,seq){return iter===seq?iter:isSeq(iter)?seq:iter.constructor(seq)}function validateEntry(entry){if(entry!==Object(entry))throw new TypeError("Expected [K, V] tuple: "+entry)}function collectionClass(collection){return isKeyed(collection)?KeyedCollection:isIndexed(collection)?IndexedCollection:SetCollection}function makeSequence(collection){return Object.create((isKeyed(collection)?KeyedSeq:isIndexed(collection)?IndexedSeq:SetSeq).prototype)}function cacheResultThrough(){return this._iter.cacheResult?(this._iter.cacheResult(),this.size=this._iter.size,this):Seq.prototype.cacheResult.call(this)}function defaultComparator(a,b){return void 0===a&&void 0===b?0:void 0===a?1:void 0===b?-1:a>b?1:a<b?-1:0}function isValueObject(maybeValue){return Boolean(maybeValue&&"function"==typeof maybeValue.equals&&"function"==typeof maybeValue.hashCode)}function is(valueA,valueB){if(valueA===valueB||valueA!=valueA&&valueB!=valueB)return!0;if(!valueA||!valueB)return!1;if("function"==typeof valueA.valueOf&&"function"==typeof valueB.valueOf){if((valueA=valueA.valueOf())===(valueB=valueB.valueOf())||valueA!=valueA&&valueB!=valueB)return!0;if(!valueA||!valueB)return!1}return!!(isValueObject(valueA)&&isValueObject(valueB)&&valueA.equals(valueB))}function update$1(collection,key,notSetValue,updater){return updateIn(collection,[key],notSetValue,updater)}function merge$1$1(){for(var iters=[],len=arguments.length;len--;)iters[len]=arguments[len];return mergeIntoKeyedWith(this,iters)}function mergeWith$1(merger){for(var iters=[],len=arguments.length-1;len-- >0;)iters[len]=arguments[len+1];if("function"!=typeof merger)throw new TypeError("Invalid merger function: "+merger);return mergeIntoKeyedWith(this,iters,merger)}function mergeIntoKeyedWith(collection,collections,merger){for(var iters=[],ii=0;ii<collections.length;ii++){var collection$1=KeyedCollection(collections[ii]);0!==collection$1.size&&iters.push(collection$1)}return 0===iters.length?collection:0!==collection.toSeq().size||collection.__ownerID||1!==iters.length?collection.withMutations(function(collection){for(var mergeIntoCollection=merger?function(value,key){update$1(collection,key,NOT_SET,function(oldVal){return oldVal===NOT_SET?value:merger(oldVal,value,key)})}:function(value,key){collection.set(key,value)},ii=0;ii<iters.length;ii++)iters[ii].forEach(mergeIntoCollection)}):isRecord(collection)?collection:collection.constructor(iters[0])}var toString=Object.prototype.toString;function isPlainObject(value){if(!value||"object"!=typeof value||"[object Object]"!==toString.call(value))return!1;var proto=Object.getPrototypeOf(value);if(null===proto)return!0;for(var parentProto=proto,nextProto=Object.getPrototypeOf(proto);null!==nextProto;)parentProto=nextProto,nextProto=Object.getPrototypeOf(parentProto);return parentProto===proto}function isDataStructure(value){return"object"==typeof value&&(isImmutable(value)||Array.isArray(value)||isPlainObject(value))}function arrCopy(arr,offset){offset=offset||0;for(var len=Math.max(0,arr.length-offset),newArr=new Array(len),ii=0;ii<len;ii++)newArr[ii]=arr[ii+offset];return newArr}function shallowCopy(from){if(Array.isArray(from))return arrCopy(from);var to={};for(var key in from)hasOwnProperty.call(from,key)&&(to[key]=from[key]);return to}function mergeDeepWithSources(collection,sources,merger){return mergeWithSources(collection,sources,function(merger){function deepMerger(oldValue,newValue,key){return isDataStructure(oldValue)&&isDataStructure(newValue)&&(newDataStructure=newValue,oldSeq=Seq(oldValue),newSeq=Seq(newDataStructure),isIndexed(oldSeq)===isIndexed(newSeq)&&isKeyed(oldSeq)===isKeyed(newSeq))?mergeWithSources(oldValue,[newValue],deepMerger):merger?merger(oldValue,newValue,key):newValue;var newDataStructure,oldSeq,newSeq}return deepMerger}(merger))}function mergeWithSources(collection,sources,merger){if(!isDataStructure(collection))throw new TypeError("Cannot merge into non-data-structure value: "+collection);if(isImmutable(collection))return"function"==typeof merger&&collection.mergeWith?collection.mergeWith.apply(collection,[merger].concat(sources)):collection.merge?collection.merge.apply(collection,sources):collection.concat.apply(collection,sources);for(var isArray=Array.isArray(collection),merged=collection,Collection=isArray?IndexedCollection:KeyedCollection,mergeItem=isArray?function(value){merged===collection&&(merged=shallowCopy(merged)),merged.push(value)}:function(value,key){var hasVal=hasOwnProperty.call(merged,key),nextVal=hasVal&&merger?merger(merged[key],value,key):value;hasVal&&nextVal===merged[key]||(merged===collection&&(merged=shallowCopy(merged)),merged[key]=nextVal)},i=0;i<sources.length;i++)Collection(sources[i]).forEach(mergeItem);return merged}function mergeDeep(){for(var iters=[],len=arguments.length;len--;)iters[len]=arguments[len];return mergeDeepWithSources(this,iters)}function mergeDeepWith(merger){for(var iters=[],len=arguments.length-1;len-- >0;)iters[len]=arguments[len+1];return mergeDeepWithSources(this,iters,merger)}function mergeDeepIn(keyPath){for(var iters=[],len=arguments.length-1;len-- >0;)iters[len]=arguments[len+1];return updateIn(this,keyPath,emptyMap(),function(m){return mergeDeepWithSources(m,iters)})}function mergeIn(keyPath){for(var iters=[],len=arguments.length-1;len-- >0;)iters[len]=arguments[len+1];return updateIn(this,keyPath,emptyMap(),function(m){return mergeWithSources(m,iters)})}function setIn$1(collection,keyPath,value){return updateIn(collection,keyPath,NOT_SET,function(){return value})}function setIn(keyPath,v){return setIn$1(this,keyPath,v)}function update(key,notSetValue,updater){return 1===arguments.length?key(this):update$1(this,key,notSetValue,updater)}function updateIn$1(keyPath,notSetValue,updater){return updateIn(this,keyPath,notSetValue,updater)}function wasAltered(){return this.__altered}function withMutations(fn){var mutable=this.asMutable();return fn(mutable),mutable.wasAltered()?mutable.__ensureOwner(this.__ownerID):this}function isMap(maybeMap){return Boolean(maybeMap&&maybeMap["@@__IMMUTABLE_MAP__@@"])}function invariant(condition,error){if(!condition)throw new Error(error)}function assertNotInfinite(size){invariant(size!==1/0,"Cannot perform this action with an infinite size.")}var Map$1=function(KeyedCollection){function Map(value){return null==value?emptyMap():isMap(value)&&!isOrdered(value)?value:emptyMap().withMutations(function(map){var iter=KeyedCollection(value);assertNotInfinite(iter.size),iter.forEach(function(v,k){return map.set(k,v)})})}return KeyedCollection&&(Map.__proto__=KeyedCollection),Map.prototype=Object.create(KeyedCollection&&KeyedCollection.prototype),Map.prototype.constructor=Map,Map.prototype.toString=function(){return this.__toString("Map {","}")},Map.prototype.get=function(k,notSetValue){return this._root?this._root.get(0,void 0,k,notSetValue):notSetValue},Map.prototype.set=function(k,v){return updateMap(this,k,v)},Map.prototype.remove=function(k){return updateMap(this,k,NOT_SET)},Map.prototype.deleteAll=function(keys){var collection=Collection(keys);return 0===collection.size?this:this.withMutations(function(map){collection.forEach(function(key){return map.remove(key)})})},Map.prototype.clear=function(){return 0===this.size?this:this.__ownerID?(this.size=0,this._root=null,this.__hash=void 0,this.__altered=!0,this):emptyMap()},Map.prototype.sort=function(comparator){return OrderedMap(sortFactory(this,comparator))},Map.prototype.sortBy=function(mapper,comparator){return OrderedMap(sortFactory(this,comparator,mapper))},Map.prototype.map=function(mapper,context){var this$1$1=this;return this.withMutations(function(map){map.forEach(function(value,key){map.set(key,mapper.call(context,value,key,this$1$1))})})},Map.prototype.__iterator=function(type,reverse){return new MapIterator(this,type,reverse)},Map.prototype.__iterate=function(fn,reverse){var this$1$1=this,iterations=0;return this._root&&this._root.iterate(function(entry){return iterations++,fn(entry[1],entry[0],this$1$1)},reverse),iterations},Map.prototype.__ensureOwner=function(ownerID){return ownerID===this.__ownerID?this:ownerID?makeMap(this.size,this._root,ownerID,this.__hash):0===this.size?emptyMap():(this.__ownerID=ownerID,this.__altered=!1,this)},Map}(KeyedCollection);Map$1.isMap=isMap;var MapPrototype=Map$1.prototype;MapPrototype["@@__IMMUTABLE_MAP__@@"]=!0,MapPrototype.delete=MapPrototype.remove,MapPrototype.removeAll=MapPrototype.deleteAll,MapPrototype.setIn=setIn,MapPrototype.removeIn=MapPrototype.deleteIn=deleteIn,MapPrototype.update=update,MapPrototype.updateIn=updateIn$1,MapPrototype.merge=MapPrototype.concat=merge$1$1,MapPrototype.mergeWith=mergeWith$1,MapPrototype.mergeDeep=mergeDeep,MapPrototype.mergeDeepWith=mergeDeepWith,MapPrototype.mergeIn=mergeIn,MapPrototype.mergeDeepIn=mergeDeepIn,MapPrototype.withMutations=withMutations,MapPrototype.wasAltered=wasAltered,MapPrototype.asImmutable=asImmutable,MapPrototype["@@transducer/init"]=MapPrototype.asMutable=asMutable,MapPrototype["@@transducer/step"]=function(result,arr){return result.set(arr[0],arr[1])},MapPrototype["@@transducer/result"]=function(obj){return obj.asImmutable()};var ArrayMapNode=function(ownerID,entries){this.ownerID=ownerID,this.entries=entries};ArrayMapNode.prototype.get=function(shift,keyHash,key,notSetValue){for(var entries=this.entries,ii=0,len=entries.length;ii<len;ii++)if(is(key,entries[ii][0]))return entries[ii][1];return notSetValue},ArrayMapNode.prototype.update=function(ownerID,shift,keyHash,key,value,didChangeSize,didAlter){for(var removed=value===NOT_SET,entries=this.entries,idx=0,len=entries.length;idx<len&&!is(key,entries[idx][0]);idx++);var exists=idx<len;if(exists?entries[idx][1]===value:removed)return this;if(SetRef(didAlter),(removed||!exists)&&SetRef(didChangeSize),!removed||1!==entries.length){if(!exists&&!removed&&entries.length>=MAX_ARRAY_MAP_SIZE)return function(ownerID,entries,key,value){ownerID||(ownerID=new OwnerID);for(var node=new ValueNode(ownerID,hash(key),[key,value]),ii=0;ii<entries.length;ii++){var entry=entries[ii];node=node.update(ownerID,0,void 0,entry[0],entry[1])}return node}(ownerID,entries,key,value);var isEditable=ownerID&&ownerID===this.ownerID,newEntries=isEditable?entries:arrCopy(entries);return exists?removed?idx===len-1?newEntries.pop():newEntries[idx]=newEntries.pop():newEntries[idx]=[key,value]:newEntries.push([key,value]),isEditable?(this.entries=newEntries,this):new ArrayMapNode(ownerID,newEntries)}};var BitmapIndexedNode=function(ownerID,bitmap,nodes){this.ownerID=ownerID,this.bitmap=bitmap,this.nodes=nodes};BitmapIndexedNode.prototype.get=function(shift,keyHash,key,notSetValue){void 0===keyHash&&(keyHash=hash(key));var bit=1<<(31&(0===shift?keyHash:keyHash>>>shift)),bitmap=this.bitmap;return 0===(bitmap&bit)?notSetValue:this.nodes[popCount(bitmap&bit-1)].get(shift+5,keyHash,key,notSetValue)},BitmapIndexedNode.prototype.update=function(ownerID,shift,keyHash,key,value,didChangeSize,didAlter){void 0===keyHash&&(keyHash=hash(key));var keyHashFrag=31&(0===shift?keyHash:keyHash>>>shift),bit=1<<keyHashFrag,bitmap=this.bitmap,exists=0!==(bitmap&bit);if(!exists&&value===NOT_SET)return this;var idx=popCount(bitmap&bit-1),nodes=this.nodes,node=exists?nodes[idx]:void 0,newNode=updateNode(node,ownerID,shift+5,keyHash,key,value,didChangeSize,didAlter);if(newNode===node)return this;if(!exists&&newNode&&nodes.length>=MAX_BITMAP_INDEXED_SIZE)return function(ownerID,nodes,bitmap,including,node){for(var count=0,expandedNodes=new Array(32),ii=0;0!==bitmap;ii++,bitmap>>>=1)expandedNodes[ii]=1&bitmap?nodes[count++]:void 0;return expandedNodes[including]=node,new HashArrayMapNode(ownerID,count+1,expandedNodes)}(ownerID,nodes,bitmap,keyHashFrag,newNode);if(exists&&!newNode&&2===nodes.length&&isLeafNode(nodes[1^idx]))return nodes[1^idx];if(exists&&newNode&&1===nodes.length&&isLeafNode(newNode))return newNode;var isEditable=ownerID&&ownerID===this.ownerID,newBitmap=exists?newNode?bitmap:bitmap^bit:bitmap|bit,newNodes=exists?newNode?setAt(nodes,idx,newNode,isEditable):function(array,idx,canEdit){var newLen=array.length-1;if(canEdit&&idx===newLen)return array.pop(),array;for(var newArray=new Array(newLen),after=0,ii=0;ii<newLen;ii++)ii===idx&&(after=1),newArray[ii]=array[ii+after];return newArray}(nodes,idx,isEditable):function(array,idx,val,canEdit){var newLen=array.length+1;if(canEdit&&idx+1===newLen)return array[idx]=val,array;for(var newArray=new Array(newLen),after=0,ii=0;ii<newLen;ii++)ii===idx?(newArray[ii]=val,after=-1):newArray[ii]=array[ii+after];return newArray}(nodes,idx,newNode,isEditable);return isEditable?(this.bitmap=newBitmap,this.nodes=newNodes,this):new BitmapIndexedNode(ownerID,newBitmap,newNodes)};var HashArrayMapNode=function(ownerID,count,nodes){this.ownerID=ownerID,this.count=count,this.nodes=nodes};HashArrayMapNode.prototype.get=function(shift,keyHash,key,notSetValue){void 0===keyHash&&(keyHash=hash(key));var idx=31&(0===shift?keyHash:keyHash>>>shift),node=this.nodes[idx];return node?node.get(shift+5,keyHash,key,notSetValue):notSetValue},HashArrayMapNode.prototype.update=function(ownerID,shift,keyHash,key,value,didChangeSize,didAlter){void 0===keyHash&&(keyHash=hash(key));var idx=31&(0===shift?keyHash:keyHash>>>shift),removed=value===NOT_SET,nodes=this.nodes,node=nodes[idx];if(removed&&!node)return this;var newNode=updateNode(node,ownerID,shift+5,keyHash,key,value,didChangeSize,didAlter);if(newNode===node)return this;var newCount=this.count;if(node){if(!newNode&&--newCount<MIN_HASH_ARRAY_MAP_SIZE)return function(ownerID,nodes,count,excluding){for(var bitmap=0,packedII=0,packedNodes=new Array(count),ii=0,bit=1,len=nodes.length;ii<len;ii++,bit<<=1){var node=nodes[ii];void 0!==node&&ii!==excluding&&(bitmap|=bit,packedNodes[packedII++]=node)}return new BitmapIndexedNode(ownerID,bitmap,packedNodes)}(ownerID,nodes,newCount,idx)}else newCount++;var isEditable=ownerID&&ownerID===this.ownerID,newNodes=setAt(nodes,idx,newNode,isEditable);return isEditable?(this.count=newCount,this.nodes=newNodes,this):new HashArrayMapNode(ownerID,newCount,newNodes)};var HashCollisionNode=function(ownerID,keyHash,entries){this.ownerID=ownerID,this.keyHash=keyHash,this.entries=entries};HashCollisionNode.prototype.get=function(shift,keyHash,key,notSetValue){for(var entries=this.entries,ii=0,len=entries.length;ii<len;ii++)if(is(key,entries[ii][0]))return entries[ii][1];return notSetValue},HashCollisionNode.prototype.update=function(ownerID,shift,keyHash,key,value,didChangeSize,didAlter){void 0===keyHash&&(keyHash=hash(key));var removed=value===NOT_SET;if(keyHash!==this.keyHash)return removed?this:(SetRef(didAlter),SetRef(didChangeSize),mergeIntoNode(this,ownerID,shift,keyHash,[key,value]));for(var entries=this.entries,idx=0,len=entries.length;idx<len&&!is(key,entries[idx][0]);idx++);var exists=idx<len;if(exists?entries[idx][1]===value:removed)return this;if(SetRef(didAlter),(removed||!exists)&&SetRef(didChangeSize),removed&&2===len)return new ValueNode(ownerID,this.keyHash,entries[1^idx]);var isEditable=ownerID&&ownerID===this.ownerID,newEntries=isEditable?entries:arrCopy(entries);return exists?removed?idx===len-1?newEntries.pop():newEntries[idx]=newEntries.pop():newEntries[idx]=[key,value]:newEntries.push([key,value]),isEditable?(this.entries=newEntries,this):new HashCollisionNode(ownerID,this.keyHash,newEntries)};var ValueNode=function(ownerID,keyHash,entry){this.ownerID=ownerID,this.keyHash=keyHash,this.entry=entry};ValueNode.prototype.get=function(shift,keyHash,key,notSetValue){return is(key,this.entry[0])?this.entry[1]:notSetValue},ValueNode.prototype.update=function(ownerID,shift,keyHash,key,value,didChangeSize,didAlter){var removed=value===NOT_SET,keyMatch=is(key,this.entry[0]);return(keyMatch?value===this.entry[1]:removed)?this:(SetRef(didAlter),removed?void SetRef(didChangeSize):keyMatch?ownerID&&ownerID===this.ownerID?(this.entry[1]=value,this):new ValueNode(ownerID,this.keyHash,[key,value]):(SetRef(didChangeSize),mergeIntoNode(this,ownerID,shift,hash(key),[key,value])))},ArrayMapNode.prototype.iterate=HashCollisionNode.prototype.iterate=function(fn,reverse){for(var entries=this.entries,ii=0,maxIndex=entries.length-1;ii<=maxIndex;ii++)if(!1===fn(entries[reverse?maxIndex-ii:ii]))return!1},BitmapIndexedNode.prototype.iterate=HashArrayMapNode.prototype.iterate=function(fn,reverse){for(var nodes=this.nodes,ii=0,maxIndex=nodes.length-1;ii<=maxIndex;ii++){var node=nodes[reverse?maxIndex-ii:ii];if(node&&!1===node.iterate(fn,reverse))return!1}},ValueNode.prototype.iterate=function(fn,reverse){return fn(this.entry)};var EMPTY_MAP,MapIterator=function(Iterator){function MapIterator(map,type,reverse){this._type=type,this._reverse=reverse,this._stack=map._root&&mapIteratorFrame(map._root)}return Iterator&&(MapIterator.__proto__=Iterator),MapIterator.prototype=Object.create(Iterator&&Iterator.prototype),MapIterator.prototype.constructor=MapIterator,MapIterator.prototype.next=function(){for(var type=this._type,stack=this._stack;stack;){var node=stack.node,index=stack.index++,maxIndex=void 0;if(node.entry){if(0===index)return mapIteratorValue(type,node.entry)}else if(node.entries){if(index<=(maxIndex=node.entries.length-1))return mapIteratorValue(type,node.entries[this._reverse?maxIndex-index:index])}else if(index<=(maxIndex=node.nodes.length-1)){var subNode=node.nodes[this._reverse?maxIndex-index:index];if(subNode){if(subNode.entry)return mapIteratorValue(type,subNode.entry);stack=this._stack=mapIteratorFrame(subNode,stack)}continue}stack=this._stack=this._stack.__prev}return{value:void 0,done:!0}},MapIterator}(Iterator);function mapIteratorValue(type,entry){return iteratorValue(type,entry[0],entry[1])}function mapIteratorFrame(node,prev){return{node:node,index:0,__prev:prev}}function makeMap(size,root,ownerID,hash){var map=Object.create(MapPrototype);return map.size=size,map._root=root,map.__ownerID=ownerID,map.__hash=hash,map.__altered=!1,map}function emptyMap(){return EMPTY_MAP||(EMPTY_MAP=makeMap(0))}function updateMap(map,k,v){var newRoot,newSize;if(map._root){var didChangeSize={value:!1},didAlter={value:!1};if(newRoot=updateNode(map._root,map.__ownerID,0,void 0,k,v,didChangeSize,didAlter),!didAlter.value)return map;newSize=map.size+(didChangeSize.value?v===NOT_SET?-1:1:0)}else{if(v===NOT_SET)return map;newSize=1,newRoot=new ArrayMapNode(map.__ownerID,[[k,v]])}return map.__ownerID?(map.size=newSize,map._root=newRoot,map.__hash=void 0,map.__altered=!0,map):newRoot?makeMap(newSize,newRoot):emptyMap()}function updateNode(node,ownerID,shift,keyHash,key,value,didChangeSize,didAlter){return node?node.update(ownerID,shift,keyHash,key,value,didChangeSize,didAlter):value===NOT_SET?node:(SetRef(didAlter),SetRef(didChangeSize),new ValueNode(ownerID,keyHash,[key,value]))}function isLeafNode(node){return node.constructor===ValueNode||node.constructor===HashCollisionNode}function mergeIntoNode(node,ownerID,shift,keyHash,entry){if(node.keyHash===keyHash)return new HashCollisionNode(ownerID,keyHash,[node.entry,entry]);var newNode,idx1=31&(0===shift?node.keyHash:node.keyHash>>>shift),idx2=31&(0===shift?keyHash:keyHash>>>shift),nodes=idx1===idx2?[mergeIntoNode(node,ownerID,shift+5,keyHash,entry)]:(newNode=new ValueNode(ownerID,keyHash,entry),idx1<idx2?[node,newNode]:[newNode,node]);return new BitmapIndexedNode(ownerID,1<<idx1|1<<idx2,nodes)}function popCount(x){return x=(x=(858993459&(x-=x>>1&1431655765))+(x>>2&858993459))+(x>>4)&252645135,x+=x>>8,127&(x+=x>>16)}function setAt(array,idx,val,canEdit){var newArray=canEdit?array:arrCopy(array);return newArray[idx]=val,newArray}var MAX_ARRAY_MAP_SIZE=8,MAX_BITMAP_INDEXED_SIZE=16,MIN_HASH_ARRAY_MAP_SIZE=8;function coerceKeyPath(keyPath){if(isArrayLike(keyPath)&&"string"!=typeof keyPath)return keyPath;if(isOrdered(keyPath))return keyPath.toArray();throw new TypeError("Invalid keyPath: expected Ordered Collection or Array: "+keyPath)}function quoteString(value){try{return"string"==typeof value?JSON.stringify(value):String(value)}catch(_ignoreError){return JSON.stringify(value)}}function has$5(collection,key){return isImmutable(collection)?collection.has(key):isDataStructure(collection)&&hasOwnProperty.call(collection,key)}function get$5(collection,key,notSetValue){return isImmutable(collection)?collection.get(key,notSetValue):has$5(collection,key)?"function"==typeof collection.get?collection.get(key):collection[key]:notSetValue}function remove$4(collection,key){if(!isDataStructure(collection))throw new TypeError("Cannot update non-data-structure value: "+collection);if(isImmutable(collection)){if(!collection.remove)throw new TypeError("Cannot update immutable value without .remove() method: "+collection);return collection.remove(key)}if(!hasOwnProperty.call(collection,key))return collection;var collectionCopy=shallowCopy(collection);return Array.isArray(collectionCopy)?collectionCopy.splice(key,1):delete collectionCopy[key],collectionCopy}function set$4(collection,key,value){if(!isDataStructure(collection))throw new TypeError("Cannot update non-data-structure value: "+collection);if(isImmutable(collection)){if(!collection.set)throw new TypeError("Cannot update immutable value without .set() method: "+collection);return collection.set(key,value)}if(hasOwnProperty.call(collection,key)&&value===collection[key])return collection;var collectionCopy=shallowCopy(collection);return collectionCopy[key]=value,collectionCopy}function updateIn(collection,keyPath,notSetValue,updater){updater||(updater=notSetValue,notSetValue=void 0);var updatedValue=updateInDeeply(isImmutable(collection),collection,coerceKeyPath(keyPath),0,notSetValue,updater);return updatedValue===NOT_SET?notSetValue:updatedValue}function updateInDeeply(inImmutable,existing,keyPath,i,notSetValue,updater){var wasNotSet=existing===NOT_SET;if(i===keyPath.length){var existingValue=wasNotSet?notSetValue:existing,newValue=updater(existingValue);return newValue===existingValue?existing:newValue}if(!wasNotSet&&!isDataStructure(existing))throw new TypeError("Cannot update within non-data-structure value in path ["+Array.from(keyPath).slice(0,i).map(quoteString)+"]: "+existing);var key=keyPath[i],nextExisting=wasNotSet?NOT_SET:get$5(existing,key,NOT_SET),nextUpdated=updateInDeeply(nextExisting===NOT_SET?inImmutable:isImmutable(nextExisting),nextExisting,keyPath,i+1,notSetValue,updater);return nextUpdated===nextExisting?existing:nextUpdated===NOT_SET?remove$4(existing,key):set$4(wasNotSet?inImmutable?emptyMap():{}:existing,key,nextUpdated)}function removeIn(collection,keyPath){return updateIn(collection,keyPath,function(){return NOT_SET})}function deleteIn(keyPath){return removeIn(this,keyPath)}function isList(maybeList){return Boolean(maybeList&&maybeList["@@__IMMUTABLE_LIST__@@"])}var List$1=function(IndexedCollection){function List(value){var empty=emptyList();if(null==value)return empty;if(isList(value))return value;var iter=IndexedCollection(value),size=iter.size;return 0===size?empty:(assertNotInfinite(size),size>0&&size<32?makeList(0,size,5,null,new VNode(iter.toArray())):empty.withMutations(function(list){list.setSize(size),iter.forEach(function(v,i){return list.set(i,v)})}))}return IndexedCollection&&(List.__proto__=IndexedCollection),List.prototype=Object.create(IndexedCollection&&IndexedCollection.prototype),List.prototype.constructor=List,List.of=function(){return this(arguments)},List.prototype.toString=function(){return this.__toString("List [","]")},List.prototype.get=function(index,notSetValue){if((index=wrapIndex(this,index))>=0&&index<this.size){var node=listNodeFor(this,index+=this._origin);return node&&node.array[31&index]}return notSetValue},List.prototype.set=function(index,value){return function(list,index,value){if(index=wrapIndex(list,index),index!=index)return list;if(index>=list.size||index<0)return list.withMutations(function(list){index<0?setListBounds(list,index).set(0,value):setListBounds(list,0,index+1).set(index,value)});index+=list._origin;var newTail=list._tail,newRoot=list._root,didAlter={value:!1};index>=getTailOffset(list._capacity)?newTail=updateVNode(newTail,list.__ownerID,0,index,value,didAlter):newRoot=updateVNode(newRoot,list.__ownerID,list._level,index,value,didAlter);if(!didAlter.value)return list;if(list.__ownerID)return list._root=newRoot,list._tail=newTail,list.__hash=void 0,list.__altered=!0,list;return makeList(list._origin,list._capacity,list._level,newRoot,newTail)}(this,index,value)},List.prototype.remove=function(index){return this.has(index)?0===index?this.shift():index===this.size-1?this.pop():this.splice(index,1):this},List.prototype.insert=function(index,value){return this.splice(index,0,value)},List.prototype.clear=function(){return 0===this.size?this:this.__ownerID?(this.size=this._origin=this._capacity=0,this._level=5,this._root=this._tail=this.__hash=void 0,this.__altered=!0,this):emptyList()},List.prototype.push=function(){var values=arguments,oldSize=this.size;return this.withMutations(function(list){setListBounds(list,0,oldSize+values.length);for(var ii=0;ii<values.length;ii++)list.set(oldSize+ii,values[ii])})},List.prototype.pop=function(){return setListBounds(this,0,-1)},List.prototype.unshift=function(){var values=arguments;return this.withMutations(function(list){setListBounds(list,-values.length);for(var ii=0;ii<values.length;ii++)list.set(ii,values[ii])})},List.prototype.shift=function(){return setListBounds(this,1)},List.prototype.shuffle=function(random){return void 0===random&&(random=Math.random),this.withMutations(function(mutable){for(var destination,tmp,current=mutable.size;current;)destination=Math.floor(random()*current--),tmp=mutable.get(destination),mutable.set(destination,mutable.get(current)),mutable.set(current,tmp)})},List.prototype.concat=function(){for(var arguments$1=arguments,seqs=[],i=0;i<arguments.length;i++){var argument=arguments$1[i],seq=IndexedCollection("string"!=typeof argument&&hasIterator(argument)?argument:[argument]);0!==seq.size&&seqs.push(seq)}return 0===seqs.length?this:0!==this.size||this.__ownerID||1!==seqs.length?this.withMutations(function(list){seqs.forEach(function(seq){return seq.forEach(function(value){return list.push(value)})})}):this.constructor(seqs[0])},List.prototype.setSize=function(size){return setListBounds(this,0,size)},List.prototype.map=function(mapper,context){var this$1$1=this;return this.withMutations(function(list){for(var i=0;i<this$1$1.size;i++)list.set(i,mapper.call(context,list.get(i),i,this$1$1))})},List.prototype.slice=function(begin,end){var size=this.size;return wholeSlice(begin,end,size)?this:setListBounds(this,resolveBegin(begin,size),resolveEnd(end,size))},List.prototype.__iterator=function(type,reverse){var index=reverse?this.size:0,values=iterateList(this,reverse);return new Iterator(function(){var value=values();return value===DONE?{value:void 0,done:!0}:iteratorValue(type,reverse?--index:index++,value)})},List.prototype.__iterate=function(fn,reverse){for(var value,index=reverse?this.size:0,values=iterateList(this,reverse);(value=values())!==DONE&&!1!==fn(value,reverse?--index:index++,this););return index},List.prototype.__ensureOwner=function(ownerID){return ownerID===this.__ownerID?this:ownerID?makeList(this._origin,this._capacity,this._level,this._root,this._tail,ownerID,this.__hash):0===this.size?emptyList():(this.__ownerID=ownerID,this.__altered=!1,this)},List}(IndexedCollection);List$1.isList=isList;var ListPrototype=List$1.prototype;ListPrototype["@@__IMMUTABLE_LIST__@@"]=!0,ListPrototype.delete=ListPrototype.remove,ListPrototype.merge=ListPrototype.concat,ListPrototype.setIn=setIn,ListPrototype.deleteIn=ListPrototype.removeIn=deleteIn,ListPrototype.update=update,ListPrototype.updateIn=updateIn$1,ListPrototype.mergeIn=mergeIn,ListPrototype.mergeDeepIn=mergeDeepIn,ListPrototype.withMutations=withMutations,ListPrototype.wasAltered=wasAltered,ListPrototype.asImmutable=asImmutable,ListPrototype["@@transducer/init"]=ListPrototype.asMutable=asMutable,ListPrototype["@@transducer/step"]=function(result,arr){return result.push(arr)},ListPrototype["@@transducer/result"]=function(obj){return obj.asImmutable()};var VNode=function(array,ownerID){this.array=array,this.ownerID=ownerID};VNode.prototype.removeBefore=function(ownerID,level,index){if(!(index&(1<<level+5)-1)||0===this.array.length)return this;var originIndex=index>>>level&31;if(originIndex>=this.array.length)return new VNode([],ownerID);var newChild,removingFirst=0===originIndex;if(level>0){var oldChild=this.array[originIndex];if((newChild=oldChild&&oldChild.removeBefore(ownerID,level-5,index))===oldChild&&removingFirst)return this}if(removingFirst&&!newChild)return this;var editable=editableVNode(this,ownerID);if(!removingFirst)for(var ii=0;ii<originIndex;ii++)editable.array[ii]=void 0;return newChild&&(editable.array[originIndex]=newChild),editable},VNode.prototype.removeAfter=function(ownerID,level,index){if(index===(level?1<<level+5:32)||0===this.array.length)return this;var newChild,sizeIndex=index-1>>>level&31;if(sizeIndex>=this.array.length)return this;if(level>0){var oldChild=this.array[sizeIndex];if((newChild=oldChild&&oldChild.removeAfter(ownerID,level-5,index))===oldChild&&sizeIndex===this.array.length-1)return this}var editable=editableVNode(this,ownerID);return editable.array.splice(sizeIndex+1),newChild&&(editable.array[sizeIndex]=newChild),editable};var DONE={};function iterateList(list,reverse){var left=list._origin,right=list._capacity,tailPos=getTailOffset(right),tail=list._tail;return iterateNodeOrLeaf(list._root,list._level,0);function iterateNodeOrLeaf(node,level,offset){return 0===level?function(node,offset){var array=offset===tailPos?tail&&tail.array:node&&node.array,from=offset>left?0:left-offset,to=right-offset;to>32&&(to=32);return function(){if(from===to)return DONE;var idx=reverse?--to:from++;return array&&array[idx]}}(node,offset):function(node,level,offset){var values,array=node&&node.array,from=offset>left?0:left-offset>>level,to=1+(right-offset>>level);to>32&&(to=32);return function(){for(;;){if(values){var value=values();if(value!==DONE)return value;values=null}if(from===to)return DONE;var idx=reverse?--to:from++;values=iterateNodeOrLeaf(array&&array[idx],level-5,offset+(idx<<level))}}}(node,level,offset)}}function makeList(origin,capacity,level,root,tail,ownerID,hash){var list=Object.create(ListPrototype);return list.size=capacity-origin,list._origin=origin,list._capacity=capacity,list._level=level,list._root=root,list._tail=tail,list.__ownerID=ownerID,list.__hash=hash,list.__altered=!1,list}function emptyList(){return makeList(0,0,5)}function updateVNode(node,ownerID,level,index,value,didAlter){var newNode,idx=index>>>level&31,nodeHas=node&&idx<node.array.length;if(!nodeHas&&void 0===value)return node;if(level>0){var lowerNode=node&&node.array[idx],newLowerNode=updateVNode(lowerNode,ownerID,level-5,index,value,didAlter);return newLowerNode===lowerNode?node:((newNode=editableVNode(node,ownerID)).array[idx]=newLowerNode,newNode)}return nodeHas&&node.array[idx]===value?node:(didAlter&&SetRef(didAlter),newNode=editableVNode(node,ownerID),void 0===value&&idx===newNode.array.length-1?newNode.array.pop():newNode.array[idx]=value,newNode)}function editableVNode(node,ownerID){return ownerID&&node&&ownerID===node.ownerID?node:new VNode(node?node.array.slice():[],ownerID)}function listNodeFor(list,rawIndex){if(rawIndex>=getTailOffset(list._capacity))return list._tail;if(rawIndex<1<<list._level+5){for(var node=list._root,level=list._level;node&&level>0;)node=node.array[rawIndex>>>level&31],level-=5;return node}}function setListBounds(list,begin,end){void 0!==begin&&(begin|=0),void 0!==end&&(end|=0);var owner=list.__ownerID||new OwnerID,oldOrigin=list._origin,oldCapacity=list._capacity,newOrigin=oldOrigin+begin,newCapacity=void 0===end?oldCapacity:end<0?oldCapacity+end:oldOrigin+end;if(newOrigin===oldOrigin&&newCapacity===oldCapacity)return list;if(newOrigin>=newCapacity)return list.clear();for(var newLevel=list._level,newRoot=list._root,offsetShift=0;newOrigin+offsetShift<0;)newRoot=new VNode(newRoot&&newRoot.array.length?[void 0,newRoot]:[],owner),offsetShift+=1<<(newLevel+=5);offsetShift&&(newOrigin+=offsetShift,oldOrigin+=offsetShift,newCapacity+=offsetShift,oldCapacity+=offsetShift);for(var oldTailOffset=getTailOffset(oldCapacity),newTailOffset=getTailOffset(newCapacity);newTailOffset>=1<<newLevel+5;)newRoot=new VNode(newRoot&&newRoot.array.length?[newRoot]:[],owner),newLevel+=5;var oldTail=list._tail,newTail=newTailOffset<oldTailOffset?listNodeFor(list,newCapacity-1):newTailOffset>oldTailOffset?new VNode([],owner):oldTail;if(oldTail&&newTailOffset>oldTailOffset&&newOrigin<oldCapacity&&oldTail.array.length){for(var node=newRoot=editableVNode(newRoot,owner),level=newLevel;level>5;level-=5){var idx=oldTailOffset>>>level&31;node=node.array[idx]=editableVNode(node.array[idx],owner)}node.array[oldTailOffset>>>5&31]=oldTail}if(newCapacity<oldCapacity&&(newTail=newTail&&newTail.removeAfter(owner,0,newCapacity)),newOrigin>=newTailOffset)newOrigin-=newTailOffset,newCapacity-=newTailOffset,newLevel=5,newRoot=null,newTail=newTail&&newTail.removeBefore(owner,0,newOrigin);else if(newOrigin>oldOrigin||newTailOffset<oldTailOffset){for(offsetShift=0;newRoot;){var beginIndex=newOrigin>>>newLevel&31;if(beginIndex!==newTailOffset>>>newLevel&31)break;beginIndex&&(offsetShift+=(1<<newLevel)*beginIndex),newLevel-=5,newRoot=newRoot.array[beginIndex]}newRoot&&newOrigin>oldOrigin&&(newRoot=newRoot.removeBefore(owner,newLevel,newOrigin-offsetShift)),newRoot&&newTailOffset<oldTailOffset&&(newRoot=newRoot.removeAfter(owner,newLevel,newTailOffset-offsetShift)),offsetShift&&(newOrigin-=offsetShift,newCapacity-=offsetShift)}return list.__ownerID?(list.size=newCapacity-newOrigin,list._origin=newOrigin,list._capacity=newCapacity,list._level=newLevel,list._root=newRoot,list._tail=newTail,list.__hash=void 0,list.__altered=!0,list):makeList(newOrigin,newCapacity,newLevel,newRoot,newTail)}function getTailOffset(size){return size<32?0:size-1>>>5<<5}function isOrderedMap(maybeOrderedMap){return isMap(maybeOrderedMap)&&isOrdered(maybeOrderedMap)}var EMPTY_ORDERED_MAP,OrderedMap=function(Map){function OrderedMap(value){return null==value?emptyOrderedMap():isOrderedMap(value)?value:emptyOrderedMap().withMutations(function(map){var iter=KeyedCollection(value);assertNotInfinite(iter.size),iter.forEach(function(v,k){return map.set(k,v)})})}return Map&&(OrderedMap.__proto__=Map),OrderedMap.prototype=Object.create(Map&&Map.prototype),OrderedMap.prototype.constructor=OrderedMap,OrderedMap.of=function(){return this(arguments)},OrderedMap.prototype.toString=function(){return this.__toString("OrderedMap {","}")},OrderedMap.prototype.get=function(k,notSetValue){var index=this._map.get(k);return void 0!==index?this._list.get(index)[1]:notSetValue},OrderedMap.prototype.clear=function(){return 0===this.size?this:this.__ownerID?(this.size=0,this._map.clear(),this._list.clear(),this.__altered=!0,this):emptyOrderedMap()},OrderedMap.prototype.set=function(k,v){return updateOrderedMap(this,k,v)},OrderedMap.prototype.remove=function(k){return updateOrderedMap(this,k,NOT_SET)},OrderedMap.prototype.__iterate=function(fn,reverse){var this$1$1=this;return this._list.__iterate(function(entry){return entry&&fn(entry[1],entry[0],this$1$1)},reverse)},OrderedMap.prototype.__iterator=function(type,reverse){return this._list.fromEntrySeq().__iterator(type,reverse)},OrderedMap.prototype.__ensureOwner=function(ownerID){if(ownerID===this.__ownerID)return this;var newMap=this._map.__ensureOwner(ownerID),newList=this._list.__ensureOwner(ownerID);return ownerID?makeOrderedMap(newMap,newList,ownerID,this.__hash):0===this.size?emptyOrderedMap():(this.__ownerID=ownerID,this.__altered=!1,this._map=newMap,this._list=newList,this)},OrderedMap}(Map$1);function makeOrderedMap(map,list,ownerID,hash){var omap=Object.create(OrderedMap.prototype);return omap.size=map?map.size:0,omap._map=map,omap._list=list,omap.__ownerID=ownerID,omap.__hash=hash,omap.__altered=!1,omap}function emptyOrderedMap(){return EMPTY_ORDERED_MAP||(EMPTY_ORDERED_MAP=makeOrderedMap(emptyMap(),emptyList()))}function updateOrderedMap(omap,k,v){var newMap,newList,map=omap._map,list=omap._list,i=map.get(k),has=void 0!==i;if(v===NOT_SET){if(!has)return omap;list.size>=32&&list.size>=2*map.size?(newMap=(newList=list.filter(function(entry,idx){return void 0!==entry&&i!==idx})).toKeyedSeq().map(function(entry){return entry[0]}).flip().toMap(),omap.__ownerID&&(newMap.__ownerID=newList.__ownerID=omap.__ownerID)):(newMap=map.remove(k),newList=i===list.size-1?list.pop():list.set(i,void 0))}else if(has){if(v===list.get(i)[1])return omap;newMap=map,newList=list.set(i,[k,v])}else newMap=map.set(k,list.size),newList=list.set(list.size,[k,v]);return omap.__ownerID?(omap.size=newMap.size,omap._map=newMap,omap._list=newList,omap.__hash=void 0,omap.__altered=!0,omap):makeOrderedMap(newMap,newList)}OrderedMap.isOrderedMap=isOrderedMap,OrderedMap.prototype[IS_ORDERED_SYMBOL]=!0,OrderedMap.prototype.delete=OrderedMap.prototype.remove;function isStack(maybeStack){return Boolean(maybeStack&&maybeStack["@@__IMMUTABLE_STACK__@@"])}var Stack=function(IndexedCollection){function Stack(value){return null==value?emptyStack():isStack(value)?value:emptyStack().pushAll(value)}return IndexedCollection&&(Stack.__proto__=IndexedCollection),Stack.prototype=Object.create(IndexedCollection&&IndexedCollection.prototype),Stack.prototype.constructor=Stack,Stack.of=function(){return this(arguments)},Stack.prototype.toString=function(){return this.__toString("Stack [","]")},Stack.prototype.get=function(index,notSetValue){var head=this._head;for(index=wrapIndex(this,index);head&&index--;)head=head.next;return head?head.value:notSetValue},Stack.prototype.peek=function(){return this._head&&this._head.value},Stack.prototype.push=function(){var arguments$1=arguments;if(0===arguments.length)return this;for(var newSize=this.size+arguments.length,head=this._head,ii=arguments.length-1;ii>=0;ii--)head={value:arguments$1[ii],next:head};return this.__ownerID?(this.size=newSize,this._head=head,this.__hash=void 0,this.__altered=!0,this):makeStack(newSize,head)},Stack.prototype.pushAll=function(iter){if(0===(iter=IndexedCollection(iter)).size)return this;if(0===this.size&&isStack(iter))return iter;assertNotInfinite(iter.size);var newSize=this.size,head=this._head;return iter.__iterate(function(value){newSize++,head={value:value,next:head}},!0),this.__ownerID?(this.size=newSize,this._head=head,this.__hash=void 0,this.__altered=!0,this):makeStack(newSize,head)},Stack.prototype.pop=function(){return this.slice(1)},Stack.prototype.clear=function(){return 0===this.size?this:this.__ownerID?(this.size=0,this._head=void 0,this.__hash=void 0,this.__altered=!0,this):emptyStack()},Stack.prototype.slice=function(begin,end){if(wholeSlice(begin,end,this.size))return this;var resolvedBegin=resolveBegin(begin,this.size);if(resolveEnd(end,this.size)!==this.size)return IndexedCollection.prototype.slice.call(this,begin,end);for(var newSize=this.size-resolvedBegin,head=this._head;resolvedBegin--;)head=head.next;return this.__ownerID?(this.size=newSize,this._head=head,this.__hash=void 0,this.__altered=!0,this):makeStack(newSize,head)},Stack.prototype.__ensureOwner=function(ownerID){return ownerID===this.__ownerID?this:ownerID?makeStack(this.size,this._head,ownerID,this.__hash):0===this.size?emptyStack():(this.__ownerID=ownerID,this.__altered=!1,this)},Stack.prototype.__iterate=function(fn,reverse){var this$1$1=this;if(reverse)return new ArraySeq(this.toArray()).__iterate(function(v,k){return fn(v,k,this$1$1)},reverse);for(var iterations=0,node=this._head;node&&!1!==fn(node.value,iterations++,this);)node=node.next;return iterations},Stack.prototype.__iterator=function(type,reverse){if(reverse)return new ArraySeq(this.toArray()).__iterator(type,reverse);var iterations=0,node=this._head;return new Iterator(function(){if(node){var value=node.value;return node=node.next,iteratorValue(type,iterations++,value)}return{value:void 0,done:!0}})},Stack}(IndexedCollection);Stack.isStack=isStack;var EMPTY_STACK,StackPrototype=Stack.prototype;function makeStack(size,head,ownerID,hash){var map=Object.create(StackPrototype);return map.size=size,map._head=head,map.__ownerID=ownerID,map.__hash=hash,map.__altered=!1,map}function emptyStack(){return EMPTY_STACK||(EMPTY_STACK=makeStack(0))}function reduce(collection,reducer,reduction,context,useFirst,reverse){return assertNotInfinite(collection.size),collection.__iterate(function(v,k,c){useFirst?(useFirst=!1,reduction=v):reduction=reducer.call(context,reduction,v,k,c)},reverse),reduction}function keyMapper(v,k){return k}function entryMapper(v,k){return[k,v]}function not(predicate){return function(){for(var args=[],len=arguments.length;len--;)args[len]=arguments[len];return!predicate.apply(this,args)}}function neg(predicate){return function(){for(var args=[],len=arguments.length;len--;)args[len]=arguments[len];return-predicate.apply(this,args)}}function defaultNegComparator(a,b){return a<b?1:a>b?-1:0}StackPrototype["@@__IMMUTABLE_STACK__@@"]=!0,StackPrototype.shift=StackPrototype.pop,StackPrototype.unshift=StackPrototype.push,StackPrototype.unshiftAll=StackPrototype.pushAll,StackPrototype.withMutations=withMutations,StackPrototype.wasAltered=wasAltered,StackPrototype.asImmutable=asImmutable,StackPrototype["@@transducer/init"]=StackPrototype.asMutable=asMutable,StackPrototype["@@transducer/step"]=function(result,arr){return result.unshift(arr)},StackPrototype["@@transducer/result"]=function(obj){return obj.asImmutable()};function isSet(maybeSet){return Boolean(maybeSet&&maybeSet["@@__IMMUTABLE_SET__@@"])}function deepEqual(a,b){if(a===b)return!0;if(!isCollection(b)||void 0!==a.size&&void 0!==b.size&&a.size!==b.size||void 0!==a.__hash&&void 0!==b.__hash&&a.__hash!==b.__hash||isKeyed(a)!==isKeyed(b)||isIndexed(a)!==isIndexed(b)||isOrdered(a)!==isOrdered(b))return!1;if(0===a.size&&0===b.size)return!0;var notAssociative=!isAssociative(a);if(isOrdered(a)&&!isMap(a)&&!isSet(a)){var entries=a.entries();return b.every(function(v,k){var entry=entries.next().value;return entry&&is(entry[1],v)&&(notAssociative||is(entry[0],k))})&&entries.next().done}var flipped=!1;if(void 0===a.size)if(void 0===b.size)isOrdered(a)||"function"!=typeof a.cacheResult||a.cacheResult();else{flipped=!0;var _=a;a=b,b=_}var allEqual=!0,bSize=b.__iterate(function(v,k){if(notAssociative?!a.has(v):flipped?!is(v,a.get(k,NOT_SET)):!is(a.get(k,NOT_SET),v))return allEqual=!1,!1});return allEqual&&a.size===bSize}var EMPTY_RANGE,Range=function(IndexedSeq){function Range(start,end,step){if(void 0===step&&(step=1),!(this instanceof Range))return new Range(start,end,step);if(invariant(0!==step,"Cannot step a Range by 0"),invariant(void 0!==start,"You must define a start value when using Range"),invariant(void 0!==end,"You must define an end value when using Range"),step=Math.abs(step),end<start&&(step=-step),this._start=start,this._end=end,this._step=step,this.size=Math.max(0,Math.ceil((end-start)/step-1)+1),0===this.size){if(EMPTY_RANGE)return EMPTY_RANGE;EMPTY_RANGE=this}}return IndexedSeq&&(Range.__proto__=IndexedSeq),Range.prototype=Object.create(IndexedSeq&&IndexedSeq.prototype),Range.prototype.constructor=Range,Range.prototype.toString=function(){return 0===this.size?"Range []":"Range [ "+this._start+"..."+this._end+(1!==this._step?" by "+this._step:"")+" ]"},Range.prototype.get=function(index,notSetValue){return this.has(index)?this._start+wrapIndex(this,index)*this._step:notSetValue},Range.prototype.includes=function(searchValue){var possibleIndex=(searchValue-this._start)/this._step;return possibleIndex>=0&&possibleIndex<this.size&&possibleIndex===Math.floor(possibleIndex)},Range.prototype.slice=function(begin,end){return wholeSlice(begin,end,this.size)?this:(begin=resolveBegin(begin,this.size),(end=resolveEnd(end,this.size))<=begin?new Range(0,0):new Range(this.get(begin,this._end),this.get(end,this._end),this._step))},Range.prototype.indexOf=function(searchValue){var offsetValue=searchValue-this._start;if(offsetValue%this._step===0){var index=offsetValue/this._step;if(index>=0&&index<this.size)return index}return-1},Range.prototype.lastIndexOf=function(searchValue){return this.indexOf(searchValue)},Range.prototype.__iterate=function(fn,reverse){for(var size=this.size,step=this._step,value=reverse?this._start+(size-1)*step:this._start,i=0;i!==size&&!1!==fn(value,reverse?size-++i:i++,this);)value+=reverse?-step:step;return i},Range.prototype.__iterator=function(type,reverse){var size=this.size,step=this._step,value=reverse?this._start+(size-1)*step:this._start,i=0;return new Iterator(function(){if(i===size)return{value:void 0,done:!0};var v=value;return value+=reverse?-step:step,iteratorValue(type,reverse?size-++i:i++,v)})},Range.prototype.equals=function(other){return other instanceof Range?this._start===other._start&&this._end===other._end&&this._step===other._step:deepEqual(this,other)},Range}(IndexedSeq),Set$2=function(SetCollection){function Set(value){return null==value?emptySet():isSet(value)&&!isOrdered(value)?value:emptySet().withMutations(function(set){var iter=SetCollection(value);assertNotInfinite(iter.size),iter.forEach(function(v){return set.add(v)})})}return SetCollection&&(Set.__proto__=SetCollection),Set.prototype=Object.create(SetCollection&&SetCollection.prototype),Set.prototype.constructor=Set,Set.of=function(){return this(arguments)},Set.fromKeys=function(value){return this(KeyedCollection(value).keySeq())},Set.intersect=function(sets){return(sets=Collection(sets).toArray()).length?SetPrototype.intersect.apply(Set(sets.pop()),sets):emptySet()},Set.union=function(sets){return(sets=Collection(sets).toArray()).length?SetPrototype.union.apply(Set(sets.pop()),sets):emptySet()},Set.prototype.toString=function(){return this.__toString("Set {","}")},Set.prototype.has=function(value){return this._map.has(value)},Set.prototype.add=function(value){return updateSet(this,this._map.set(value,value))},Set.prototype.remove=function(value){return updateSet(this,this._map.remove(value))},Set.prototype.clear=function(){return updateSet(this,this._map.clear())},Set.prototype.map=function(mapper,context){var this$1$1=this,didChanges=!1,newMap=updateSet(this,this._map.mapEntries(function(ref){var v=ref[1],mapped=mapper.call(context,v,v,this$1$1);return mapped!==v&&(didChanges=!0),[mapped,mapped]},context));return didChanges?newMap:this},Set.prototype.union=function(){for(var iters=[],len=arguments.length;len--;)iters[len]=arguments[len];return 0===(iters=iters.filter(function(x){return 0!==x.size})).length?this:0!==this.size||this.__ownerID||1!==iters.length?this.withMutations(function(set){for(var ii=0;ii<iters.length;ii++)"string"==typeof iters[ii]?set.add(iters[ii]):SetCollection(iters[ii]).forEach(function(value){return set.add(value)})}):this.constructor(iters[0])},Set.prototype.intersect=function(){for(var iters=[],len=arguments.length;len--;)iters[len]=arguments[len];if(0===iters.length)return this;iters=iters.map(function(iter){return SetCollection(iter)});var toRemove=[];return this.forEach(function(value){iters.every(function(iter){return iter.includes(value)})||toRemove.push(value)}),this.withMutations(function(set){toRemove.forEach(function(value){set.remove(value)})})},Set.prototype.subtract=function(){for(var iters=[],len=arguments.length;len--;)iters[len]=arguments[len];if(0===iters.length)return this;iters=iters.map(function(iter){return SetCollection(iter)});var toRemove=[];return this.forEach(function(value){iters.some(function(iter){return iter.includes(value)})&&toRemove.push(value)}),this.withMutations(function(set){toRemove.forEach(function(value){set.remove(value)})})},Set.prototype.sort=function(comparator){return OrderedSet(sortFactory(this,comparator))},Set.prototype.sortBy=function(mapper,comparator){return OrderedSet(sortFactory(this,comparator,mapper))},Set.prototype.wasAltered=function(){return this._map.wasAltered()},Set.prototype.__iterate=function(fn,reverse){var this$1$1=this;return this._map.__iterate(function(k){return fn(k,k,this$1$1)},reverse)},Set.prototype.__iterator=function(type,reverse){return this._map.__iterator(type,reverse)},Set.prototype.__ensureOwner=function(ownerID){if(ownerID===this.__ownerID)return this;var newMap=this._map.__ensureOwner(ownerID);return ownerID?this.__make(newMap,ownerID):0===this.size?this.__empty():(this.__ownerID=ownerID,this._map=newMap,this)},Set}(SetCollection);Set$2.isSet=isSet;var EMPTY_SET,SetPrototype=Set$2.prototype;function updateSet(set,newMap){return set.__ownerID?(set.size=newMap.size,set._map=newMap,set):newMap===set._map?set:0===newMap.size?set.__empty():set.__make(newMap)}function makeSet(map,ownerID){var set=Object.create(SetPrototype);return set.size=map?map.size:0,set._map=map,set.__ownerID=ownerID,set}function emptySet(){return EMPTY_SET||(EMPTY_SET=makeSet(emptyMap()))}function getIn$1(collection,searchKeyPath,notSetValue){for(var keyPath=coerceKeyPath(searchKeyPath),i=0;i!==keyPath.length;)if((collection=get$5(collection,keyPath[i++],NOT_SET))===NOT_SET)return notSetValue;return collection}function getIn(searchKeyPath,notSetValue){return getIn$1(this,searchKeyPath,notSetValue)}function hasIn$1(collection,keyPath){return getIn$1(collection,keyPath,NOT_SET)!==NOT_SET}function toObject(){assertNotInfinite(this.size);var object={};return this.__iterate(function(v,k){object[k]=v}),object}function toJS(value){if(!value||"object"!=typeof value)return value;if(!isCollection(value)){if(!isDataStructure(value))return value;value=Seq(value)}if(isKeyed(value)){var result$1={};return value.__iterate(function(v,k){result$1[k]=toJS(v)}),result$1}var result=[];return value.__iterate(function(v){result.push(toJS(v))}),result}function hashCollection(collection){if(collection.size===1/0)return 0;var ordered=isOrdered(collection)&&!isMap(collection)&&!isSet(collection),keyed=isKeyed(collection),h=ordered?1:0;return collection.__iterate(keyed?ordered?function(v,k){h=31*h+hashMerge(hash(v),hash(k))|0}:function(v,k){h=h+hashMerge(hash(v),hash(k))|0}:ordered?function(v){h=31*h+hash(v)|0}:function(v){h=h+hash(v)|0}),function(size,h){return h=imul(h,3432918353),h=imul(h<<15|h>>>-15,461845907),h=imul(h<<13|h>>>-13,5),h=(h+3864292196|0)^size,h=imul(h^h>>>16,2246822507),h=imul(h^h>>>13,3266489909),h=smi(h^h>>>16),h}(collection.size,h)}function hashMerge(a,b){return a^b+2654435769+(a<<6)+(a>>2)|0}function mixin(ctor,methods){var keyCopier=function(key){ctor.prototype[key]=methods[key]};return Object.keys(methods).forEach(keyCopier),Object.getOwnPropertySymbols&&Object.getOwnPropertySymbols(methods).forEach(keyCopier),ctor}SetPrototype["@@__IMMUTABLE_SET__@@"]=!0,SetPrototype.delete=SetPrototype.remove,SetPrototype.merge=SetPrototype.concat=SetPrototype.union,SetPrototype.withMutations=withMutations,SetPrototype.asImmutable=asImmutable,SetPrototype["@@transducer/init"]=SetPrototype.asMutable=asMutable,SetPrototype["@@transducer/step"]=function(result,arr){return result.add(arr)},SetPrototype["@@transducer/result"]=function(obj){return obj.asImmutable()},SetPrototype.__empty=emptySet,SetPrototype.__make=makeSet,Collection.Iterator=Iterator,mixin(Collection,{toArray:function(){assertNotInfinite(this.size);var array=new Array(this.size||0),useTuples=isKeyed(this),i=0;return this.__iterate(function(v,k){array[i++]=useTuples?[k,v]:v}),array},toIndexedSeq:function(){return new ToIndexedSequence(this)},toJS:function(){return toJS(this)},toKeyedSeq:function(){return new ToKeyedSequence(this,!0)},toMap:function(){return Map$1(this.toKeyedSeq())},toObject:toObject,toOrderedMap:function(){return OrderedMap(this.toKeyedSeq())},toOrderedSet:function(){return OrderedSet(isKeyed(this)?this.valueSeq():this)},toSet:function(){return Set$2(isKeyed(this)?this.valueSeq():this)},toSetSeq:function(){return new ToSetSequence(this)},toSeq:function(){return isIndexed(this)?this.toIndexedSeq():isKeyed(this)?this.toKeyedSeq():this.toSetSeq()},toStack:function(){return Stack(isKeyed(this)?this.valueSeq():this)},toList:function(){return List$1(isKeyed(this)?this.valueSeq():this)},toString:function(){return"[Collection]"},__toString:function(head,tail){return 0===this.size?head+tail:head+" "+this.toSeq().map(this.__toStringMapper).join(", ")+" "+tail},concat:function(){for(var values=[],len=arguments.length;len--;)values[len]=arguments[len];return reify(this,function(collection,values){var isKeyedCollection=isKeyed(collection),iters=[collection].concat(values).map(function(v){return isCollection(v)?isKeyedCollection&&(v=KeyedCollection(v)):v=isKeyedCollection?keyedSeqFromValue(v):indexedSeqFromValue(Array.isArray(v)?v:[v]),v}).filter(function(v){return 0!==v.size});if(0===iters.length)return collection;if(1===iters.length){var singleton=iters[0];if(singleton===collection||isKeyedCollection&&isKeyed(singleton)||isIndexed(collection)&&isIndexed(singleton))return singleton}return new ConcatSeq(iters)}(this,values))},includes:function(searchValue){return this.some(function(value){return is(value,searchValue)})},entries:function(){return this.__iterator(2)},every:function(predicate,context){assertNotInfinite(this.size);var returnValue=!0;return this.__iterate(function(v,k,c){if(!predicate.call(context,v,k,c))return returnValue=!1,!1}),returnValue},filter:function(predicate,context){return reify(this,filterFactory(this,predicate,context,!0))},partition:function(predicate,context){return function(collection,predicate,context){var isKeyedIter=isKeyed(collection),groups=[[],[]];collection.__iterate(function(v,k){groups[predicate.call(context,v,k,collection)?1:0].push(isKeyedIter?[k,v]:v)});var coerce=collectionClass(collection);return groups.map(function(arr){return reify(collection,coerce(arr))})}(this,predicate,context)},find:function(predicate,context,notSetValue){var entry=this.findEntry(predicate,context);return entry?entry[1]:notSetValue},forEach:function(sideEffect,context){return assertNotInfinite(this.size),this.__iterate(context?sideEffect.bind(context):sideEffect)},join:function(separator){assertNotInfinite(this.size),separator=void 0!==separator?""+separator:",";var joined="",isFirst=!0;return this.__iterate(function(v){isFirst?isFirst=!1:joined+=separator,joined+=null!=v?v.toString():""}),joined},keys:function(){return this.__iterator(0)},map:function(mapper,context){return reify(this,mapFactory(this,mapper,context))},reduce:function(reducer,initialReduction,context){return reduce(this,reducer,initialReduction,context,arguments.length<2,!1)},reduceRight:function(reducer,initialReduction,context){return reduce(this,reducer,initialReduction,context,arguments.length<2,!0)},reverse:function(){return reify(this,reverseFactory(this,!0))},slice:function(begin,end){return reify(this,sliceFactory(this,begin,end,!0))},some:function(predicate,context){assertNotInfinite(this.size);var returnValue=!1;return this.__iterate(function(v,k,c){if(predicate.call(context,v,k,c))return returnValue=!0,!1}),returnValue},sort:function(comparator){return reify(this,sortFactory(this,comparator))},values:function(){return this.__iterator(1)},butLast:function(){return this.slice(0,-1)},isEmpty:function(){return void 0!==this.size?0===this.size:!this.some(function(){return!0})},count:function(predicate,context){return ensureSize(predicate?this.toSeq().filter(predicate,context):this)},countBy:function(grouper,context){return function(collection,grouper,context){var groups=Map$1().asMutable();return collection.__iterate(function(v,k){groups.update(grouper.call(context,v,k,collection),0,function(a){return a+1})}),groups.asImmutable()}(this,grouper,context)},equals:function(other){return deepEqual(this,other)},entrySeq:function(){var collection=this;if(collection._cache)return new ArraySeq(collection._cache);var entriesSequence=collection.toSeq().map(entryMapper).toIndexedSeq();return entriesSequence.fromEntrySeq=function(){return collection.toSeq()},entriesSequence},filterNot:function(predicate,context){return this.filter(not(predicate),context)},findEntry:function(predicate,context,notSetValue){var found=notSetValue;return this.__iterate(function(v,k,c){if(predicate.call(context,v,k,c))return found=[k,v],!1}),found},findKey:function(predicate,context){var entry=this.findEntry(predicate,context);return entry&&entry[0]},findLast:function(predicate,context,notSetValue){return this.toKeyedSeq().reverse().find(predicate,context,notSetValue)},findLastEntry:function(predicate,context,notSetValue){return this.toKeyedSeq().reverse().findEntry(predicate,context,notSetValue)},findLastKey:function(predicate,context){return this.toKeyedSeq().reverse().findKey(predicate,context)},first:function(notSetValue){return this.find(returnTrue,null,notSetValue)},flatMap:function(mapper,context){return reify(this,function(collection,mapper,context){var coerce=collectionClass(collection);return collection.toSeq().map(function(v,k){return coerce(mapper.call(context,v,k,collection))}).flatten(!0)}(this,mapper,context))},flatten:function(depth){return reify(this,flattenFactory(this,depth,!0))},fromEntrySeq:function(){return new FromEntriesSequence(this)},get:function(searchKey,notSetValue){return this.find(function(_,key){return is(key,searchKey)},void 0,notSetValue)},getIn:getIn,groupBy:function(grouper,context){return function(collection,grouper,context){var isKeyedIter=isKeyed(collection),groups=(isOrdered(collection)?OrderedMap():Map$1()).asMutable();collection.__iterate(function(v,k){groups.update(grouper.call(context,v,k,collection),function(a){return(a=a||[]).push(isKeyedIter?[k,v]:v),a})});var coerce=collectionClass(collection);return groups.map(function(arr){return reify(collection,coerce(arr))}).asImmutable()}(this,grouper,context)},has:function(searchKey){return this.get(searchKey,NOT_SET)!==NOT_SET},hasIn:function(searchKeyPath){return hasIn$1(this,searchKeyPath)},isSubset:function(iter){return iter="function"==typeof iter.includes?iter:Collection(iter),this.every(function(value){return iter.includes(value)})},isSuperset:function(iter){return(iter="function"==typeof iter.isSubset?iter:Collection(iter)).isSubset(this)},keyOf:function(searchValue){return this.findKey(function(value){return is(value,searchValue)})},keySeq:function(){return this.toSeq().map(keyMapper).toIndexedSeq()},last:function(notSetValue){return this.toSeq().reverse().first(notSetValue)},lastKeyOf:function(searchValue){return this.toKeyedSeq().reverse().keyOf(searchValue)},max:function(comparator){return maxFactory(this,comparator)},maxBy:function(mapper,comparator){return maxFactory(this,comparator,mapper)},min:function(comparator){return maxFactory(this,comparator?neg(comparator):defaultNegComparator)},minBy:function(mapper,comparator){return maxFactory(this,comparator?neg(comparator):defaultNegComparator,mapper)},rest:function(){return this.slice(1)},skip:function(amount){return 0===amount?this:this.slice(Math.max(0,amount))},skipLast:function(amount){return 0===amount?this:this.slice(0,-Math.max(0,amount))},skipWhile:function(predicate,context){return reify(this,skipWhileFactory(this,predicate,context,!0))},skipUntil:function(predicate,context){return this.skipWhile(not(predicate),context)},sortBy:function(mapper,comparator){return reify(this,sortFactory(this,comparator,mapper))},take:function(amount){return this.slice(0,Math.max(0,amount))},takeLast:function(amount){return this.slice(-Math.max(0,amount))},takeWhile:function(predicate,context){return reify(this,function(collection,predicate,context){var takeSequence=makeSequence(collection);return takeSequence.__iterateUncached=function(fn,reverse){var this$1$1=this;if(reverse)return this.cacheResult().__iterate(fn,reverse);var iterations=0;return collection.__iterate(function(v,k,c){return predicate.call(context,v,k,c)&&++iterations&&fn(v,k,this$1$1)}),iterations},takeSequence.__iteratorUncached=function(type,reverse){var this$1$1=this;if(reverse)return this.cacheResult().__iterator(type,reverse);var iterator=collection.__iterator(2,reverse),iterating=!0;return new Iterator(function(){if(!iterating)return{value:void 0,done:!0};var step=iterator.next();if(step.done)return step;var entry=step.value,k=entry[0],v=entry[1];return predicate.call(context,v,k,this$1$1)?2===type?step:iteratorValue(type,k,v,step):(iterating=!1,{value:void 0,done:!0})})},takeSequence}(this,predicate,context))},takeUntil:function(predicate,context){return this.takeWhile(not(predicate),context)},update:function(fn){return fn(this)},valueSeq:function(){return this.toIndexedSeq()},hashCode:function(){return this.__hash||(this.__hash=hashCollection(this))}});var CollectionPrototype=Collection.prototype;CollectionPrototype["@@__IMMUTABLE_ITERABLE__@@"]=!0,CollectionPrototype[ITERATOR_SYMBOL]=CollectionPrototype.values,CollectionPrototype.toJSON=CollectionPrototype.toArray,CollectionPrototype.__toStringMapper=quoteString,CollectionPrototype.inspect=CollectionPrototype.toSource=function(){return this.toString()},CollectionPrototype.chain=CollectionPrototype.flatMap,CollectionPrototype.contains=CollectionPrototype.includes,mixin(KeyedCollection,{flip:function(){return reify(this,flipFactory(this))},mapEntries:function(mapper,context){var this$1$1=this,iterations=0;return reify(this,this.toSeq().map(function(v,k){return mapper.call(context,[k,v],iterations++,this$1$1)}).fromEntrySeq())},mapKeys:function(mapper,context){var this$1$1=this;return reify(this,this.toSeq().flip().map(function(k,v){return mapper.call(context,k,v,this$1$1)}).flip())}});var KeyedCollectionPrototype=KeyedCollection.prototype;KeyedCollectionPrototype["@@__IMMUTABLE_KEYED__@@"]=!0,KeyedCollectionPrototype[ITERATOR_SYMBOL]=CollectionPrototype.entries,KeyedCollectionPrototype.toJSON=toObject,KeyedCollectionPrototype.__toStringMapper=function(v,k){return quoteString(k)+": "+quoteString(v)},mixin(IndexedCollection,{toKeyedSeq:function(){return new ToKeyedSequence(this,!1)},filter:function(predicate,context){return reify(this,filterFactory(this,predicate,context,!1))},findIndex:function(predicate,context){var entry=this.findEntry(predicate,context);return entry?entry[0]:-1},indexOf:function(searchValue){var key=this.keyOf(searchValue);return void 0===key?-1:key},lastIndexOf:function(searchValue){var key=this.lastKeyOf(searchValue);return void 0===key?-1:key},reverse:function(){return reify(this,reverseFactory(this,!1))},slice:function(begin,end){return reify(this,sliceFactory(this,begin,end,!1))},splice:function(index,removeNum){var numArgs=arguments.length;if(removeNum=Math.max(removeNum||0,0),0===numArgs||2===numArgs&&!removeNum)return this;index=resolveBegin(index,index<0?this.count():this.size);var spliced=this.slice(0,index);return reify(this,1===numArgs?spliced:spliced.concat(arrCopy(arguments,2),this.slice(index+removeNum)))},findLastIndex:function(predicate,context){var entry=this.findLastEntry(predicate,context);return entry?entry[0]:-1},first:function(notSetValue){return this.get(0,notSetValue)},flatten:function(depth){return reify(this,flattenFactory(this,depth,!1))},get:function(index,notSetValue){return(index=wrapIndex(this,index))<0||this.size===1/0||void 0!==this.size&&index>this.size?notSetValue:this.find(function(_,key){return key===index},void 0,notSetValue)},has:function(index){return(index=wrapIndex(this,index))>=0&&(void 0!==this.size?this.size===1/0||index<this.size:-1!==this.indexOf(index))},interpose:function(separator){return reify(this,function(collection,separator){var interposedSequence=makeSequence(collection);return interposedSequence.size=collection.size&&2*collection.size-1,interposedSequence.__iterateUncached=function(fn,reverse){var this$1$1=this,iterations=0;return collection.__iterate(function(v){return(!iterations||!1!==fn(separator,iterations++,this$1$1))&&!1!==fn(v,iterations++,this$1$1)},reverse),iterations},interposedSequence.__iteratorUncached=function(type,reverse){var step,iterator=collection.__iterator(1,reverse),iterations=0;return new Iterator(function(){return(!step||iterations%2)&&(step=iterator.next()).done?step:iterations%2?iteratorValue(type,iterations++,separator):iteratorValue(type,iterations++,step.value,step)})},interposedSequence}(this,separator))},interleave:function(){var collections=[this].concat(arrCopy(arguments)),zipped=zipWithFactory(this.toSeq(),IndexedSeq.of,collections),interleaved=zipped.flatten(!0);return zipped.size&&(interleaved.size=zipped.size*collections.length),reify(this,interleaved)},keySeq:function(){return Range(0,this.size)},last:function(notSetValue){return this.get(-1,notSetValue)},skipWhile:function(predicate,context){return reify(this,skipWhileFactory(this,predicate,context,!1))},zip:function(){return reify(this,zipWithFactory(this,defaultZipper,[this].concat(arrCopy(arguments))))},zipAll:function(){return reify(this,zipWithFactory(this,defaultZipper,[this].concat(arrCopy(arguments)),!0))},zipWith:function(zipper){var collections=arrCopy(arguments);return collections[0]=this,reify(this,zipWithFactory(this,zipper,collections))}});var IndexedCollectionPrototype=IndexedCollection.prototype;IndexedCollectionPrototype["@@__IMMUTABLE_INDEXED__@@"]=!0,IndexedCollectionPrototype[IS_ORDERED_SYMBOL]=!0,mixin(SetCollection,{get:function(value,notSetValue){return this.has(value)?value:notSetValue},includes:function(value){return this.has(value)},keySeq:function(){return this.valueSeq()}});var SetCollectionPrototype=SetCollection.prototype;function defaultZipper(){return arrCopy(arguments)}function isOrderedSet(maybeOrderedSet){return isSet(maybeOrderedSet)&&isOrdered(maybeOrderedSet)}SetCollectionPrototype.has=CollectionPrototype.includes,SetCollectionPrototype.contains=SetCollectionPrototype.includes,SetCollectionPrototype.keys=SetCollectionPrototype.values,mixin(KeyedSeq,KeyedCollectionPrototype),mixin(IndexedSeq,IndexedCollectionPrototype),mixin(SetSeq,SetCollectionPrototype);var OrderedSet=function(Set){function OrderedSet(value){return null==value?emptyOrderedSet():isOrderedSet(value)?value:emptyOrderedSet().withMutations(function(set){var iter=SetCollection(value);assertNotInfinite(iter.size),iter.forEach(function(v){return set.add(v)})})}return Set&&(OrderedSet.__proto__=Set),OrderedSet.prototype=Object.create(Set&&Set.prototype),OrderedSet.prototype.constructor=OrderedSet,OrderedSet.of=function(){return this(arguments)},OrderedSet.fromKeys=function(value){return this(KeyedCollection(value).keySeq())},OrderedSet.prototype.toString=function(){return this.__toString("OrderedSet {","}")},OrderedSet}(Set$2);OrderedSet.isOrderedSet=isOrderedSet;var EMPTY_ORDERED_SET,OrderedSetPrototype=OrderedSet.prototype;function makeOrderedSet(map,ownerID){var set=Object.create(OrderedSetPrototype);return set.size=map?map.size:0,set._map=map,set.__ownerID=ownerID,set}function emptyOrderedSet(){return EMPTY_ORDERED_SET||(EMPTY_ORDERED_SET=makeOrderedSet(emptyOrderedMap()))}OrderedSetPrototype[IS_ORDERED_SYMBOL]=!0,OrderedSetPrototype.zip=IndexedCollectionPrototype.zip,OrderedSetPrototype.zipWith=IndexedCollectionPrototype.zipWith,OrderedSetPrototype.zipAll=IndexedCollectionPrototype.zipAll,OrderedSetPrototype.__empty=emptyOrderedSet,OrderedSetPrototype.__make=makeOrderedSet;var Record=function(defaultValues,name){var hasInitialized;!function(defaultValues){if(isRecord(defaultValues))throw new Error("Can not call `Record` with an immutable Record as default values. Use a plain javascript object instead.");if(isImmutable(defaultValues))throw new Error("Can not call `Record` with an immutable Collection as default values. Use a plain javascript object instead.");if(null===defaultValues||"object"!=typeof defaultValues)throw new Error("Can not call `Record` with a non-object as default values. Use a plain javascript object instead.")}(defaultValues);var RecordType=function(values){var this$1$1=this;if(values instanceof RecordType)return values;if(!(this instanceof RecordType))return new RecordType(values);if(!hasInitialized){hasInitialized=!0;var keys=Object.keys(defaultValues),indices=RecordTypePrototype._indices={};RecordTypePrototype._name=name,RecordTypePrototype._keys=keys,RecordTypePrototype._defaultValues=defaultValues;for(var i=0;i<keys.length;i++){var propName=keys[i];indices[propName]=i,RecordTypePrototype[propName]?"object"==typeof console&&console.warn&&console.warn("Cannot define "+recordName(this)+' with property "'+propName+'" since that property name is part of the Record API.'):setProp(RecordTypePrototype,propName)}}return this.__ownerID=void 0,this._values=List$1().withMutations(function(l){l.setSize(this$1$1._keys.length),KeyedCollection(values).forEach(function(v,k){l.set(this$1$1._indices[k],v===this$1$1._defaultValues[k]?void 0:v)})}),this},RecordTypePrototype=RecordType.prototype=Object.create(RecordPrototype);return RecordTypePrototype.constructor=RecordType,name&&(RecordType.displayName=name),RecordType};Record.prototype.toString=function(){for(var k,str=recordName(this)+" { ",keys=this._keys,i=0,l=keys.length;i!==l;i++)str+=(i?", ":"")+(k=keys[i])+": "+quoteString(this.get(k));return str+" }"},Record.prototype.equals=function(other){return this===other||isRecord(other)&&recordSeq(this).equals(recordSeq(other))},Record.prototype.hashCode=function(){return recordSeq(this).hashCode()},Record.prototype.has=function(k){return this._indices.hasOwnProperty(k)},Record.prototype.get=function(k,notSetValue){if(!this.has(k))return notSetValue;var index=this._indices[k],value=this._values.get(index);return void 0===value?this._defaultValues[k]:value},Record.prototype.set=function(k,v){if(this.has(k)){var newValues=this._values.set(this._indices[k],v===this._defaultValues[k]?void 0:v);if(newValues!==this._values&&!this.__ownerID)return makeRecord(this,newValues)}return this},Record.prototype.remove=function(k){return this.set(k)},Record.prototype.clear=function(){var newValues=this._values.clear().setSize(this._keys.length);return this.__ownerID?this:makeRecord(this,newValues)},Record.prototype.wasAltered=function(){return this._values.wasAltered()},Record.prototype.toSeq=function(){return recordSeq(this)},Record.prototype.toJS=function(){return toJS(this)},Record.prototype.entries=function(){return this.__iterator(2)},Record.prototype.__iterator=function(type,reverse){return recordSeq(this).__iterator(type,reverse)},Record.prototype.__iterate=function(fn,reverse){return recordSeq(this).__iterate(fn,reverse)},Record.prototype.__ensureOwner=function(ownerID){if(ownerID===this.__ownerID)return this;var newValues=this._values.__ensureOwner(ownerID);return ownerID?makeRecord(this,newValues,ownerID):(this.__ownerID=ownerID,this._values=newValues,this)},Record.isRecord=isRecord,Record.getDescriptiveName=recordName;var RecordPrototype=Record.prototype;function makeRecord(likeRecord,values,ownerID){var record=Object.create(Object.getPrototypeOf(likeRecord));return record._values=values,record.__ownerID=ownerID,record}function recordName(record){return record.constructor.displayName||record.constructor.name||"Record"}function recordSeq(record){return keyedSeqFromValue(record._keys.map(function(k){return[k,record.get(k)]}))}function setProp(prototype,name){try{Object.defineProperty(prototype,name,{get:function(){return this.get(name)},set:function(value){invariant(this.__ownerID,"Cannot set on an immutable record."),this.set(name,value)}})}catch(error){}}RecordPrototype["@@__IMMUTABLE_RECORD__@@"]=!0,RecordPrototype.delete=RecordPrototype.remove,RecordPrototype.deleteIn=RecordPrototype.removeIn=deleteIn,RecordPrototype.getIn=getIn,RecordPrototype.hasIn=CollectionPrototype.hasIn,RecordPrototype.merge=merge$1$1,RecordPrototype.mergeWith=mergeWith$1,RecordPrototype.mergeIn=mergeIn,RecordPrototype.mergeDeep=mergeDeep,RecordPrototype.mergeDeepWith=mergeDeepWith,RecordPrototype.mergeDeepIn=mergeDeepIn,RecordPrototype.setIn=setIn,RecordPrototype.update=update,RecordPrototype.updateIn=updateIn$1,RecordPrototype.withMutations=withMutations,RecordPrototype.asMutable=asMutable,RecordPrototype.asImmutable=asImmutable,RecordPrototype[ITERATOR_SYMBOL]=RecordPrototype.entries,RecordPrototype.toJSON=RecordPrototype.toObject=CollectionPrototype.toObject,RecordPrototype.inspect=RecordPrototype.toSource=function(){return this.toString()};var EMPTY_REPEAT,Repeat=function(IndexedSeq){function Repeat(value,times){if(!(this instanceof Repeat))return new Repeat(value,times);if(this._value=value,this.size=void 0===times?1/0:Math.max(0,times),0===this.size){if(EMPTY_REPEAT)return EMPTY_REPEAT;EMPTY_REPEAT=this}}return IndexedSeq&&(Repeat.__proto__=IndexedSeq),Repeat.prototype=Object.create(IndexedSeq&&IndexedSeq.prototype),Repeat.prototype.constructor=Repeat,Repeat.prototype.toString=function(){return 0===this.size?"Repeat []":"Repeat [ "+this._value+" "+this.size+" times ]"},Repeat.prototype.get=function(index,notSetValue){return this.has(index)?this._value:notSetValue},Repeat.prototype.includes=function(searchValue){return is(this._value,searchValue)},Repeat.prototype.slice=function(begin,end){var size=this.size;return wholeSlice(begin,end,size)?this:new Repeat(this._value,resolveEnd(end,size)-resolveBegin(begin,size))},Repeat.prototype.reverse=function(){return this},Repeat.prototype.indexOf=function(searchValue){return is(this._value,searchValue)?0:-1},Repeat.prototype.lastIndexOf=function(searchValue){return is(this._value,searchValue)?this.size:-1},Repeat.prototype.__iterate=function(fn,reverse){for(var size=this.size,i=0;i!==size&&!1!==fn(this._value,reverse?size-++i:i++,this););return i},Repeat.prototype.__iterator=function(type,reverse){var this$1$1=this,size=this.size,i=0;return new Iterator(function(){return i===size?{value:void 0,done:!0}:iteratorValue(type,reverse?size-++i:i++,this$1$1._value)})},Repeat.prototype.equals=function(other){return other instanceof Repeat?is(this._value,other._value):deepEqual(this,other)},Repeat}(IndexedSeq);function fromJSWith(stack,converter,value,key,keyPath,parentValue){if("string"!=typeof value&&!isImmutable(value)&&(isArrayLike(value)||hasIterator(value)||isPlainObject(value))){if(~stack.indexOf(value))throw new TypeError("Cannot convert circular structure to Immutable");stack.push(value),keyPath&&""!==key&&keyPath.push(key);var converted=converter.call(parentValue,key,Seq(value).map(function(v,k){return fromJSWith(stack,converter,v,k,keyPath,value)}),keyPath&&keyPath.slice());return stack.pop(),keyPath&&keyPath.pop(),converted}return value}function defaultConverter(k,v){return isIndexed(v)?v.toList():isKeyed(v)?v.toMap():v.toSet()}var im={Collection:Collection,Iterable:Collection,List:List$1,Map:Map$1,OrderedMap:OrderedMap,OrderedSet:OrderedSet,PairSorting:{LeftThenRight:-1,RightThenLeft:1},Range:Range,Record:Record,Repeat:Repeat,Seq:Seq,Set:Set$2,Stack:Stack,fromJS:function(value,converter){return fromJSWith([],converter||defaultConverter,value,"",converter&&converter.length>2?[]:void 0,{"":value})},get:get$5,getIn:getIn$1,has:has$5,hasIn:hasIn$1,hash:hash,is:is,isAssociative:isAssociative,isCollection:isCollection,isImmutable:isImmutable,isIndexed:isIndexed,isKeyed:isKeyed,isList:isList,isMap:isMap,isOrdered:isOrdered,isOrderedMap:isOrderedMap,isOrderedSet:isOrderedSet,isPlainObject:isPlainObject,isRecord:isRecord,isSeq:isSeq,isSet:isSet,isStack:isStack,isValueObject:isValueObject,merge:function(collection){for(var sources=[],len=arguments.length-1;len-- >0;)sources[len]=arguments[len+1];return mergeWithSources(collection,sources)},mergeDeep:function(collection){for(var sources=[],len=arguments.length-1;len-- >0;)sources[len]=arguments[len+1];return mergeDeepWithSources(collection,sources)},mergeDeepWith:function(merger,collection){for(var sources=[],len=arguments.length-2;len-- >0;)sources[len]=arguments[len+2];return mergeDeepWithSources(collection,sources,merger)},mergeWith:function(merger,collection){for(var sources=[],len=arguments.length-2;len-- >0;)sources[len]=arguments[len+2];return mergeWithSources(collection,sources,merger)},remove:remove$4,removeIn:removeIn,set:set$4,setIn:setIn$1,update:update$1,updateIn:updateIn,version:"5.1.3"};function checkKey(object,key){if(checkType(object,"object"),!object.has(key))throw new Panic$1("key not found",{key:key});return key}function isMatch(object,matcher){return checkType(object,"object"),checkType(matcher,"object"),matchHelper(object,matcher)}function matchHelper(value,goal){return"object"!==getType(value)&&"object"!==getType(goal)?im.is(value,goal):goal.every((v,k)=>value.has(k)&&matchHelper(value.get(k),v))}class CsvError extends Error{constructor(code,message,options,...contexts){Array.isArray(message)&&(message=message.join(" ").trim()),super(message),void 0!==Error.captureStackTrace&&Error.captureStackTrace(this,CsvError),this.code=code;for(const context of contexts)for(const key in context){const value=context[key];this[key]=Buffer.isBuffer(value)?value.toString(options.encoding):null==value?value:JSON.parse(JSON.stringify(value))}}}const is_object=function(obj){return"object"==typeof obj&&null!==obj&&!Array.isArray(obj)},normalize_columns_array=function(columns){const normalizedColumns=[];for(let i=0,l=columns.length;i<l;i++){const column=columns[i];if(null==column||!1===column)normalizedColumns[i]={disabled:!0};else if("string"==typeof column)normalizedColumns[i]={name:column};else{if(!is_object(column))throw new CsvError("CSV_INVALID_COLUMN_DEFINITION",["Invalid column definition:","expect a string or a literal object,",`got ${JSON.stringify(column)} at position ${i}`]);if("string"!=typeof column.name)throw new CsvError("CSV_OPTION_COLUMNS_MISSING_NAME",["Option columns missing name:",`property "name" is required at position ${i}`,"when column is an object literal"]);normalizedColumns[i]=column}}return normalizedColumns};class ResizeableBuffer{constructor(size=100){this.size=size,this.length=0,this.buf=Buffer.allocUnsafe(size)}prepend(val){if(Buffer.isBuffer(val)){const length=this.length+val.length;if(length>=this.size&&(this.resize(),length>=this.size))throw Error("INVALID_BUFFER_STATE");const buf=this.buf;this.buf=Buffer.allocUnsafe(this.size),val.copy(this.buf,0),buf.copy(this.buf,val.length),this.length+=val.length}else{const length=this.length++;length===this.size&&this.resize();const buf=this.clone();this.buf[0]=val,buf.copy(this.buf,1,0,length)}}append(val){const length=this.length++;length===this.size&&this.resize(),this.buf[length]=val}clone(){return Buffer.from(this.buf.slice(0,this.length))}resize(){const length=this.length;this.size=2*this.size;const buf=Buffer.allocUnsafe(this.size);this.buf.copy(buf,0,0,length),this.buf=buf}toString(encoding){return encoding?this.buf.slice(0,this.length).toString(encoding):Uint8Array.prototype.slice.call(this.buf.slice(0,this.length))}toJSON(){return this.toString("utf8")}reset(){this.length=0}}const init_state=function(options){return{bomSkipped:!1,bufBytesStart:0,castField:options.cast_function,commenting:!1,error:void 0,enabled:1===options.from_line,escaping:!1,escapeIsQuote:Buffer.isBuffer(options.escape)&&Buffer.isBuffer(options.quote)&&0===Buffer.compare(options.escape,options.quote),expectedRecordLength:Array.isArray(options.columns)?options.columns.length:void 0,field:new ResizeableBuffer(20),firstLineToHeaders:options.cast_first_line_to_header,needMoreDataSize:Math.max(null!==options.comment?options.comment.length:0,...options.delimiter.map(delimiter=>delimiter.length),null!==options.quote?options.quote.length:0),previousBuf:void 0,quoting:!1,stop:!1,rawBuffer:new ResizeableBuffer(100),record:[],recordHasError:!1,record_length:0,recordDelimiterMaxLength:0===options.record_delimiter.length?0:Math.max(...options.record_delimiter.map(v=>v.length)),trimChars:[Buffer.from(" ",options.encoding)[0],Buffer.from("\t",options.encoding)[0]],wasQuoting:!1,wasRowDelimiter:!1,timchars:[Buffer.from(Buffer.from([13],"utf8").toString(),options.encoding),Buffer.from(Buffer.from([10],"utf8").toString(),options.encoding),Buffer.from(Buffer.from([12],"utf8").toString(),options.encoding),Buffer.from(Buffer.from([32],"utf8").toString(),options.encoding),Buffer.from(Buffer.from([9],"utf8").toString(),options.encoding)]}},underscore=function(str){return str.replace(/([A-Z])/g,function(_,match){return"_"+match.toLowerCase()})},normalize_options=function(opts){const options={};for(const opt in opts)options[underscore(opt)]=opts[opt];if(void 0===options.encoding||!0===options.encoding)options.encoding="utf8";else if(null===options.encoding||!1===options.encoding)options.encoding=null;else if("string"!=typeof options.encoding&&null!==options.encoding)throw new CsvError("CSV_INVALID_OPTION_ENCODING",["Invalid option encoding:","encoding must be a string or null to return a buffer,",`got ${JSON.stringify(options.encoding)}`],options);if(void 0===options.bom||null===options.bom||!1===options.bom)options.bom=!1;else if(!0!==options.bom)throw new CsvError("CSV_INVALID_OPTION_BOM",["Invalid option bom:","bom must be true,",`got ${JSON.stringify(options.bom)}`],options);if(options.cast_function=null,void 0===options.cast||null===options.cast||!1===options.cast||""===options.cast)options.cast=void 0;else if("function"==typeof options.cast)options.cast_function=options.cast,options.cast=!0;else if(!0!==options.cast)throw new CsvError("CSV_INVALID_OPTION_CAST",["Invalid option cast:","cast must be true or a function,",`got ${JSON.stringify(options.cast)}`],options);if(void 0===options.cast_date||null===options.cast_date||!1===options.cast_date||""===options.cast_date)options.cast_date=!1;else if(!0===options.cast_date)options.cast_date=function(value){const date=Date.parse(value);return isNaN(date)?value:new Date(date)};else if("function"!=typeof options.cast_date)throw new CsvError("CSV_INVALID_OPTION_CAST_DATE",["Invalid option cast_date:","cast_date must be true or a function,",`got ${JSON.stringify(options.cast_date)}`],options);if(options.cast_first_line_to_header=null,!0===options.columns)options.cast_first_line_to_header=void 0;else if("function"==typeof options.columns)options.cast_first_line_to_header=options.columns,options.columns=!0;else if(Array.isArray(options.columns))options.columns=normalize_columns_array(options.columns);else{if(void 0!==options.columns&&null!==options.columns&&!1!==options.columns)throw new CsvError("CSV_INVALID_OPTION_COLUMNS",["Invalid option columns:","expect an array, a function or true,",`got ${JSON.stringify(options.columns)}`],options);options.columns=!1}if(void 0===options.group_columns_by_name||null===options.group_columns_by_name||!1===options.group_columns_by_name)options.group_columns_by_name=!1;else{if(!0!==options.group_columns_by_name)throw new CsvError("CSV_INVALID_OPTION_GROUP_COLUMNS_BY_NAME",["Invalid option group_columns_by_name:","expect an boolean,",`got ${JSON.stringify(options.group_columns_by_name)}`],options);if(!1===options.columns)throw new CsvError("CSV_INVALID_OPTION_GROUP_COLUMNS_BY_NAME",["Invalid option group_columns_by_name:","the `columns` mode must be activated."],options)}if(void 0===options.comment||null===options.comment||!1===options.comment||""===options.comment)options.comment=null;else if("string"==typeof options.comment&&(options.comment=Buffer.from(options.comment,options.encoding)),!Buffer.isBuffer(options.comment))throw new CsvError("CSV_INVALID_OPTION_COMMENT",["Invalid option comment:","comment must be a buffer or a string,",`got ${JSON.stringify(options.comment)}`],options);if(void 0===options.comment_no_infix||null===options.comment_no_infix||!1===options.comment_no_infix)options.comment_no_infix=!1;else if(!0!==options.comment_no_infix)throw new CsvError("CSV_INVALID_OPTION_COMMENT",["Invalid option comment_no_infix:","value must be a boolean,",`got ${JSON.stringify(options.comment_no_infix)}`],options);const delimiter_json=JSON.stringify(options.delimiter);if(Array.isArray(options.delimiter)||(options.delimiter=[options.delimiter]),0===options.delimiter.length)throw new CsvError("CSV_INVALID_OPTION_DELIMITER",["Invalid option delimiter:","delimiter must be a non empty string or buffer or array of string|buffer,",`got ${delimiter_json}`],options);if(options.delimiter=options.delimiter.map(function(delimiter){if(null==delimiter||!1===delimiter)return Buffer.from(",",options.encoding);if("string"==typeof delimiter&&(delimiter=Buffer.from(delimiter,options.encoding)),!Buffer.isBuffer(delimiter)||0===delimiter.length)throw new CsvError("CSV_INVALID_OPTION_DELIMITER",["Invalid option delimiter:","delimiter must be a non empty string or buffer or array of string|buffer,",`got ${delimiter_json}`],options);return delimiter}),void 0===options.escape||!0===options.escape?options.escape=Buffer.from('"',options.encoding):"string"==typeof options.escape?options.escape=Buffer.from(options.escape,options.encoding):null!==options.escape&&!1!==options.escape||(options.escape=null),null!==options.escape&&!Buffer.isBuffer(options.escape))throw new Error(`Invalid Option: escape must be a buffer, a string or a boolean, got ${JSON.stringify(options.escape)}`);if(void 0===options.from||null===options.from)options.from=1;else{if("string"==typeof options.from&&/\d+/.test(options.from)&&(options.from=parseInt(options.from)),!Number.isInteger(options.from))throw new Error(`Invalid Option: from must be an integer, got ${JSON.stringify(options.from)}`);if(options.from<0)throw new Error(`Invalid Option: from must be a positive integer, got ${JSON.stringify(opts.from)}`)}if(void 0===options.from_line||null===options.from_line)options.from_line=1;else{if("string"==typeof options.from_line&&/\d+/.test(options.from_line)&&(options.from_line=parseInt(options.from_line)),!Number.isInteger(options.from_line))throw new Error(`Invalid Option: from_line must be an integer, got ${JSON.stringify(opts.from_line)}`);if(options.from_line<=0)throw new Error(`Invalid Option: from_line must be a positive integer greater than 0, got ${JSON.stringify(opts.from_line)}`)}if(void 0===options.ignore_last_delimiters||null===options.ignore_last_delimiters)options.ignore_last_delimiters=!1;else if("number"==typeof options.ignore_last_delimiters)options.ignore_last_delimiters=Math.floor(options.ignore_last_delimiters),0===options.ignore_last_delimiters&&(options.ignore_last_delimiters=!1);else if("boolean"!=typeof options.ignore_last_delimiters)throw new CsvError("CSV_INVALID_OPTION_IGNORE_LAST_DELIMITERS",["Invalid option `ignore_last_delimiters`:","the value must be a boolean value or an integer,",`got ${JSON.stringify(options.ignore_last_delimiters)}`],options);if(!0===options.ignore_last_delimiters&&!1===options.columns)throw new CsvError("CSV_IGNORE_LAST_DELIMITERS_REQUIRES_COLUMNS",["The option `ignore_last_delimiters`","requires the activation of the `columns` option"],options);if(void 0===options.info||null===options.info||!1===options.info)options.info=!1;else if(!0!==options.info)throw new Error(`Invalid Option: info must be true, got ${JSON.stringify(options.info)}`);if(void 0===options.max_record_size||null===options.max_record_size||!1===options.max_record_size)options.max_record_size=0;else if(Number.isInteger(options.max_record_size)&&options.max_record_size>=0);else{if("string"!=typeof options.max_record_size||!/\d+/.test(options.max_record_size))throw new Error(`Invalid Option: max_record_size must be a positive integer, got ${JSON.stringify(options.max_record_size)}`);options.max_record_size=parseInt(options.max_record_size)}if(void 0===options.objname||null===options.objname||!1===options.objname)options.objname=void 0;else if(Buffer.isBuffer(options.objname)){if(0===options.objname.length)throw new Error("Invalid Option: objname must be a non empty buffer");null===options.encoding||(options.objname=options.objname.toString(options.encoding))}else if("string"==typeof options.objname){if(0===options.objname.length)throw new Error("Invalid Option: objname must be a non empty string")}else if("number"!=typeof options.objname)throw new Error(`Invalid Option: objname must be a string or a buffer, got ${options.objname}`);if(void 0!==options.objname)if("number"==typeof options.objname){if(!1!==options.columns)throw Error("Invalid Option: objname index cannot be combined with columns or be defined as a field")}else if(!1===options.columns)throw Error("Invalid Option: objname field must be combined with columns or be defined as an index");if(void 0===options.on_record||null===options.on_record)options.on_record=void 0;else if("function"!=typeof options.on_record)throw new CsvError("CSV_INVALID_OPTION_ON_RECORD",["Invalid option `on_record`:","expect a function,",`got ${JSON.stringify(options.on_record)}`],options);if(void 0!==options.on_skip&&null!==options.on_skip&&"function"!=typeof options.on_skip)throw new Error(`Invalid Option: on_skip must be a function, got ${JSON.stringify(options.on_skip)}`);if(null===options.quote||!1===options.quote||""===options.quote)options.quote=null;else if(void 0===options.quote||!0===options.quote?options.quote=Buffer.from('"',options.encoding):"string"==typeof options.quote&&(options.quote=Buffer.from(options.quote,options.encoding)),!Buffer.isBuffer(options.quote))throw new Error(`Invalid Option: quote must be a buffer or a string, got ${JSON.stringify(options.quote)}`);if(void 0===options.raw||null===options.raw||!1===options.raw)options.raw=!1;else if(!0!==options.raw)throw new Error(`Invalid Option: raw must be true, got ${JSON.stringify(options.raw)}`);if(void 0===options.record_delimiter)options.record_delimiter=[];else if("string"==typeof options.record_delimiter||Buffer.isBuffer(options.record_delimiter)){if(0===options.record_delimiter.length)throw new CsvError("CSV_INVALID_OPTION_RECORD_DELIMITER",["Invalid option `record_delimiter`:","value must be a non empty string or buffer,",`got ${JSON.stringify(options.record_delimiter)}`],options);options.record_delimiter=[options.record_delimiter]}else if(!Array.isArray(options.record_delimiter))throw new CsvError("CSV_INVALID_OPTION_RECORD_DELIMITER",["Invalid option `record_delimiter`:","value must be a string, a buffer or array of string|buffer,",`got ${JSON.stringify(options.record_delimiter)}`],options);if(options.record_delimiter=options.record_delimiter.map(function(rd,i){if("string"!=typeof rd&&!Buffer.isBuffer(rd))throw new CsvError("CSV_INVALID_OPTION_RECORD_DELIMITER",["Invalid option `record_delimiter`:","value must be a string, a buffer or array of string|buffer",`at index ${i},`,`got ${JSON.stringify(rd)}`],options);if(0===rd.length)throw new CsvError("CSV_INVALID_OPTION_RECORD_DELIMITER",["Invalid option `record_delimiter`:","value must be a non empty string or buffer",`at index ${i},`,`got ${JSON.stringify(rd)}`],options);return"string"==typeof rd&&(rd=Buffer.from(rd,options.encoding)),rd}),"boolean"==typeof options.relax_column_count);else{if(void 0!==options.relax_column_count&&null!==options.relax_column_count)throw new Error(`Invalid Option: relax_column_count must be a boolean, got ${JSON.stringify(options.relax_column_count)}`);options.relax_column_count=!1}if("boolean"==typeof options.relax_column_count_less);else{if(void 0!==options.relax_column_count_less&&null!==options.relax_column_count_less)throw new Error(`Invalid Option: relax_column_count_less must be a boolean, got ${JSON.stringify(options.relax_column_count_less)}`);options.relax_column_count_less=!1}if("boolean"==typeof options.relax_column_count_more);else{if(void 0!==options.relax_column_count_more&&null!==options.relax_column_count_more)throw new Error(`Invalid Option: relax_column_count_more must be a boolean, got ${JSON.stringify(options.relax_column_count_more)}`);options.relax_column_count_more=!1}if("boolean"==typeof options.relax_quotes);else{if(void 0!==options.relax_quotes&&null!==options.relax_quotes)throw new Error(`Invalid Option: relax_quotes must be a boolean, got ${JSON.stringify(options.relax_quotes)}`);options.relax_quotes=!1}if("boolean"==typeof options.skip_empty_lines);else{if(void 0!==options.skip_empty_lines&&null!==options.skip_empty_lines)throw new Error(`Invalid Option: skip_empty_lines must be a boolean, got ${JSON.stringify(options.skip_empty_lines)}`);options.skip_empty_lines=!1}if("boolean"==typeof options.skip_records_with_empty_values);else{if(void 0!==options.skip_records_with_empty_values&&null!==options.skip_records_with_empty_values)throw new Error(`Invalid Option: skip_records_with_empty_values must be a boolean, got ${JSON.stringify(options.skip_records_with_empty_values)}`);options.skip_records_with_empty_values=!1}if("boolean"==typeof options.skip_records_with_error);else{if(void 0!==options.skip_records_with_error&&null!==options.skip_records_with_error)throw new Error(`Invalid Option: skip_records_with_error must be a boolean, got ${JSON.stringify(options.skip_records_with_error)}`);options.skip_records_with_error=!1}if(void 0===options.rtrim||null===options.rtrim||!1===options.rtrim)options.rtrim=!1;else if(!0!==options.rtrim)throw new Error(`Invalid Option: rtrim must be a boolean, got ${JSON.stringify(options.rtrim)}`);if(void 0===options.ltrim||null===options.ltrim||!1===options.ltrim)options.ltrim=!1;else if(!0!==options.ltrim)throw new Error(`Invalid Option: ltrim must be a boolean, got ${JSON.stringify(options.ltrim)}`);if(void 0===options.trim||null===options.trim||!1===options.trim)options.trim=!1;else if(!0!==options.trim)throw new Error(`Invalid Option: trim must be a boolean, got ${JSON.stringify(options.trim)}`);if(!0===options.trim&&!1!==opts.ltrim?options.ltrim=!0:!0!==options.ltrim&&(options.ltrim=!1),!0===options.trim&&!1!==opts.rtrim?options.rtrim=!0:!0!==options.rtrim&&(options.rtrim=!1),void 0===options.to||null===options.to)options.to=-1;else{if("string"==typeof options.to&&/\d+/.test(options.to)&&(options.to=parseInt(options.to)),!Number.isInteger(options.to))throw new Error(`Invalid Option: to must be an integer, got ${JSON.stringify(opts.to)}`);if(options.to<=0)throw new Error(`Invalid Option: to must be a positive integer greater than 0, got ${JSON.stringify(opts.to)}`)}if(void 0===options.to_line||null===options.to_line)options.to_line=-1;else{if("string"==typeof options.to_line&&/\d+/.test(options.to_line)&&(options.to_line=parseInt(options.to_line)),!Number.isInteger(options.to_line))throw new Error(`Invalid Option: to_line must be an integer, got ${JSON.stringify(opts.to_line)}`);if(options.to_line<=0)throw new Error(`Invalid Option: to_line must be a positive integer greater than 0, got ${JSON.stringify(opts.to_line)}`)}return options},isRecordEmpty=function(record){return record.every(field=>null==field||field.toString&&""===field.toString().trim())},boms={utf8:Buffer.from([239,187,191]),utf16le:Buffer.from([255,254])},parse$2=function(data,opts={}){"string"==typeof data&&(data=Buffer.from(data));const records=opts&&opts.objname?{}:[],parser=function(original_options={}){const options=normalize_options(original_options);return{info:{bytes:0,comment_lines:0,empty_lines:0,invalid_field_length:0,lines:1,records:0},original_options:original_options,options:options,state:init_state(options),__needMoreData:function(i,bufLen,end){if(end)return!1;const{encoding:encoding,escape:escape,quote:quote}=this.options,{quoting:quoting,needMoreDataSize:needMoreDataSize,recordDelimiterMaxLength:recordDelimiterMaxLength}=this.state;return bufLen-i-1<Math.max(needMoreDataSize,0===recordDelimiterMaxLength?Buffer.from("\r\n",encoding).length:recordDelimiterMaxLength,quoting?(null===escape?0:escape.length)+quote.length:0,quoting?quote.length+recordDelimiterMaxLength:0)},parse:function(nextBuf,end,push,close){const{bom:bom,comment_no_infix:comment_no_infix,encoding:encoding,from_line:from_line,ltrim:ltrim,max_record_size:max_record_size,raw:raw,relax_quotes:relax_quotes,rtrim:rtrim,skip_empty_lines:skip_empty_lines,to:to,to_line:to_line}=this.options;let{comment:comment,escape:escape,quote:quote,record_delimiter:record_delimiter}=this.options;const{bomSkipped:bomSkipped,previousBuf:previousBuf,rawBuffer:rawBuffer,escapeIsQuote:escapeIsQuote}=this.state;let buf;if(void 0===previousBuf){if(void 0===nextBuf)return void close();buf=nextBuf}else buf=void 0!==previousBuf&&void 0===nextBuf?previousBuf:Buffer.concat([previousBuf,nextBuf]);if(!1===bomSkipped)if(!1===bom)this.state.bomSkipped=!0;else if(buf.length<3){if(!1===end)return void(this.state.previousBuf=buf)}else{for(const encoding in boms)if(0===boms[encoding].compare(buf,0,boms[encoding].length)){const bomLength=boms[encoding].length;this.state.bufBytesStart+=bomLength,buf=buf.slice(bomLength),this.options=normalize_options({...this.original_options,encoding:encoding}),({comment:comment,escape:escape,quote:quote}=this.options);break}this.state.bomSkipped=!0}const bufLen=buf.length;let pos;for(pos=0;pos<bufLen&&!this.__needMoreData(pos,bufLen,end);pos++){if(!0===this.state.wasRowDelimiter&&(this.info.lines++,this.state.wasRowDelimiter=!1),-1!==to_line&&this.info.lines>to_line)return this.state.stop=!0,void close();!1===this.state.quoting&&0===record_delimiter.length&&this.__autoDiscoverRecordDelimiter(buf,pos)&&(record_delimiter=this.options.record_delimiter);const chr=buf[pos];if(!0===raw&&rawBuffer.append(chr),13!==chr&&10!==chr||!1!==this.state.wasRowDelimiter||(this.state.wasRowDelimiter=!0),!0===this.state.escaping)this.state.escaping=!1;else{if(null!==escape&&!0===this.state.quoting&&this.__isEscape(buf,pos,chr)&&pos+escape.length<bufLen){if(!escapeIsQuote){this.state.escaping=!0,pos+=escape.length-1;continue}if(this.__isQuote(buf,pos+escape.length)){this.state.escaping=!0,pos+=escape.length-1;continue}}if(!1===this.state.commenting&&this.__isQuote(buf,pos))if(!0===this.state.quoting){const nextChr=buf[pos+quote.length],isNextChrTrimable=rtrim&&this.__isCharTrimable(buf,pos+quote.length),isNextChrComment=null!==comment&&this.__compareBytes(comment,buf,pos+quote.length,nextChr),isNextChrDelimiter=this.__isDelimiter(buf,pos+quote.length,nextChr),isNextChrRecordDelimiter=0===record_delimiter.length?this.__autoDiscoverRecordDelimiter(buf,pos+quote.length):this.__isRecordDelimiter(nextChr,buf,pos+quote.length);if(null!==escape&&this.__isEscape(buf,pos,chr)&&this.__isQuote(buf,pos+escape.length))pos+=escape.length-1;else{if(!nextChr||isNextChrDelimiter||isNextChrRecordDelimiter||isNextChrComment||isNextChrTrimable){this.state.quoting=!1,this.state.wasQuoting=!0,pos+=quote.length-1;continue}if(!1===relax_quotes){const err=this.__error(new CsvError("CSV_INVALID_CLOSING_QUOTE",["Invalid Closing Quote:",`got "${String.fromCharCode(nextChr)}"`,`at line ${this.info.lines}`,"instead of delimiter, record delimiter, trimable character","(if activated) or comment"],this.options,this.__infoField()));if(void 0!==err)return err}else this.state.quoting=!1,this.state.wasQuoting=!0,this.state.field.prepend(quote),pos+=quote.length-1}}else{if(0===this.state.field.length){this.state.quoting=!0,pos+=quote.length-1;continue}if(!1===relax_quotes){const info=this.__infoField(),bom=Object.keys(boms).map(b=>!!boms[b].equals(this.state.field.toString())&&b).filter(Boolean)[0],err=this.__error(new CsvError("INVALID_OPENING_QUOTE",["Invalid Opening Quote:",`a quote is found on field ${JSON.stringify(info.column)} at line ${info.lines}, value is ${JSON.stringify(this.state.field.toString(encoding))}`,bom?`(${bom} bom)`:void 0],this.options,info,{field:this.state.field}));if(void 0!==err)return err}}if(!1===this.state.quoting){const recordDelimiterLength=this.__isRecordDelimiter(chr,buf,pos);if(0!==recordDelimiterLength){if(this.state.commenting&&!1===this.state.wasQuoting&&0===this.state.record.length&&0===this.state.field.length)this.info.comment_lines++;else{if(!1===this.state.enabled&&this.info.lines+(!0===this.state.wasRowDelimiter?1:0)>=from_line){this.state.enabled=!0,this.__resetField(),this.__resetRecord(),pos+=recordDelimiterLength-1;continue}if(!0===skip_empty_lines&&!1===this.state.wasQuoting&&0===this.state.record.length&&0===this.state.field.length){this.info.empty_lines++,pos+=recordDelimiterLength-1;continue}this.info.bytes=this.state.bufBytesStart+pos;const errField=this.__onField();if(void 0!==errField)return errField;this.info.bytes=this.state.bufBytesStart+pos+recordDelimiterLength;const errRecord=this.__onRecord(push);if(void 0!==errRecord)return errRecord;if(-1!==to&&this.info.records>=to)return this.state.stop=!0,void close()}this.state.commenting=!1,pos+=recordDelimiterLength-1;continue}if(this.state.commenting)continue;if(null!==comment&&(!1===comment_no_infix||0===this.state.record.length&&0===this.state.field.length)&&0!==this.__compareBytes(comment,buf,pos,chr)){this.state.commenting=!0;continue}const delimiterLength=this.__isDelimiter(buf,pos,chr);if(0!==delimiterLength){this.info.bytes=this.state.bufBytesStart+pos;const errField=this.__onField();if(void 0!==errField)return errField;pos+=delimiterLength-1;continue}}}if(!1===this.state.commenting&&0!==max_record_size&&this.state.record_length+this.state.field.length>max_record_size)return this.__error(new CsvError("CSV_MAX_RECORD_SIZE",["Max Record Size:","record exceed the maximum number of tolerated bytes",`of ${max_record_size}`,`at line ${this.info.lines}`],this.options,this.__infoField()));const lappend=!1===ltrim||!0===this.state.quoting||0!==this.state.field.length||!this.__isCharTrimable(buf,pos),rappend=!1===rtrim||!1===this.state.wasQuoting;if(!0!==lappend||!0!==rappend){if(!0!==rtrim||this.__isCharTrimable(buf,pos)){!1===lappend&&(pos+=this.__isCharTrimable(buf,pos)-1);continue}return this.__error(new CsvError("CSV_NON_TRIMABLE_CHAR_AFTER_CLOSING_QUOTE",["Invalid Closing Quote:","found non trimable byte after quote",`at line ${this.info.lines}`],this.options,this.__infoField()))}this.state.field.append(chr)}if(!0===end)if(!0===this.state.quoting){const err=this.__error(new CsvError("CSV_QUOTE_NOT_CLOSED",["Quote Not Closed:",`the parsing is finished with an opening quote at line ${this.info.lines}`],this.options,this.__infoField()));if(void 0!==err)return err}else if(!0===this.state.wasQuoting||0!==this.state.record.length||0!==this.state.field.length){this.info.bytes=this.state.bufBytesStart+pos;const errField=this.__onField();if(void 0!==errField)return errField;const errRecord=this.__onRecord(push);if(void 0!==errRecord)return errRecord}else!0===this.state.wasRowDelimiter?this.info.empty_lines++:!0===this.state.commenting&&this.info.comment_lines++;else this.state.bufBytesStart+=pos,this.state.previousBuf=buf.slice(pos);!0===this.state.wasRowDelimiter&&(this.info.lines++,this.state.wasRowDelimiter=!1)},__onRecord:function(push){const{columns:columns,group_columns_by_name:group_columns_by_name,encoding:encoding,info:info,from:from,relax_column_count:relax_column_count,relax_column_count_less:relax_column_count_less,relax_column_count_more:relax_column_count_more,raw:raw,skip_records_with_empty_values:skip_records_with_empty_values}=this.options,{enabled:enabled,record:record}=this.state;if(!1===enabled)return this.__resetRecord();const recordLength=record.length;if(!0===columns)return!0===skip_records_with_empty_values&&isRecordEmpty(record)?void this.__resetRecord():this.__firstLineToColumns(record);if(!1===columns&&0===this.info.records&&(this.state.expectedRecordLength=recordLength),recordLength!==this.state.expectedRecordLength){const err=!1===columns?new CsvError("CSV_RECORD_INCONSISTENT_FIELDS_LENGTH",["Invalid Record Length:",`expect ${this.state.expectedRecordLength},`,`got ${recordLength} on line ${this.info.lines}`],this.options,this.__infoField(),{record:record}):new CsvError("CSV_RECORD_INCONSISTENT_COLUMNS",["Invalid Record Length:",`columns length is ${columns.length},`,`got ${recordLength} on line ${this.info.lines}`],this.options,this.__infoField(),{record:record});if(!0===relax_column_count||!0===relax_column_count_less&&recordLength<this.state.expectedRecordLength||!0===relax_column_count_more&&recordLength>this.state.expectedRecordLength)this.info.invalid_field_length++,this.state.error=err;else{const finalErr=this.__error(err);if(finalErr)return finalErr}}if(!0===skip_records_with_empty_values&&isRecordEmpty(record))this.__resetRecord();else{if(!0===this.state.recordHasError)return this.__resetRecord(),void(this.state.recordHasError=!1);if(this.info.records++,1===from||this.info.records>=from){const{objname:objname}=this.options;if(!1!==columns){const obj={};for(let i=0,l=record.length;i<l;i++)void 0===columns[i]||columns[i].disabled||(!0===group_columns_by_name&&void 0!==obj[columns[i].name]?Array.isArray(obj[columns[i].name])?obj[columns[i].name]=obj[columns[i].name].concat(record[i]):obj[columns[i].name]=[obj[columns[i].name],record[i]]:obj[columns[i].name]=record[i]);if(!0===raw||!0===info){const extRecord=Object.assign({record:obj},!0===raw?{raw:this.state.rawBuffer.toString(encoding)}:{},!0===info?{info:this.__infoRecord()}:{}),err=this.__push(void 0===objname?extRecord:[obj[objname],extRecord],push);if(err)return err}else{const err=this.__push(void 0===objname?obj:[obj[objname],obj],push);if(err)return err}}else if(!0===raw||!0===info){const extRecord=Object.assign({record:record},!0===raw?{raw:this.state.rawBuffer.toString(encoding)}:{},!0===info?{info:this.__infoRecord()}:{}),err=this.__push(void 0===objname?extRecord:[record[objname],extRecord],push);if(err)return err}else{const err=this.__push(void 0===objname?record:[record[objname],record],push);if(err)return err}}this.__resetRecord()}},__firstLineToColumns:function(record){const{firstLineToHeaders:firstLineToHeaders}=this.state;try{const headers=void 0===firstLineToHeaders?record:firstLineToHeaders.call(null,record);if(!Array.isArray(headers))return this.__error(new CsvError("CSV_INVALID_COLUMN_MAPPING",["Invalid Column Mapping:","expect an array from column function,",`got ${JSON.stringify(headers)}`],this.options,this.__infoField(),{headers:headers}));const normalizedHeaders=normalize_columns_array(headers);return this.state.expectedRecordLength=normalizedHeaders.length,this.options.columns=normalizedHeaders,void this.__resetRecord()}catch(err){return err}},__resetRecord:function(){!0===this.options.raw&&this.state.rawBuffer.reset(),this.state.error=void 0,this.state.record=[],this.state.record_length=0},__onField:function(){const{cast:cast,encoding:encoding,rtrim:rtrim,max_record_size:max_record_size}=this.options,{enabled:enabled,wasQuoting:wasQuoting}=this.state;if(!1===enabled)return this.__resetField();let field=this.state.field.toString(encoding);if(!0===rtrim&&!1===wasQuoting&&(field=field.trimRight()),!0===cast){const[err,f]=this.__cast(field);if(void 0!==err)return err;field=f}this.state.record.push(field),0!==max_record_size&&"string"==typeof field&&(this.state.record_length+=field.length),this.__resetField()},__resetField:function(){this.state.field.reset(),this.state.wasQuoting=!1},__push:function(record,push){const{on_record:on_record}=this.options;if(void 0!==on_record){const info=this.__infoRecord();try{record=on_record.call(null,record,info)}catch(err){return err}if(null==record)return}push(record)},__cast:function(field){const{columns:columns,relax_column_count:relax_column_count}=this.options;if(!0===Array.isArray(columns)&&relax_column_count&&this.options.columns.length<=this.state.record.length)return[void 0,void 0];if(null!==this.state.castField)try{const info=this.__infoField();return[void 0,this.state.castField.call(null,field,info)]}catch(err){return[err]}if(this.__isFloat(field))return[void 0,parseFloat(field)];if(!1!==this.options.cast_date){const info=this.__infoField();return[void 0,this.options.cast_date.call(null,field,info)]}return[void 0,field]},__isCharTrimable:function(buf,pos){return((buf,pos)=>{const{timchars:timchars}=this.state;loop1:for(let i=0;i<timchars.length;i++){const timchar=timchars[i];for(let j=0;j<timchar.length;j++)if(timchar[j]!==buf[pos+j])continue loop1;return timchar.length}return 0})(buf,pos)},__isFloat:function(value){return value-parseFloat(value)+1>=0},__compareBytes:function(sourceBuf,targetBuf,targetPos,firstByte){if(sourceBuf[0]!==firstByte)return 0;const sourceLength=sourceBuf.length;for(let i=1;i<sourceLength;i++)if(sourceBuf[i]!==targetBuf[targetPos+i])return 0;return sourceLength},__isDelimiter:function(buf,pos,chr){const{delimiter:delimiter,ignore_last_delimiters:ignore_last_delimiters}=this.options;if(!0===ignore_last_delimiters&&this.state.record.length===this.options.columns.length-1)return 0;if(!1!==ignore_last_delimiters&&"number"==typeof ignore_last_delimiters&&this.state.record.length===ignore_last_delimiters-1)return 0;loop1:for(let i=0;i<delimiter.length;i++){const del=delimiter[i];if(del[0]===chr){for(let j=1;j<del.length;j++)if(del[j]!==buf[pos+j])continue loop1;return del.length}}return 0},__isRecordDelimiter:function(chr,buf,pos){const{record_delimiter:record_delimiter}=this.options,recordDelimiterLength=record_delimiter.length;loop1:for(let i=0;i<recordDelimiterLength;i++){const rd=record_delimiter[i],rdLength=rd.length;if(rd[0]===chr){for(let j=1;j<rdLength;j++)if(rd[j]!==buf[pos+j])continue loop1;return rd.length}}return 0},__isEscape:function(buf,pos,chr){const{escape:escape}=this.options;if(null===escape)return!1;const l=escape.length;if(escape[0]===chr){for(let i=0;i<l;i++)if(escape[i]!==buf[pos+i])return!1;return!0}return!1},__isQuote:function(buf,pos){const{quote:quote}=this.options;if(null===quote)return!1;const l=quote.length;for(let i=0;i<l;i++)if(quote[i]!==buf[pos+i])return!1;return!0},__autoDiscoverRecordDelimiter:function(buf,pos){const{encoding:encoding}=this.options,rds=[Buffer.from("\r\n",encoding),Buffer.from("\n",encoding),Buffer.from("\r",encoding)];loop:for(let i=0;i<rds.length;i++){const l=rds[i].length;for(let j=0;j<l;j++)if(rds[i][j]!==buf[pos+j])continue loop;return this.options.record_delimiter.push(rds[i]),this.state.recordDelimiterMaxLength=rds[i].length,rds[i].length}return 0},__error:function(msg){const{encoding:encoding,raw:raw,skip_records_with_error:skip_records_with_error}=this.options,err="string"==typeof msg?new Error(msg):msg;return skip_records_with_error?(this.state.recordHasError=!0,void(void 0!==this.options.on_skip&&this.options.on_skip(err,raw?this.state.rawBuffer.toString(encoding):void 0))):err},__infoDataSet:function(){return{...this.info,columns:this.options.columns}},__infoRecord:function(){const{columns:columns,raw:raw,encoding:encoding}=this.options;return{...this.__infoDataSet(),error:this.state.error,header:!0===columns,index:this.state.record.length,raw:raw?this.state.rawBuffer.toString(encoding):void 0}},__infoField:function(){const{columns:columns}=this.options,isColumns=Array.isArray(columns);return{...this.__infoRecord(),column:!0===isColumns?columns.length>this.state.record.length?columns[this.state.record.length].name:null:this.state.record.length,quoting:this.state.wasQuoting}}}}(opts),push=record=>{void 0===parser.options.objname?records.push(record):records[record[0]]=record[1]},close=()=>{},err1=parser.parse(data,!1,push,close);if(void 0!==err1)throw err1;const err2=parser.parse(void 0,!0,push,close);if(void 0!==err2)throw err2;return records};const number=/^\d*\.?\d+([eE][+-]?\d+)?$/;function convert$1(string){switch(string=string.trim()){case"true":return!0;case"false":return!1;case"none":return null}return number.test(string)?JSON.parse(string):string}class Table$1{constructor(data=im.OrderedMap()){checkType(data,"object"),data=new Map(data),this.width=0,this.size=void 0;for(const[column,values]of data)checkType(column,"string"),this.width++,"list"===getType(values)&&(this.size??=values.size,this.checkColumnLength(values));this.size??=this.width?1:0;for(const[column,values]of data)"list"!==getType(values)&&data.set(column,im.Repeat(values,this.size).toList());this.data=im.OrderedMap(data)}static fromCsv(source){return new Table$1(function(source){const rows=parse$2(source),columns=new Map;for(const key of rows[0])columns.set(key,[]);for(const row of rows.slice(1)){let index=0;for(const column of columns.values())column.push(convert$1(row[index])),index++}return im.OrderedMap(columns).map(im.List)}(source))}static fromRows(rows,columns){checkType(rows,"list"),checkType(columns,"list");const width=columns.size,data=new Map;for(const column of columns)checkType(column,"string"),data.set(column,[]);for(const row of rows){if("object"!==getType(row))throw new Panic$1("table rows must be objects");if(row.size!==width)throw new Panic$1("mismatched columns");for(const column of columns){if(!row.has(column))throw new Panic$1("mismatched columns");data.get(column).push(row.get(column))}}for(const column of columns)data.set(column,im.List(data.get(column)));return new Table$1(im.OrderedMap(data))}equals(other){return im.is(this.data,other.data)}hashCode(){return im.hash(this.data)}checkColumnLength(values){if(this.size&&values.size!==this.size)throw new Panic$1("mismatched column lengths");return values}checkColumns(...columns){for(const column of columns)if(checkType(column,"string"),!this.data.has(column))throw new Panic$1("column not found",{column:column})}checkColumnsMatch(matcher,exact=!0){if(exact&&matcher.size!==this.width)throw new Panic$1("mismatched keys");for(const column of matcher.keys())if(!this.data.has(column))throw new Panic$1("mismatched columns")}checkIndex(index){if(checkWhole(index),index<-this.size||index>=this.size)throw new Panic$1("index out of range");return index}checkNonEmpty(){if(0===this.size)throw new Panic$1("empty table");return this}get(selector){switch(checkType(selector,"string","number","object"),getType(selector)){case"string":return this.getColumn(selector);case"number":return this.getRow(selector);case"object":{const index=this.findMatch(selector);if(void 0===index)throw new Panic$1("no match found",{matcher:selector});return this.getRow(index)}}}set(selector,value){switch(checkType(selector,"string","number","object"),getType(selector)){case"string":return this.setColumn(selector,value);case"number":return this.setRow(selector,value);case"object":{const index=this.findMatch(selector);return value=selector.concat(value),void 0===index?this.addRow(value):this.setRow(index,value)}}}columns(){return this.data.keySeq().toList()}async map(func){checkType(func,"function");const rows=[];for(const row of this)rows.push(await func.call(row));return Table$1.fromRows(im.List(rows),this.columns())}async filter(func,args=[]){checkType(func,"function");const rows=[];for(const row of this)await func.callCondition(row,...args)&&rows.push(row);return Table$1.fromRows(im.List(rows),this.columns())}getRow(index){this.checkIndex(index);const map=new Map;for(const[column,values]of this.data)map.set(column,values.get(index));return im.OrderedMap(map)}addRow(row){checkType(row,"object"),this.checkColumnsMatch(row);const data=new Map;for(const[column,values]of this.data)data.set(column,values.push(row.get(column)));return new Table$1(im.OrderedMap(data))}setRow(index,row){this.checkIndex(index),checkType(row,"object"),this.checkColumnsMatch(row);const data=new Map;for(const[column,values]of this.data)data.set(column,values.set(index,row.get(column)));return new Table$1(im.OrderedMap(data))}getColumn(column){return this.checkColumns(column),this.data.get(column)}setColumn(column,values){return checkType(column,"string"),"list"!==getType(values)&&(values=im.Repeat(values,this.size).toList()),this.checkColumnLength(values),new Table$1(this.data.set(column,values))}select(columns){checkType(columns,"list");const data=new Map;for(const column of columns)this.checkColumns(column),data.set(column,this.data.get(column));return new Table$1(im.OrderedMap(data))}*[Symbol.iterator](){for(let index=0;index<this.size;index++)yield this.getRow(index)}*entries(){for(let index=0;index<this.size;index++)yield[index,this.getRow(index)]}has(selector){return checkType(selector,"object","string"),"string"===getType(selector)?this.data.has(selector):void 0!==this.findMatch(selector)}match(matcher){checkType(matcher,"object"),this.checkColumnsMatch(matcher,!1);const rows=[];for(const row of this)isMatch(row,matcher)&&rows.push(row);return Table$1.fromRows(im.List(rows),this.columns())}remove(matcher){checkType(matcher,"object"),this.checkColumnsMatch(matcher,!1);const rows=[];for(const row of this)isMatch(row,matcher)||rows.push(row);return Table$1.fromRows(im.List(rows),this.columns())}findMatch(matcher){checkType(matcher,"object"),this.checkColumnsMatch(matcher,!1);let index=0;for(const row of this){if(isMatch(row,matcher))return index;index++}}concat(other){checkType(other,"table"),this.checkColumnsMatch(other.data);const data=new Map(this.data);for(const[column,values]of data){const otherValues=other.data.get(column);data.set(column,values.concat(otherValues))}return new Table$1(im.OrderedMap(data))}static merge(tables){if(checkType(tables,"list"),tables.isEmpty())return new Table$1;let data=new Map;const first=tables.first();checkType(first,"table");for(const column of first.data.keys())data.set(column,[]);data=im.OrderedMap(data);for(const table of tables){checkType(table,"table"),table.checkColumnsMatch(data);for(const[column,values]of table.data)data.get(column).push(...values)}return new Table$1(data.map(im.List))}toString(){const fmts=new Map;for(const[column,values]of this.data)fmts.set(column,getFmt(column,values));const lines=[];function addLine(start,end,sep,pad,handler){const inner=[...fmts].map(([column,fmt])=>handler(column,fmt)).join(pad+sep+pad);lines.push([start,inner,end].join(pad))}addLine("┌","┐","┬","─",(_,{length:length})=>"─".repeat(length)),addLine("│",`│ x ${this.size}`,"│"," ",(column,fmt)=>format(column,fmt)),this.size>0&&addLine("├","┤","┼","─",(_,{length:length})=>"─".repeat(length));for(let i=0;i<this.size;i++)addLine("│","│","│"," ",(column,fmt)=>format(this.data.get(column).get(i),fmt));return addLine("└","┘","┴","─",(_,{length:length})=>"─".repeat(length)),lines.join("\n")}}const numeric=/^-?\.?[0-9]/,padded=/^\s|\s$/,escaped=/[\\"\n\r\t]/;function showValue(value){return"string"!==getType(value)||"none"===value||"true"===value||"false"===value||numeric.test(value)||padded.test(value)||escaped.test(value)||invisible.test(value)?repr(value,!0):value}function format(value,fmt={}){const{length:length=0}=fmt,{decimals:decimals=0}=fmt;return function(value,length,decimals){if("number"===getType(value)){let numStr=String(value);return decimals&&(numStr+=numStr%1?"0".repeat(decimals-decLength(numStr)):".0".padEnd(decimals,"0")),numStr.padStart(length)}return null===value?"":showValue(value)}(value,length,decimals).padEnd(length)}function decLength(numStr){return numStr.includes(".")?numStr.length-numStr.indexOf("."):0}function getFmt(column,values){let decimals=0;for(const value of values)"number"===getType(value)&&value%1&&(decimals=Math.max(decimals,decLength(String(value))));let length=format(column).length;for(const value of values)switch(getType(value)){case"number":{const numStr=String(value);length=Math.max(length,numStr.length+decimals-decLength(numStr));break}case"none":break;default:length=Math.max(length,showValue(value).length)}return{length:length,decimals:decimals}}class Func{constructor(handler,name,params){this.params=params,this.name=name,this.handler=handler}async call(...args){if(args.length!==this.params.length)throw new Panic$1("wrong number of arguments",{numArgs:args.length,func:this});return await this.handler(...args)}async callCondition(...args){const result=await this.call(...args),$got=getType(result);if("boolean"!==$got)throw new Panic$1("condition function must return boolean",{$got:$got});return result}toString(){return`${this.name}(${this.params.join(", ")})`}}class Ref$1{constructor(value){this.value=value}toString(){return`Ref.of(${repr(this.value)})`}}function getType(value){if(null===value)return"none";switch(value?.constructor){case Boolean:return"boolean";case Number:return"number";case String:return"string";case Table$1:return"table";case Func:return"function";case Ref$1:return"reference"}return im.isOrderedMap(value)?"object":im.isOrderedSet(value)?"set":im.isList(value)?"list":(console.error("native value: ",value),`<native ${value?.constructor?.name}>`)}function checkType(value,...types){const $got=getType(value);if(!$got)throw new Panic$1("invalid native value",{value:value});if(types.length&&!types.includes($got))throw new Panic$1("type error",{$expected:types.join(" or "),$got:$got});return value}function compareAll(a,b,desc){for(let index=0;index<a.size;index++){const result=compare(a.get(index),b.get(index),desc);if(0!=result)return result}return 0}function compare(a,b,desc){checkType(a,"number","string","boolean","none"),checkType(b,"number","string","boolean","none");const typeA=getType(a),typeB=getType(b);if("none"===typeA)return 1;if("none"===typeB)return-1;if(typeA!==typeB)throw new Panic$1("cannot compare values of different types",{typeA:typeA,typeB:typeB});return a<b?desc?1:-1:a>b?desc?-1:1:0}const plainKey=/^[a-zA-Z][a-zA-Z0-9]*$/,invisible=/(?! )[\p{C}\p{Z}]/gu;function escapeInvisible(char){return`\\u{${char.codePointAt(0).toString(16)}}`}function show(value,compact=!1){return"string"===getType(value)?value:repr(value,compact)}function repr(value,compact=!1){switch(getType(value)){case"boolean":case"number":if(Number.isNaN(value))return"Math.nan";switch(value){case 1/0:return"Math.inf";case-1/0:return"-Math.inf"}return value.toString();case"none":return"none";case"string":return`"${value.replaceAll("\\","\\\\").replaceAll('"','\\"').replaceAll("\n","\\n").replaceAll("\r","\\r").replaceAll("\t","\\t").replaceAll(invisible,escapeInvisible)}"`;case"list":return formatElems("[","]",[...value].map(elem=>repr(elem,compact)),compact);case"set":return formatElems("Set.of([","])",[...value].map(elem=>repr(elem,compact)),compact);case"object":{const entryStrs=[],isRecord=value.keySeq().every(key=>"string"===getType(key)&&plainKey.test(key));for(const[key,val]of value){let valStr=repr(val,compact);if(valStr.includes("\n"))switch(getType(val)){case"list":case"object":valStr=" "+valStr;break;default:valStr=indent$1("\n"+valStr)}else valStr=" "+valStr;if(isRecord)entryStrs.push(`${key}:${valStr}`);else switch(getType(key)){case"none":case"boolean":entryStrs.push(`(${repr(key,compact)}):${valStr}`);break;default:entryStrs.push(`${repr(key,compact)}:${valStr}`)}}return formatElems("{ "," }",entryStrs,compact)}case"table":if(compact){return`Table.of([${[...value].map(row=>repr(row,!0)).join(", ")}])`}return String(value);default:return String(value)}}function indent$1(string){return string.split("\n").map(line=>`  ${line}`).join("\n")}function formatElems(start,end,strings,compact){if(0===strings.length)return start.trim()+end.trim();if(compact||function(strings){return strings.map(s=>s.length).reduce((a,b)=>a+b,0)}(strings)<70)return`${start}${strings.join(", ")}${end}`;const elems=strings.map(line=>`${indent$1(line)},`).join("\n");return`${start.trim()}\n${elems}\n${end.trim()}`}class Panic$1 extends Error{constructor(message,details={},loc=void 0){super(message),this.details={$panic:this.message,...details},this.trace=[{loc:loc}]}setLoc(loc){return this.trace.at(-1).loc??=loc,this}pushContext(context){return this.trace.at(-1).context=context,this.trace.push({}),this}showTrace(){let lastLoc,result="";for(const{context:context,loc:loc}of this.trace)loc&&!lastLoc?.sameLine(loc)&&(result+=`\n\n${loc.show(context)}`,lastLoc=loc);return result}toString(){return Object.entries(this.details).map(showDetail).join("\n")+this.showTrace()}}function showDetail([key,value]){return key.startsWith("$")?`${key.slice(1)}: ${value}`:`${key}: ${repr(value)}`}const keywords=["and","arg","case","do","elif","else","end","false","fn","for","if","import","in","match","none","not","or","return","then","true","while"],skip=["whitespace","newline","comment"],identifier=["name",...keywords],def=["=","|=","$=","?=","+=","-=","*=","/=","**=","%="],ops=[["or"],["and"],["in","==","!=","<","<=",">",">="],["+","-"],["*","/","%"]],escapeSeq=/\\["\\nrt]|\\u{([\dA-Fa-f]{1,6})}/g,stringInner=/^r?#*"([\s\S]*)"#*$/,indent=/^[ ]*/,fmtVar=/\$(?:[_a-zA-Z]\w*(?:\.[_a-zA-Z]\w*)*|\([_a-zA-Z]\w*(?:\.[_a-zA-Z]\w*)*\))/g;function parseStr(string,loc){return string.replaceAll(escapeSeq,(match,code,index)=>{switch(match){case"\\\\":return"\\";case'\\"':return'"';case"\\n":return"\n";case"\\r":return"\r";case"\\t":return"\t"}try{return String.fromCodePoint(parseInt(code,16))}catch(_){throw loc=loc.next('"'+string.slice(0,index)+"\\u{"),new Panic$1("invaild code point",{$code:`'${code}'`},loc)}})}class Node{constructor(type,loc,value){this.type=type,this.loc=loc,this.value=value}}function unexpectedToken(token,details={}){if("endOfFile"===token.type)throw new Panic$1("unexpected end-of-file",{},token.loc);return new Panic$1("unexpected token",{$token:token.value,...details},token.loc)}function parse$1(tokens){tokens.forEach(token=>token.validate());const parser=new Parser(tokens),statements=parser.getStatements(!0);return parser.get("endOfFile"),statements}class Parser{index=0;fnDepth=0;implicits=[];locals=[];constructor(tokens){this.tokens=tokens}*upcomingTokens(){for(let index=this.index;index<this.tokens.length;index++)yield this.tokens[index]}has(...types){for(const token of this.upcomingTokens()){if(token.matches(...types))return!0;if(!token.matches(...skip))break}return!1}hasMulti(...types){for(const token of this.upcomingTokens()){if(!types.length)return!0;if(token.matches(types[0]))types.shift();else if(!token.matches(...skip))return!1}return!1}get(...types){for(const token of this.upcomingTokens()){if(this.index++,token.matches(...types))return token;if(!token.matches(...skip))throw unexpectedToken(token,1===types.length?{$expected:types[0]}:{})}}peek(){for(const token of this.upcomingTokens())if(!token.matches(...skip))return token}updateImplicit(name,loc){if("arg"===name){if(!this.implicits.length)throw new Panic$1("pipeline placeholder cannot be used here",{},loc);this.implicits[this.implicits.length-1]??=loc}}addLocal(name){this.locals.at(-1)?.add(name)}seq(start,end,sep,handler){const elems=[];for(this.get(start);!this.has(end);)elems.push(handler.call(this)),this.has(end)||this.get(sep);return this.get(end),elems}getName(){const{value:value,loc:loc}=this.get("name","arg");return this.updateImplicit(value,loc),new Node("name",loc,value)}getNumber(){const{value:value,loc:loc}=this.get("number"),n=checkNumResult(Number(value));return new Node("number",loc,n)}getNone(){const{loc:loc}=this.get("none");return new Node("none",loc,null)}getBool(){const{value:value,loc:loc}=this.get("true","false");return new Node("bool",loc,"true"===value)}getStringInner(string){return string.match(stringInner)[1]}getAligned(value){if(!(value=this.getStringInner(value)).includes("\n"))return value;const lines=value.split(/\r?\n/);let minIndent=lines.at(-1).match(indent)[0].length;""===lines[0].trim()&&lines.shift(),""===lines.at(-1).trim()&&lines.pop();for(const line of lines){const newIndent=line.match(indent)[0].length;newIndent<line.length&&(minIndent=Math.min(minIndent,newIndent))}return lines.map(line=>line.slice(minIndent).trimEnd()).join("\n")}getFmt(value,loc){const rawFragments=value.split(fmtVar),fmtVars=value.match(fmtVar),fragments=[],fmtNodes=[];let innerLoc=loc.next('"');for(const[index,varStr]of fmtVars.entries()){fragments.push(parseStr(rawFragments[index],innerLoc));const varSegments=(varStr.startsWith("$(")?varStr.slice(2,-1):varStr.slice(1)).split("."),name=varSegments[0];innerLoc=innerLoc.next(rawFragments[index],"$"),this.updateImplicit(name,innerLoc);let fmtNode=new Node("name",innerLoc,name);innerLoc=innerLoc.next(name);for(const segment of varSegments.slice(1))fmtNode=new Node("access",innerLoc,{lhs:fmtNode,rhs:new Node("string",innerLoc,segment)}),innerLoc=innerLoc.next(".",segment);fmtNodes.push(fmtNode)}return fragments.push(parseStr(rawFragments.at(-1),innerLoc)),new Node("fmtString",loc,{fragments:fragments,fmtNodes:fmtNodes})}getString(){const{value:value,loc:loc}=this.get("string"),aligned=this.getAligned(value);return fmtVar.test(aligned)?this.getFmt(aligned,loc):new Node("string",loc,parseStr(aligned,loc))}getRawString(){const{value:value,loc:loc}=this.get("rawString"),aligned=this.getAligned(value);return new Node("string",loc,aligned)}getList(){const{loc:loc}=this.peek(),elems=this.seq("[","]",",",this.getExpression);return new Node("list",loc,elems)}getEntry(){if(this.has(...identifier)){const{value:name,loc:loc}=this.get(...identifier),key=new Node("string",loc,name);return this.has(",","}")?{key:key,value:new Node("name",loc,name)}:(this.get(":"),{key:key,value:this.getExpression()})}const key=this.getExpression();this.get(":");return{key:key,value:this.getExpression()}}getObject(){const{loc:loc}=this.peek(),entries=this.seq("{","}",",",this.getEntry);return new Node("object",loc,entries)}getParens(){this.get("(");const expression=this.getExpression();return this.get(")"),expression}getBase(){const token=this.peek();switch(token.type){case"arg":case"name":return this.getName();case"number":return this.getNumber();case"string":return this.getString();case"rawString":return this.getRawString();case"true":case"false":return this.getBool();case"none":return this.getNone();case"[":return this.getList();case"{":return this.getObject();case"(":return this.getParens();default:throw unexpectedToken(token)}}getSuffix(){let lhs=this.getBase();for(;this.has("field","[","(")&&!this.has(...skip);){const{type:type,loc:loc}=this.peek();switch(type){case"field":{const key=this.get("field").value.slice(1),rhs=new Node("string",loc,key);lhs=new Node("access",loc,{lhs:lhs,rhs:rhs});break}case"[":{this.get("[");const rhs=this.getExpression();this.get("]"),lhs=new Node("access",loc,{lhs:lhs,rhs:rhs});break}case"(":{const args=this.seq("(",")",",",this.getExpression);lhs=new Node("call",loc,{args:args,func:lhs});break}}}return lhs}getFnDef(){const{loc:loc}=this.get("fn"),name=this.get("name").value,rhs=new Node("fn",loc,{name:name,...this.getFnInner()});return new Node("def",loc,{name:name,keys:[],isCompound:!1,rhs:rhs})}getReturn(){const{loc:loc}=this.get("return");if(!this.fnDepth)throw new Panic$1("Cannot use `return` outside of function",loc);const value=this.has("elif","else","end")?new Node("none",loc,null):this.getExpression();return new Node("return",loc,value)}getRangeBody(){const range=this.getExpression();this.get("do");const body=this.getStatements();return this.get("end"),{range:range,body:body}}getFor(){const{loc:loc}=this.get("for");if(this.hasMulti("name","in")){const name=this.get("name").value;return this.addLocal(name),this.get("in"),new Node("for",loc,{name:name,...this.getRangeBody()})}if(this.hasMulti("name",",")){const keyName=this.get("name").value;this.addLocal(keyName),this.get(",");const valName=this.get("name").value;return this.addLocal(valName),this.get("in"),new Node("tandemFor",loc,{keyName:keyName,valName:valName,...this.getRangeBody()})}return new Node("anonFor",loc,this.getRangeBody())}getWhile(){const{loc:loc}=this.get("while"),cond=this.getExpression();this.get("do");const body=this.getStatements();return this.get("end"),new Node("while",loc,{cond:cond,body:body})}unrollKeys(node){const keys=[];for(;"access"===node.type;)keys.push(node.value.rhs),node=node.value.lhs;return keys.reverse(),{base:node,keys:keys}}getAssign(symbols){const{value:value,loc:loc}=this.get(...symbols);let op=value;switch(op.length>1&&op.endsWith("=")&&(op=op.slice(0,-1)),op){case"|":case"$":case"?":return{loc:loc,rhs:this.getChain(new Node("prev",loc),this.getExpression,{value:op,loc:loc}),isCompound:!0}}if("="!==op){return{loc:loc,rhs:new Node("binaryOp",loc,{op:op,lhs:new Node("prev",loc),rhs:this.getExpression()}),isCompound:!0}}return{loc:loc,rhs:this.getExpression(),isCompound:!1}}getDef(){const lhs=this.getExpression();if(this.has(...def)){const{base:base,keys:keys}=this.unrollKeys(lhs);if("name"!==base.type)throw new Panic$1("assignment target must be a variable name",{},base.loc);const name=base.value;this.addLocal(name);const{loc:loc,isCompound:isCompound,rhs:rhs}=this.getAssign(def);return new Node("def",loc,{name:name,keys:keys,isCompound:isCompound,rhs:rhs})}return lhs}getStatement(topLevel=!1){if(this.hasMulti("fn","name")){const fnDef=this.getFnDef();if(!topLevel){const{name:name,rhs:rhs}=fnDef.value,paramStr=rhs.value.params.join(", ");throw new Panic$1("function declarations can only occur at top level",{$solution:`use anon function syntax here instead: ${name} = fn(${paramStr}) ... end`},fnDef.loc)}return fnDef}const{type:type}=this.peek();switch(type){case"return":return this.getReturn();case"for":return this.getFor();case"while":return this.getWhile()}return this.getDef()}getFnInner(){const params=this.seq("(",")",",",()=>this.get("name").value);this.fnDepth++,this.locals.push(new Set);const body=this.getStatements(),locals=this.locals.pop();return this.fnDepth--,this.get("end"),{params:params,body:body,locals:locals}}getStatements(topLevel=!1){const statements=[];for(;!this.has("case","elif","else","end","endOfFile","do");)statements.length&&this.get("newline",";"),statements.push(this.getStatement(topLevel));return statements}getFn(){const{loc:loc}=this.get("fn");return new Node("fn",loc,{name:"fn",...this.getFnInner()})}getBranch(){const cond=this.getExpression();this.get("then");return{cond:cond,body:this.getStatements()}}getIf(){const{loc:loc}=this.get("if"),branches=[this.getBranch()];for(;this.has("elif");)this.get("elif"),branches.push(this.getBranch());let fallback;return this.has("else")&&(this.get("else"),fallback=this.getStatements()),this.get("end"),new Node("if",loc,{branches:branches,fallback:fallback})}getMatch(){const{loc:loc}=this.get("match"),cond=this.getExpression(),cases=[];for(;this.has("case");){const patterns=this.seq("case","then",",",this.getExpression),body=this.getStatements();cases.push({patterns:patterns,body:body})}let fallback;return this.has("else")&&(this.get("else"),fallback=this.getStatements()),this.get("end"),new Node("match",loc,{cond:cond,cases:cases,fallback:fallback})}getImport(){const{loc:loc}=this.get("import"),path=this.get("string").value.slice(1,-1);return new Node("import",loc,path)}getUnary(){if(this.has("-","not")){const{type:type,loc:loc}=this.get("-","not"),rhs=this.getSuffix();return new Node("unaryOp",loc,{op:type,rhs:rhs})}return this.getSuffix()}getPrefix(){switch(this.peek().type){case"fn":return this.getFn();case"if":return this.getIf();case"match":return this.getMatch();case"import":return this.getImport();default:return this.getUnary()}}getPow(){const hasParen=this.has("(");let lhs=this.getPrefix();for(;this.has("**");){const{loc:loc}=this.get("**"),rhs=this.getPow();if("-"===lhs.value.op&&!hasParen)throw new Panic$1("exponentiation of negated operand requires parentheses",{},lhs.loc);lhs=new Node("binaryOp",loc,{op:"**",lhs:lhs,rhs:rhs})}return lhs}getLeftAssoc(precedence=0){if(precedence===ops.length)return this.getPow();let lhs=this.getLeftAssoc(precedence+1);const types=ops[precedence];for(;this.has(...types)&&(!this.has("-")||this.hasMulti("-","whitespace")||this.hasMulti("-","newline"));){const{type:op,loc:loc}=this.get(...types),rhs=this.getLeftAssoc(precedence+1);lhs=new Node("binaryOp",loc,{op:op,lhs:lhs,rhs:rhs})}return lhs}getChain(lhs,handler,op){const nodeType={"|":"pipe",$:"map","?":"filter"}[op.value];this.implicits.push(void 0);const result=handler.call(this),loc=this.implicits.pop(),rhs=loc?new Node("fn",loc,{name:"fn",params:["arg"],body:[result],locals:new Set}):result;return"call"===rhs.type?new Node(nodeType,op.loc,{lhs:lhs,args:rhs.value.args,func:rhs.value.func}):new Node(nodeType,op.loc,{lhs:lhs,args:[],func:rhs})}getExpression(){let lhs=this.getLeftAssoc();for(;this.has("|","$","?");){const op=this.get("|","$","?");lhs=this.getChain(lhs,this.getLeftAssoc,op)}return lhs}}class Loc{constructor(line,column,path,getSource){this.line=line,this.column=column,this.path=path,this.getSource=getSource}show(context){return`${this.getSource().split("\n")[this.line-1]}\n${" ".repeat(this.column-1)+"^"}\nAt ${this.path?`${this.path}:${this.line}:${this.column}`:`${this.line}:${this.column}`}${context=context?` in ${context}`:""}`}next(...values){let{line:line,column:column}=this;for(const value of values)if(value.includes("\n")){const lines=value.split("\n");line+=lines.length-1,column=lines.at(-1).length+1}else column+=value.length;return new Loc(line,column,this.path,this.getSource)}sameLine(other){return this.line===other.line&&this.path===other.path}}function rule(name,pattern){return{name:name,pattern:new RegExp(pattern.source,"y")}}const keywordRules=keywords.map(kwd=>rule(kwd,new RegExp(kwd+"\\b"))),symbolRules=["}","|=","|","{","]","[","?=","?",">=",">","==","=","<=","<",";",":","/=","/","-=","-",",","+=","+","*=","**=","**","*",")","(","%=","%","$=","$","!="].sort().reverse().map(sym=>rule(sym,new RegExp(function(chars){return chars.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}(sym)))),rules=[...keywordRules,rule("field",/\.[a-zA-Z][a-zA-Z0-9]*/),rule("newline",/\r?\n/),rule("number",/\d*\.?\d+([eE][+-]?\d+)?/),rule("string",/"(\\.|[^\\])*?"/),rule("rawString",/r(#*)"[^]*?"\1/),rule("unmatchedQuote",/(r#*)?"/),rule("whitespace",/[ \t]+/),rule("name",/[a-zA-Z][a-zA-Z0-9]*/),rule("comment",/--.*/),...symbolRules,rule("unexpectedCharacter",/./)],invalidEscape=/(?:^|[^\\])(?:\\\\)*(\\([^\\"nrtu]|u(?!{[0-9a-fA-F]{1,6}})))/;class Token{constructor(type,loc,value){this.type=type,this.loc=loc,this.value=value}matches(...types){return types.includes(this.type)}validate(){switch(this.type){case"unmatchedQuote":throw new Panic$1("unmatched quote",{},this.loc);case"unexpectedCharacter":throw new Panic$1("unexpected character",{character:this.value},this.loc);case"string":{const match=this.value.match(invalidEscape);if(match){const prefix=this.value.slice(0,match.index+match[0].length-1),loc=this.loc.next(prefix);if("\\u"==match[1])throw new Panic$1("invalid unicode escape sequence",{$expected:"'\\u{...}' where '...' is a sequence of between 1 and 6 hex digits"},loc);throw new Panic$1("invalid escape sequence",{$escape:`'${match[1]}'`},loc)}}}}}function tokenize(path,source){source=source.trimEnd();const tokens=[];let index=0,loc=new Loc(1,1,path,()=>source);for(;index<source.length;)for(const{name:name,pattern:pattern}of rules){pattern.lastIndex=index;const value=pattern.exec(source)?.[0];if(void 0!==value){index+=value.length,tokens.push(new Token(name,loc,value)),loc=loc.next(value);break}}return tokens.push(new Token("endOfFile",loc,"")),tokens}function convert(jsonVal){if(Array.isArray(jsonVal))return im.List(jsonVal.map(convert));if("object"==typeof jsonVal){const map=new Map;for(const[key,value]of Object.entries(jsonVal))map.set(key,convert(value));return im.OrderedMap(map)}return jsonVal}function checkIndex(list,index){if(checkType(list,"list"),"number"!==getType(index))throw new Panic$1("list requires numerical index");if(checkWhole(index),index<-list.size||index>=list.size)throw new Panic$1("list index out of range",{index:index,length:list.size});return index}function checkNonEmpty(list){if(checkType(list,"list"),0===list.size)throw new Panic$1("empty list");return list}class Returner{constructor(value){this.value=value}}class Env{constructor(parent,defs,locals=new Set){this.parent=parent,this.defs=defs,this.locals=locals,this.prev=[],this.blameLocs=[]}spawn(defs=new Map,locals=new Set){return new Env(this,defs,locals)}snapshot(){const allDefs=[];let env=this;for(;env;)allDefs.push(env.defs),env=env.parent;const entries=allDefs.toReversed().map(defs=>[...defs]).flat();return new Env(void 0,new Map(entries))}setBlame(loc){this.blameLocs[this.blameLocs.length-1]=loc}async evalLoc(nodes,loc,...types){nodes instanceof Array||(nodes=[nodes]);let result=null;for(const[index,node]of nodes.entries())try{this.blameLocs.push(null),result=await this.dispatch(node),index===nodes.length-1&&checkType(result,...types)}catch(err){throw err instanceof Panic$1&&err.setLoc(this.blameLocs.at(-1)??loc??node.loc),err}finally{this.blameLocs.pop()}return result}async eval(nodes,...types){return await this.evalLoc(nodes,void 0,...types)}async evalEach(nodes){const results=[];for(const node of nodes)results.push(await this.eval(node));return results}setDef(name,value){this.defs.set(name,value)}lookup(name){let env=this;for(;env;){if(env.defs.has(name))return env.defs.get(name);if(env.locals.has(name))throw new Panic$1("variable has not been defined yet",{$name:name});env=env.parent}throw new Panic$1("variable is not defined",{$name:name})}async dispatch(node){switch(node.type){case"bool":case"none":case"number":case"string":return node.value;case"fmtString":return this.evalFmtString(node);case"unaryOp":return this.evalUnaryOp(node);case"binaryOp":return this.evalBinaryOp(node);case"name":return await this.lookup(node.value);case"def":return this.evalDef(node);case"prev":return this.prev.at(-1);case"call":return this.evalCall(node);case"pipe":return this.evalPipe(node);case"map":return this.evalMap(node);case"filter":return this.evalFilter(node);case"fn":return this.evalFn(node);case"return":throw new Returner(await this.eval(node.value));case"if":return this.evalIf(node);case"match":return this.evalMatch(node);case"for":return this.evalFor(node);case"tandemFor":return this.evalTandemFor(node);case"anonFor":return this.evalAnonFor(node);case"while":return this.evalWhile(node);case"list":return im.List(await this.evalEach(node.value));case"set":return im.OrderedSet(await this.evalEach(node.value));case"object":return this.evalObject(node);case"access":return this.evalAccess(node);case"import":return await getImport(dirname(node.loc.path),node.value);default:throw new Error("node.type: "+node.type)}}async evalFmtString(node){const{fragments:fragments,fmtNodes:fmtNodes}=node.value;let result=fragments[0];for(const[index,fragment]of fragments.slice(1).entries()){result+=show(await this.eval(fmtNodes[index]))+fragment}return result}async evalUnaryOp(node){const{op:op,rhs:rhs}=node.value,value=await this.eval(rhs);switch(op){case"-":return-checkType(value,"number");case"not":return!checkType(value,"boolean");default:throw new Error("op: "+op)}}async evalBinaryOp(node){const{op:op,lhs:lhs,rhs:rhs}=node.value;switch(op){case"and":return await this.eval(lhs,"boolean")&&await this.eval(rhs,"boolean");case"or":return await this.eval(lhs,"boolean")||await this.eval(rhs,"boolean")}const a=await this.eval(lhs),b=await this.eval(rhs);switch(op){case"==":return im.is(a,b);case"!=":return!im.is(a,b);case"in":switch(checkType(b,"list","set","object","string","table"),getType(b)){case"list":return b.includes(a);case"set":case"object":case"table":return b.has(a);case"string":return checkType(a,"string"),b.includes(a)}break;case"+":{const typeA=getType(a);switch(checkType(b,typeA),typeA){case"string":return a+b;case"list":case"object":case"set":case"table":return a.concat(b)}break}case"*":switch(getType(a)){case"number":if("string"===getType(b))return checkType(a,"number"),checkWhole(a),b.repeat(Math.max(0,a));break;case"string":return checkType(b,"number"),checkWhole(b),a.repeat(Math.max(0,b));case"list":return checkType(b,"number"),checkWhole(b),im.List(im.Repeat(a,b)).flatten(!0)}break;case"<":case"<=":case">":case">=":if("string"===getType(a))switch(checkType(b,"string"),op){case"<":return a<b;case"<=":return a<=b;case">":return a>b;case">=":return a>=b}}switch(checkType(a,"number"),checkType(b,"number"),op){case"+":return checkNumResult(a+b,a,b);case"-":return checkNumResult(a-b,a,b);case"*":return checkNumResult(a*b,a,b);case"/":return checkNumResult(a/b,a,b);case"**":return checkNumResult(a**b,a,b);case"%":return checkNumResult((a%b+b)%b,a,b);case"<":return a<b;case"<=":return a<=b;case">":return a>b;case">=":return a>=b;default:throw new Error("op: "+op)}}async sliceKeys(keys){return{key:await this.eval(keys[0]),newKeys:keys.slice(1)}}async updateList(list,keys,isCompound,rhs){const{key:key,newKeys:newKeys}=await this.sliceKeys(keys);checkIndex(list,key);const child=list.get(key),updated=await this.update(child,newKeys,isCompound,rhs);return list.set(key,updated)}async updateObject(object,keys,isCompound,rhs){const{key:key,newKeys:newKeys}=await this.sliceKeys(keys);(newKeys.length||isCompound)&&checkKey(object,key);const child=object.get(key),updated=await this.update(child,newKeys,isCompound,rhs);return object.set(key,updated)}async updateTable(table,keys,isCompound,rhs){const{key:key,newKeys:newKeys}=await this.sliceKeys(keys);let child;checkType(key,"number","string","object"),(newKeys.length||isCompound)&&(child=table.get(key));const updated=await this.update(child,newKeys,isCompound,rhs);return this.setBlame(rhs.loc),table.set(key,updated)}async update(container,keys,isCompound,rhs){if(!keys.length){this.prev.push(container);const result=await this.eval(rhs);return this.prev.pop(),result}switch(checkType(container,"list","object","table"),this.setBlame(keys[0].loc),getType(container)){case"list":return this.updateList(container,keys,isCompound,rhs);case"object":return this.updateObject(container,keys,isCompound,rhs);case"table":return this.updateTable(container,keys,isCompound,rhs)}}async evalDef(node){const{name:name,keys:keys,isCompound:isCompound,rhs:rhs}=node.value;if(keys.length){const container=await this.lookup(name);this.setDef(name,await this.update(container,keys,isCompound,rhs))}else this.prev.push(isCompound?await this.lookup(name):void 0),this.setDef(name,await this.eval(rhs)),this.prev.pop();return null}async evalCall(node){const{func:funcNode,args:argNodes}=node.value,func=await this.eval(funcNode,"function"),args=await this.evalEach(argNodes);return await func.call(...args)}async evalPipe(node){const{lhs:lhsNode,args:argNodes,func:funcNode}=node.value,lhs=await this.eval(lhsNode),func=await this.eval(funcNode,"function"),args=await this.evalEach(argNodes);return await func.call(lhs,...args)}async evalMap(node){const{lhs:lhs,args:argNodes,func:funcNode}=node.value,iter=await this.evalLoc(lhs,node.loc,"list","table"),args=await this.evalEach(argNodes),func=await this.eval(funcNode,"function"),elems=[];for(const elem of iter)this.setBlame(funcNode.loc),elems.push(await func.call(elem,...args));return im.List(elems)}async evalFilter(node){const{lhs:lhs,args:argNodes,func:funcNode}=node.value,iter=await this.evalLoc(lhs,node.loc,"list","table");if(!iter.size)return iter;const args=await this.evalEach(argNodes),func=await this.eval(funcNode,"function");if("table"===getType(iter))return await iter.filter(func,args);const elems=[];for(const elem of iter)this.setBlame(funcNode.loc),await func.callCondition(elem,...args)&&elems.push(elem);return im.List(elems)}evalFn(node){const{name:name,params:params,body:body,locals:locals}=node.value,parent="fn"===name?this.snapshot():this,fn=new Func(async(...args)=>{const defs=new Map(params.map((param,index)=>[param,args[index]])),env=parent.spawn(defs,locals);try{return await env.eval(body)}catch(err){if(err instanceof Returner)return err.value;throw err.pushContext?.(context),err}},name,params),context=String(fn);return fn}async evalIf(node){const{branches:branches,fallback:fallback}=node.value;for(const{cond:cond,body:body}of branches)if(await this.eval(cond,"boolean"))return await this.eval(body);return fallback?await this.eval(fallback):null}async evalMatch(node){const{cond:condNode,cases:cases,fallback:fallback}=node.value,cond=await this.eval(condNode);for(const{patterns:patterns,body:body}of cases)for(const patternNode of patterns){const pattern=await this.eval(patternNode);if(im.is(pattern,cond))return await this.eval(body)}return fallback?await this.eval(fallback):null}async evalFor(node){const{name:name,range:rangeNode,body:body}=node.value,range=await this.eval(rangeNode,"list","table","object","set");if("object"===getType(range))for(const key of range.keys())this.setDef(name,key),await this.eval(body);else for(const value of range)this.setDef(name,value),await this.eval(body);return null}async evalTandemFor(node){const{keyName:keyName,valName:valName,range:rangeNode,body:body}=node.value,range=await this.eval(rangeNode,"list","object","table");if("object"===getType(range))for(const[key,value]of range)this.setDef(keyName,key),this.setDef(valName,value),await this.eval(body);else for(const[index,value]of range.entries())this.setDef(keyName,index),this.setDef(valName,value),await this.eval(body);return null}async evalAnonFor(node){const{range:rangeNode,body:body}=node.value,range=await this.eval(rangeNode,"number");this.setBlame(rangeNode.loc),checkWhole(range);for(let n=0;n<range;n++)await this.eval(body);return null}async evalWhile(node){const{cond:cond,body:body}=node.value;for(;await this.eval(cond,"boolean");)await this.eval(body);return null}async evalObject(node){const map=new Map;for(const{key:keyNode,value:valueNode}of node.value){const key=await this.eval(keyNode);map.set(key,await this.eval(valueNode))}return im.OrderedMap(map)}async evalAccess(node){const{lhs:lhsNode,rhs:rhsNode}=node.value,lhs=await this.eval(lhsNode,"list","object","table"),rhs=await this.eval(rhsNode);switch(getType(lhs)){case"list":return this.setBlame(rhsNode.loc),checkIndex(lhs,rhs),lhs.get(rhs);case"object":return this.setBlame(rhsNode.loc),checkKey(lhs,rhs),lhs.get(rhs);case"table":return lhs.get(rhs)}}}var Async=Object.freeze({__proto__:null,getFirst:async function(funcs){checkType(funcs,"list");const promises=funcs.map(func=>(checkType(func,"function"),func.call()));return await Promise.race(promises)},getAll:async function(funcs){checkType(funcs,"list");const promises=funcs.map(func=>(checkType(func,"function"),func.call()));return im.List(await Promise.all(promises))},sleep:async function(ms){return await new Promise(next=>setTimeout(next,ms)),null},$yield:async function(){return await new Promise(next=>setTimeout(next,0)),null}});var Bool=Object.freeze({__proto__:null,toNum:function(boolean){return checkType(boolean,"boolean"),boolean?1:0}});function get$4(object,key){return checkKey(object,key),object.get(key)}function len$4(object){return checkType(object,"object"),object.size}function select$1(object,keys){checkType(object,"object"),checkType(keys,"list");const map=new Map;for(const key of keys)checkKey(object,key),map.set(key,object.get(key));return im.OrderedMap(map)}function focus$1(object,keys){checkType(object,"object"),checkType(keys,"list");const map=new Map;for(const key of keys)checkKey(object,key),map.set(key,object.get(key));for(const[key,value]of object)checkKey(object,key),map.set(key,value);return im.OrderedMap(map)}function removeAll$2(object,keys){return checkType(object,"object"),checkType(keys,"list"),object.deleteAll(keys)}function rename$1(object,old,$new){checkType(object,"object"),checkKey(object,old);const map=new Map;for(const[key,value]of object){const newKey=im.is(key,old)?$new:key;map.set(newKey,value)}return im.OrderedMap(map)}var Obj=Object.freeze({__proto__:null,of:function(value){return checkType(value,"table","object"),"table"===getType(value)?value.data:value},has:function(object,key){return checkType(object,"object"),object.has(key)},matches:function(object,matcher){return isMatch(object,matcher)},get:get$4,getDefault:function(object,key,$default){return checkType(object,"object"),object.get(key,$default)},set:function(object,key,value){return checkType(object,"object"),object.set(key,value)},put:function(value,object,key){return checkType(object,"object"),object.set(key,value)},setDefault:function(object,key,value){return checkType(object,"object"),object.has(key)?object:object.set(key,value)},merge:function(objects){return checkType(objects,"list"),objects.forEach(object=>checkType(object,"object")),im.OrderedMap().concat(...objects)},keys:function(object){return checkType(object,"object"),object.keySeq().toList()},values:function(object){return checkType(object,"object"),object.valueSeq().toList()},len:len$4,isEmpty:function(object){return 0===len$4(object)},select:select$1,focus:focus$1,remove:function(object,key){return checkType(object,"object"),object.delete(key)},removeAll:removeAll$2,rename:rename$1});function flattenCols(table,columns){return checkType(columns,"string","list"),"string"===getType(columns)?(table.checkColumns(columns),im.List([columns])):(table.checkColumns(...columns),columns)}function of$5(value){switch(checkType(value,"object","list","table"),getType(value)){case"table":return value;case"object":return new Table$1(value)}if(!value.size)return new Table$1;checkType(value.first(),"object");const columns=value.first().keySeq().toList();return Table$1.fromRows(value,columns)}function $new(columns){return checkType(columns,"list"),Table$1.fromRows(im.List(),columns)}function len$3(table){return checkType(table,"table"),table.size}function isEmpty$3(table){return 0==len$3(table)}function take$2(table,count){checkType(table,"table");const data=new Map;for(const[column,values]of table.data)data.set(column,take$1(values,count));return new Table$1(im.OrderedMap(data))}function dropLast$2(table,count){checkType(table,"table");const data=new Map;for(const[column,values]of table.data)data.set(column,dropLast$1(values,count));return new Table$1(im.OrderedMap(data))}function selectValues(object,columns){return columns.map(column=>get$4(object,column))}function doSortBy$1(table,columns,desc){return of$5(im.List([...table]).sortBy(row=>selectValues(row,columns),(a,b)=>compareAll(a,b,desc)))}function sortBy$1(table,columns){return checkType(table,"table"),doSortBy$1(table,columns=flattenCols(table,columns),!1)}function sortDescBy$1(table,columns){return checkType(table,"table"),doSortBy$1(table,columns=flattenCols(table,columns),!0)}function listExtremum(table,columns,desc){return im.List([...table]).maxBy(row=>selectValues(row,columns),(a,b)=>compareAll(a,b,desc))}function listExtremumAll$1(table,columns,desc){table.checkNonEmpty(),columns=flattenCols(table,columns);const pairs=[];for(const row of table){const rank=selectValues(row,columns);pairs.push({row:row,rank:rank})}const ranked=im.List(pairs),limitRank=ranked.map(({rank:rank})=>rank).max((a,b)=>compareAll(a,b,desc));return of$5(ranked.filter(({rank:rank})=>im.is(rank,limitRank)).map(({row:row})=>row))}function group$1(table,columns){checkType(table,"table"),columns=flattenCols(table,columns);let groups=im.OrderedMap();for(const row of table){const group=selectValues(row,columns);groups.has(group)||(groups=groups.set(group,[])),groups.get(group).push(row)}return groups.valueSeq().map(group=>of$5(im.List(group))).toList()}var Table=Object.freeze({__proto__:null,of:of$5,$new:$new,len:len$3,isEmpty:isEmpty$3,defaultCols:function(table,columns){return checkType(table,"table"),checkType(columns,"list"),table.width?(table.checkColumns(...columns),table):$new(columns)},rows:function(table){return im.List(table)},reverse:function(table){return checkType(table,"table"),of$5(im.List(table).reverse())},unique:function(table){return checkType(table,"table"),of$5(im.OrderedSet(table).toList())},get:function(table,selector){return checkType(table,"table"),table.get(selector)},set:function(table,selector,value){return checkType(table,"table"),table.set(selector,value)},put:function(value,table,selector){return checkType(table,"table"),table.set(selector,value)},has:function(table,selector){return checkType(table,"table"),table.has(selector)},columns:function(table){return checkType(table,"table"),table.columns()},indexOf:function(table,matcher){return checkType(table,"table"),table.findMatch(matcher)??null},match:function(table,matcher){return checkType(table,"table"),table.match(matcher)},remove:function(table,selector){return checkType(table,"table"),checkType(selector,"object","string","list"),"object"===getType(selector)?table.remove(selector):(selector=flattenCols(table,selector),new Table$1(removeAll$2(table.data,selector)))},push:function(table,row){return table.addRow(row)},pop:function(table){if(checkType(table,"table"),0===table.size)throw new Panic$1("empty table");return dropLast$2(table,1)},splice:function(table,index,count,rows){checkType(table,"table"),table.checkIndex(index),checkWhole(count),checkType(rows,"table");const newRows=im.List(table).splice(index,count,...rows);return Table$1.fromRows(newRows,table.columns())},merge:function(tables){return Table$1.merge(tables)},take:take$2,takeLast:function(table,count){checkType(table,"table");const data=new Map;for(const[column,values]of table.data)data.set(column,takeLast$1(values,count));return new Table$1(im.OrderedMap(data))},drop:function(table,count){checkType(table,"table");const data=new Map;for(const[column,values]of table.data)data.set(column,drop$1(values,count));return new Table$1(im.OrderedMap(data))},dropLast:dropLast$2,map:async function(table,func){return checkType(table,"table"),await table.map(func)},filter:async function(table,condition){return checkType(table,"table"),await table.filter(condition)},select:function(table,columns){return checkType(table,"table"),columns=flattenCols(table,columns),new Table$1(select$1(table.data,columns))},focus:function(table,columns){return checkType(table,"table"),columns=flattenCols(table,columns),new Table$1(focus$1(table.data,columns))},rename:function(table,old,$new){return checkType(table,"table"),new Table$1(rename$1(table.data,old,$new))},sortBy:sortBy$1,sortDescBy:sortDescBy$1,top:function(table,columns,count){return take$2(sortDescBy$1(table,columns),count)},bottom:function(table,columns,count){return take$2(sortBy$1(table,columns),count)},minBy:function(table,columns){return checkType(table,"table"),table.checkNonEmpty(),listExtremum(table,flattenCols(table,columns),!0)},maxBy:function(table,columns){return checkType(table,"table"),table.checkNonEmpty(),listExtremum(table,flattenCols(table,columns),!1)},minAll:function(table,columns){return checkType(table,"table"),isEmpty$3(table)?table:listExtremumAll$1(table,columns,!0)},maxAll:function(table,columns){return checkType(table,"table"),isEmpty$3(table)?table:listExtremumAll$1(table,columns,!1)},group:group$1,summarize:async function(table,columns,reducer){const groups=group$1(table,columns);columns=flattenCols(table,columns),checkType(reducer,"function");const rows=[];for(const group of groups){const row=new Map;for(const column of columns){const values=group.data.get(column);row.set(column,values.first())}const summary=await reducer.call(group);checkType(summary,"object"),rows.push(im.OrderedMap(row).concat(summary))}return of$5(im.List(rows))},counts:function(table){if(checkType(table,"table"),table.data.has("count"))throw new Panic$1("table already contains column 'count'");if(table.data.has("share"))throw new Panic$1("table already contains column 'share'");const counts=new Map;for(const row of table){const column=repr(row);counts.has(column)?counts.get(column).count+=1:counts.set(column,{row:row,count:1})}const rows=im.List(counts.values()).map(({row:row,count:count})=>row.set("count",count).set("share",count/table.size));return sortDescBy$1(of$5(rows),"count")}});function of$4(values){return checkType(values,"list","set","table"),im.List(values)}function len$2(list){return checkType(list,"list"),list.size}function isEmpty$2(list){return 0==len$2(list)}function take$1(list,count){return checkType(list,"list"),checkWhole(count),list.take(count)}function takeLast$1(list,count){return checkType(list,"list"),checkWhole(count),list.takeLast(count)}function drop$1(list,count){return checkType(list,"list"),checkWhole(count),list.skip(count)}function dropLast$1(list,count){return checkType(list,"list"),checkWhole(count),list.skipLast(count)}function doSort(list,desc){return checkType(list,"list"),list.sort((a,b)=>compare(a,b,desc))}function sort(list){return doSort(list,!1)}function sortDesc(list){return doSort(list,!0)}async function doSortBy(list,ranker,desc){checkType(list,"list"),checkType(ranker,"function");const ranks=[];for(const value of list)ranks.push({rank:await ranker.call(value),value:value});return im.List(ranks.sort((a,b)=>compare(a.rank,b.rank,desc)).map(({value:value})=>value))}async function getRanked(list,desc,func){const pairs=[];for(const value of list){const rank=func?await func.call(value):value;checkType(rank,"number","string","boolean","none"),pairs.push({value:value,rank:rank})}const ranked=im.List(pairs),limit=ranked.maxBy(({rank:rank})=>rank,(a,b)=>compare(a,b,desc));return{ranked:ranked,limit:limit}}async function listExtremumAll(list,desc,func){const{ranked:ranked,limit:limit}=await getRanked(list,desc,func);return ranked.filter(({rank:rank})=>rank==limit.rank).map(({value:value})=>value)}function sum(numbers){checkType(numbers,"list");let result=0;for(const n of numbers)result+=checkType(n,"number");return checkNumResult(result)}function span$2(from,to){checkWhole(from),checkWhole(to);const min=Math.min(from,to),max=Math.max(from,to),elems=[];for(let n=min;n<=max;n++)elems.push(n);return from<to?im.List(elems):im.List(elems).reverse()}function normalize(numbers){checkType(numbers,"list");let total=0;for(const n of numbers)checkType(n,"number"),checkPositive(n),total+=n;if(0==total)throw new Panic$1("cannot normalize numbers with sum 0");return numbers.map(n=>checkNumResult(n/total))}var List=Object.freeze({__proto__:null,of:of$4,len:len$2,repeat:function(value,count){return checkPositive(count),checkWhole(count),im.Repeat(value,count).toList()},isEmpty:isEmpty$2,has:function(list,value){return checkType(list,"list"),list.includes(value)},hasAll:function(list,values){return checkType(list,"list"),list.toSet().isSuperset(of$4(values))},get:function(list,index){return checkType(list,"list"),checkIndex(list,index),list.get(index)},set:function(list,index,value){return checkType(list,"list"),checkIndex(list,index),list.set(index,value)},put:function(value,list,index){return checkType(list,"list"),checkIndex(list,index),list.set(index,value)},push:function(list,value){return checkType(list,"list"),list.push(value)},pop:function(list){return checkNonEmpty(list),list.pop()},reverse:function(list){return checkType(list,"list"),list.reverse()},swap:function(list,indexA,indexB){checkType(list,"list"),checkIndex(list,indexA),checkIndex(list,indexB);const a=list.get(indexA),b=list.get(indexB);return list.set(indexA,b).set(indexB,a)},take:take$1,takeLast:takeLast$1,drop:drop$1,dropLast:dropLast$1,splice:function(list,index,count,values){return checkType(list,"list"),checkIndex(list,index),checkWhole(count),checkType(values,"list"),list.splice(index,count,...values)},merge:function(lists){return checkType(lists,"list"),lists.forEach(list=>checkType(list,"list")),im.List().concat(...lists)},chunks:function(list,count){checkType(list,"list"),checkWhole(count),checkPositive(count);const elems=[];for(let index=0;index<list.size;index+=count)elems.push(list.slice(index,index+count));return im.List(elems)},map:async function(list,func){checkType(list,"list"),checkType(func,"function");const elems=[];for(const value of list)elems.push(await func.call(value));return im.List(elems)},filter:async function(list,condition){checkType(list,"list"),checkType(condition,"function");const elems=[];for(const value of list)await condition.callCondition(value)&&elems.push(value);return im.List(elems)},remove:function(list,value){return checkType(list,"list"),list.filter(elem=>!im.is(elem,value))},removeAll:function(list,values){return checkType(list,"list"),list.filter(elem=>!of$4(values).includes(elem))},find:async function(list,condition){checkType(list,"list"),checkType(condition,"function");for(const value of list)if(await condition.callCondition(value))return value;return null},indexOf:function(list,value){checkType(list,"list");const index=list.indexOf(value);return index>=0?index:null},count:function(list,value){return checkType(list,"list"),list.count(elem=>im.is(elem,value))},group:async function(list,func){checkType(list,"list"),checkType(func,"function");const groups=new Map;for(const value of list){const group=await func.call(value);groups.has(group)||groups.set(group,[]),groups.get(group).push(value)}return im.OrderedMap(groups).map(im.List)},sort:sort,sortDesc:sortDesc,sortBy:async function(list,ranker){return await doSortBy(list,ranker,!1)},sortDescBy:async function(list,ranker){return await doSortBy(list,ranker,!0)},top:function(list,count){return take$1(sortDesc(list),count)},bottom:function(list,count){return take$1(sort(list),count)},min:async function(list){return checkType(list,"list"),checkNonEmpty(list),(await getRanked(list,!0,null)).limit.rank},max:async function(list){return checkType(list,"list"),checkNonEmpty(list),(await getRanked(list,!1,null)).limit.rank},minBy:async function(list,func){return checkType(list,"list"),checkType(func,"function"),checkNonEmpty(list),(await getRanked(list,!0,func)).limit.value},maxBy:async function(list,func){return checkType(list,"list"),checkType(func,"function"),checkNonEmpty(list),(await getRanked(list,!1,func)).limit.value},minAll:async function(list,func){return checkType(list,"list"),checkType(func,"function"),isEmpty$2(list)?list:await listExtremumAll(list,!0,func)},maxAll:async function(list,func){return checkType(list,"list"),checkType(func,"function"),isEmpty$2(list)?list:await listExtremumAll(list,!1,func)},minNone:async function(list){return checkType(list,"list"),isEmpty$2(list)?null:(await getRanked(list,!0,null)).limit.rank},maxNone:async function(list){return checkType(list,"list"),isEmpty$2(list)?null:(await getRanked(list,!1,null)).limit.rank},sum:sum,average:function(numbers){return checkType(numbers,"list"),checkNonEmpty(numbers),sum(numbers)/numbers.size},median:function(numbers){checkType(numbers,"list"),checkNonEmpty(numbers);const sorted=[...sort(numbers)];return sorted.length%2==1?sorted[Math.floor(sorted.length/2)]:checkNumResult(sorted[sorted.length/2-1]/2+sorted[sorted.length/2]/2)},counts:function(list){checkType(list,"list");const counts=new Map;for(const value of list){const count=counts.get(value)??0;counts.set(value,count+1)}const columns=(new Map).set("value",im.List(counts.keys())).set("count",im.List(counts.values())).set("share",im.List(counts.values().map(c=>c/list.size)));return sortDescBy$1(new Table$1(im.OrderedMap(columns)),"count")},all:function(list){checkType(list,"list");for(const value of list)if(!checkType(value,"boolean"))return!1;return!0},any:function(list){checkType(list,"list");for(const value of list)if(checkType(value,"boolean"))return!0;return!1},unique:function(list){return checkType(list,"list"),list.toOrderedSet().toList()},span:span$2,range:function(limit){return checkWhole(limit),limit<1?im.List():span$2(0,limit-1)},normalize:normalize,percents:function(numbers){return normalize(numbers).map(n=>100*n)}});function of$3(code){return checkPositive(code),checkWhole(code),String.fromCodePoint(code)}function checkChar(string){if(checkType(string,"string"),1!=[...string].length)throw new Panic$1("expected a single character",{string:string})}var Char=Object.freeze({__proto__:null,of:of$3,code:function(char){return checkChar(char),char.codePointAt(0)},span:function(from,to){return checkChar(from),checkChar(to),span$2(from.codePointAt(0),to.codePointAt(0)).map(of$3)}});const historyPath=tmpdir()+"/repl-history";let history;async function getLine(message){return history??=await async function(){try{return(await readFile(historyPath,"utf8")).split("\n").map(line=>JSON.parse(`"${line}"`))}catch(err){if("ENOENT"===err.code)return await writeFile(historyPath,""),[];throw err}}(),new Promise((resolve,reject)=>{let open=!0;const rl=createInterface({input:stdin,output:stdout,history:[...history],prompt:message});function cleanup(){open=!1,rl.close()}rl.prompt(),rl.on("line",async line=>{cleanup(),await async function(history,line){if(line=line.trim(),line!==history[0]){history.unshift(line),history.length>limit&&history.pop();const serialized=history.map(entry=>JSON.stringify(entry).slice(1,-1)).join("\n");await writeFile(historyPath,serialized)}}(history,line),resolve(line)}),rl.on("SIGINT",()=>{cleanup(),console.log(),reject(new Panic$1("keyboard interrupt"))}),rl.on("close",()=>{open&&(cleanup(),console.log(),reject(new Panic$1("EOF interrupt")))})})}const limit=50;var Console=Object.freeze({__proto__:null,print:function(value){return console.log(show(value)),value},debug:function(value){return console.log(repr(value)),value},write:function(string){return checkType(string,"string"),stdout.write(string),string},error:function(value){return console.error(show(value)),value},clear:function(){return console.clear(),null},prompt:async function(message){return checkType(message,"string"),await getLine(message)},rawKey:function(){return new Promise((resolve,reject)=>{emitKeypressEvents(stdin),stdin.setRawMode(!0),stdin.resume(),stdin.once("keypress",(str,key)=>{if(stdin.setRawMode(!1),stdin.pause(),key.ctrl&&"c"===key.name)return console.log(),void reject(new Panic$1("keyboard interrupt"));if(key.ctrl&&"d"===key.name)return console.log(),void reject(new Panic$1("EOF interrupt"));const map=(new Map).set("str",str??null).set("name",key.name).set("ctrl",key.ctrl).set("meta",key.meta).set("shift",key.shift).set("sequence",key.sequence);resolve(im.OrderedMap(map))})})},pauseStdin:function(){return stdin.pause(),null}});class Err$1 extends Panic$1{constructor(payload){super("unhandled error",{payload:payload}),this.payload=payload}}var Err=Object.freeze({__proto__:null,$throw:function(payload){throw new Err$1(payload)},$try:async function(func,handler){checkType(func,"function"),checkType(handler,"function");try{return await func.call()}catch(err){if(err instanceof Err$1)return await handler.call(err.payload);throw err}},orElse:async function(func,$default){checkType(func,"function");try{return await func.call()}catch(err){if(err instanceof Err$1)return $default;throw err}}});var Fs=Object.freeze({__proto__:null,read:async function(path){checkType(path,"string");try{return await readFile(path,{encoding:"utf8"})}catch(err){throw new Panic$1("file read error",{path:path,err:String(err)})}},readBytes:async function(path){try{return im.List(await readFile(path))}catch(err){throw new Panic$1("file read error",{path:path,err:String(err)})}},write:async function(value,path){checkType(path,"string");try{const string=show(value);return await writeFile(path,string),string}catch(err){throw new Panic$1("file write error",{path:path,err:String(err)})}},writeBytes:async function(bytes,path){checkType(path,"string"),checkType(bytes,"list");for(const byte of bytes)if(checkType(byte,"number"),checkWhole(byte),byte<0||byte>255)throw new Panic$1("byte out of range",{byte:byte});return await writeFile(path,Buffer$1.from([...bytes])),bytes},ls:async function(path){const fullPath=resolve(path);try{const entries=await readdir(fullPath,{withFileTypes:!0});return im.List(entries.map(entry=>entry.isDirectory()?`${entry.name}/`:entry.name))}catch(_){throw new Panic$1("cannot access",{path:fullPath})}}});const pi=Math.PI,tau=2*pi,e=Math.E;function round(n){if(checkType(n,"number"),n%1==.5){const floor=Math.floor(n);return floor%2==0?floor:floor+1}return Math.round(n)}function ln(n){return checkType(n,"number"),checkPositive(n),Math.log(n)}var Math$1=Object.freeze({__proto__:null,pi:pi,tau:tau,e:e,inf:Infinity,nan:NaN,isInt:function(n){return checkType(n,"number"),Number.isInteger(n)},abs:function(n){return checkType(n,"number"),Math.abs(n)},floor:function(n){return checkType(n,"number"),Math.floor(n)},ceil:function(n){return checkType(n,"number"),Math.ceil(n)},round:round,roundTo:function(n,decimals){if(checkType(n,"number"),checkWhole(decimals),decimals<0){const factor=10**-decimals;return round(n/factor)*factor}const factor=10**decimals;return round(n*factor)/factor},min:function(a,b){return checkType(a,"number"),checkType(b,"number"),Math.min(a,b)},max:function(a,b){return checkType(a,"number"),checkType(b,"number"),Math.max(a,b)},clamp:function(n,min,max){return checkType(n,"number"),checkType(min,"number"),checkType(max,"number"),Math.max(min,Math.min(max,n))},wrap:function(n,start,limit){if(checkType(n,"number"),checkType(start,"number"),checkType(limit,"number"),start>=limit)throw new Panic$1("start must be less than limit");const diff=limit-start;return start+((n-start)%diff+diff)%diff},sign:function(n){return checkType(n,"number"),Math.sign(n)},isEven:function(n){return checkWhole(n),n%2==0},isOdd:function(n){return checkWhole(n),n%2!=0},sqrt:function(n){return checkType(n,"number"),checkPositive(n),Math.sqrt(n)},acos:function(n){return checkType(n,"number"),checkNumResult(Math.acos(n))},asin:function(n){return checkType(n,"number"),checkNumResult(Math.asin(n))},atan:function(n){return checkType(n,"number"),Math.atan(n)},atan2:function(y,x){return checkType(y,"number"),checkType(x,"number"),Math.atan2(y,x)},ln:ln,log10:function(n){return ln(n)/Math.LN10},log2:function(n){return ln(n)/Math.LN2},logBase:function(a,b){return ln(a)/ln(b)},cos:function(n){return checkType(n,"number"),Math.cos(n)},sin:function(n){return checkType(n,"number"),Math.sin(n)},tan:function(n){return checkType(n,"number"),Math.tan(n)},toDegrees:function(radians){return checkType(radians,"number"),180*radians/Math.PI},toRadians:function(degrees){return checkType(degrees,"number"),degrees*Math.PI/180}});var None=Object.freeze({__proto__:null,orElse:function(value,$default){return"none"===getType(value)?$default:value}});var Panic=Object.freeze({__proto__:null,raise:function(message){throw checkType(message,"string"),new Panic$1(message)},unreachable:function(){throw new Panic$1("encountered unreachable code")},unimplemented:function(){throw new Panic$1("not implemented")}});function span(from,to){checkWhole(from),checkWhole(to);const min=Math.min(from,to),max=Math.max(from,to);return Math.floor(Math.random()*(max-min+1))+min}var Rand=Object.freeze({__proto__:null,random:function(){return Math.random()},bool:function(){return Math.random()>.5},sample:function(values){checkType(values,"list","table","set");const index=Math.floor(Math.random()*values.size);return"set"===getType(values)&&(values=im.List(values)),"list"===getType(values)?(checkNonEmpty(values),values.get(index)):(values.checkNonEmpty(),values.getRow(index))},span:span,range:function(limit){return checkWhole(limit),span(0,limit-1)},shuffle:function(values){checkType(values,"list","table");const items=[...values];for(let i=items.length-1;i>0;i--){const j=span(0,i),tmp=items[i];items[i]=items[j],items[j]=tmp}return"list"===getType(values)?im.List(items):Table$1.fromRows(im.List(items),values.keys())}});var Ref=Object.freeze({__proto__:null,of:function(value){return new Ref$1(value)},get:function(ref){return checkType(ref,"reference"),ref.value},set:function(ref,value){return checkType(ref,"reference"),ref.value=value,ref},put:function(value,ref){return checkType(ref,"reference"),ref.value=value,value}});const cache$1=new Map;function lookup(pattern){return cache$1.has(pattern)||cache$1.set(pattern,new RegExp(pattern,"g")),cache$1.get(pattern)}var Re=Object.freeze({__proto__:null,escape:function(string){return checkType(string,"string"),string.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")},test:function(string,pattern){return checkType(string,"string"),checkType(pattern,"string"),lookup(pattern).test(string)},match:function(string,pattern){checkType(string,"string"),checkType(pattern,"string");const rows=im.List(string.matchAll(lookup(pattern))??[]).map(result=>{const value=result[0],index=result.index,groups=im.List(result.slice(1)),named=im.OrderedMap(Object.entries(result.groups??{}));return im.OrderedMap(Object.entries({value:value,index:index,groups:groups,named:named}))});return Table$1.fromRows(rows,im.List(["value","index","groups","named"]))},split:function(string,pattern){return checkType(string,"string"),checkType(pattern,"string"),im.List(string.split(lookup(pattern)))},replace:function(string,pattern,replacement){return checkType(string,"string"),checkType(pattern,"string"),checkType(replacement,"string"),string.replaceAll(lookup(pattern),()=>replacement)},replaceBy:async function(string,pattern,replacer){checkType(string,"string"),checkType(pattern,"string"),checkType(replacer,"function");const replacements=[];for(const match of string.matchAll(lookup(pattern)))replacements.push(show(await replacer.call(match[0])));return replacements.reverse(),string.replaceAll(lookup(pattern),()=>replacements.pop())}});function of$1(values){return checkType(values,"set","list","table"),im.OrderedSet(values)}const empty=im.OrderedSet();function len$1(set){return checkType(set,"set"),set.size}function subsets(elems){if(!elems.length)return[[]];const suffixes=subsets(elems.slice(1));return[...suffixes.map(subset=>[elems[0],...subset]),...suffixes]}var Set$1=Object.freeze({__proto__:null,of:of$1,empty:empty,len:len$1,isEmpty:function(set){return 0==len$1(set)},has:function(set,value){return checkType(set,"set"),set.has(value)},hasAll:function(set,values){return checkType(set,"set"),set.isSuperset(of$1(values))},add:function(set,value){return checkType(set,"set"),set.add(value)},addAll:function(set,values){return checkType(set,"set"),set.union(of$1(values))},remove:function(set,value){return checkType(set,"set"),set.delete(value)},removeAll:function(set,values){return checkType(set,"set"),set.subtract(of$1(values))},merge:function(sets){return checkType(sets,"list"),im.OrderedSet().concat(...sets.map(of$1))},intersection:function(set,values){return checkType(set,"set"),set.intersect(of$1(values))},powerset:function(set){checkType(set,"set");const sets=subsets([...set]).map(elems=>im.OrderedSet(elems));return im.List(sets)}});function len(string){return checkType(string,"string"),[...string].length}const newline=/\r?\n/g;function toUpper(string){return checkType(string,"string"),string.toUpperCase()}function toLower(string){return checkType(string,"string"),string.toLowerCase()}var Str=Object.freeze({__proto__:null,of:function(value){return show(value)},len:len,isEmpty:function(string){return 0==len(string)},chars:function(string){return checkType(string,"string"),im.List([...string])},lines:function(string){return checkType(string,"string"),im.List(string.split(newline))},get:function(string,index){checkType(string,"string"),checkWhole(index);const chars=[...string];if(index<-chars.length||index>=chars.length)throw new Panic$1("string index out of range",{index:index,length:chars.length});return chars.at(index)},take:function(string,count){return checkType(string,"string"),checkWhole(count),[...string].slice(0,count).join("")},takeLast:function(string,count){return checkType(string,"string"),checkWhole(count),[...string].slice(-count).join("")},drop:function(string,count){return checkType(string,"string"),checkWhole(count),[...string].slice(count).join("")},dropLast:function(string,count){return checkType(string,"string"),checkWhole(count),[...string].slice(0,-count).join("")},splice:function(string,index,count,subString){checkType(string,"string");const chars=im.List([...string]);return checkIndex(chars,index),checkWhole(count),checkType(subString,"string"),chars.splice(index,count,subString).join("")},split:function(string,separator){return checkType(string,"string"),checkType(separator,"string"),im.List(string.split(separator))},join:function(list,separator){return checkType(list,"list"),checkType(separator,"string"),list.map(show).join(separator)},repeat:function(string,count){return checkType(string,"string"),checkType(count,"number"),checkWhole(count),string.repeat(Math.max(0,count))},reverse:function(string){return checkType(string,"string"),[...string].reverse().join("")},replace:function(string,subString,replacement){return checkType(string,"string"),checkType(subString,"string"),checkType(replacement,"string"),string.replaceAll(subString,()=>replacement)},replaceFirst:function(string,subString,replacement){return checkType(string,"string"),checkType(subString,"string"),checkType(replacement,"string"),string.replace(subString,()=>replacement)},startsWith:function(string,prefix){return checkType(string,"string"),checkType(prefix,"string"),string.startsWith(prefix)},endsWith:function(string,prefix){return checkType(string,"string"),checkType(prefix,"string"),string.endsWith(prefix)},has:function(string,subString){return checkType(string,"string"),checkType(subString,"string"),string.includes(subString)},indexOf:function(string,subString){checkType(string,"string");const index=string.indexOf(subString);return index>=0?index:null},padLeft:function(value,n){return checkType(n,"number"),checkWhole(n),checkPositive(n),show(value).padStart(n)},padRight:function(value,n){return checkType(n,"number"),checkWhole(n),checkPositive(n),show(value).padEnd(n)},trim:function(string){return checkType(string,"string"),string.trim()},trimLeft:function(string){return checkType(string,"string"),string.trimStart()},trimRight:function(string){return checkType(string,"string"),string.trimEnd()},toUpper:toUpper,toLower:toLower,isUpper:function(string){return toUpper(string)===string},isLower:function(string){return toLower(string)===string},isAlpha:function(string){return checkType(string,"string"),/^\p{L}*$/u.test(string)},isAlphaNum:function(string){return checkType(string,"string"),/^(\p{L}|\p{N})*$/u.test(string)},isDigit:function(string){return checkType(string,"string"),/^\p{N}*$/u.test(string)},isAsciiAlpha:function(string){return checkType(string,"string"),/^[a-zA-Z]*$/.test(string)},isAsciiAlphaNum:function(string){return checkType(string,"string"),/^[a-zA-Z0-9]*$/.test(string)},isAsciiDigit:function(string){return checkType(string,"string"),/^[0-9]*$/.test(string)},parse:function(string){switch(checkType(string,"string"),string){case"true":return!0;case"false":return!1;case"none":return null}const result=Number(string);if(""!==string&&!Number.isNaN(result))return result;throw new Panic$1("cannot parse string",{string:string})}});const natives={Async:Async,Bool:Bool,Char:Char,Console:Console,Err:Err,Fs:Fs,List:List,Math:Math$1,None:None,Obj:Obj,Panic:Panic,Rand:Rand,Ref:Ref,Re:Re,Set:Set$1,Str:Str,Table:Table,Test:Object.freeze({__proto__:null,assert:function(predicate){if(checkType(predicate,"boolean"),!predicate)throw new Panic$1("assertion error");return null},runs:async function(func){try{return await func.call(),im.OrderedMap({status:"pass"})}catch(err){return im.OrderedMap({status:"fail",panic:String(err)})}},equals:function(actual,expected){return im.is(actual,expected)?im.OrderedMap({status:"pass"}):im.OrderedMap({status:"fail",expected:expected,got:actual})},returns:async function(func,expected){try{const actual=await func.call();return im.is(actual,expected)?im.OrderedMap({status:"pass"}):im.OrderedMap({status:"fail",expected:expected,got:actual})}catch(err){return im.OrderedMap({status:"fail",panic:String(err)})}},throws:async function(func,payload){try{const returned=await func.call();return im.OrderedMap({status:"fail",returned:returned})}catch(err){return err instanceof Err$1?im.is(err.payload,payload)?im.OrderedMap({status:"pass"}):im.OrderedMap({status:"fail",expected:payload,actual:err.payload}):im.OrderedMap({status:"fail",panic:String(err)})}}})};let std,modules,globals,variants;function spawnStd(){return std||(function(){modules={};const paramChars=/\(([$\w\s,]*)\)/;for(const[modName,native]of Object.entries(natives)){const mod={};for(let[name,value]of Object.entries(native))if(!name.startsWith("_")){if(name=name.replaceAll("$",""),value instanceof Function){const paramStr=value.toString().match(paramChars)[1].replaceAll(" ","").replaceAll("$",""),fullName=`${modName}.${name.replaceAll("$","")}`,params=paramStr.length?paramStr.split(","):[];value=new Func(value,fullName,params)}mod[name]=value}modules[modName]={};for(const name of Object.keys(mod).toSorted())modules[modName][name]=mod[name]}}(),globals={assert:modules.Test.assert,chars:modules.Str.chars,clear:modules.Console.clear,join:modules.Str.join,max:modules.List.max,min:modules.List.min,parse:modules.Str.parse,print:modules.Console.print,prompt:modules.Console.prompt,range:modules.List.range,round:modules.Math.round,roundTo:modules.Math.roundTo,sleep:modules.Async.sleep,sort:modules.List.sort,sortDesc:modules.List.sortDesc,span:modules.List.span,split:modules.Str.split,sum:modules.List.sum},function(){const overloads={drop:["values","count"],dropLast:["values","count"],isEmpty:["values"],len:["values"],push:["values","item"],remove:["values","elem"],reverse:["values"],select:["collection","keys"],sortBy:["values","ranker"],sortDescBy:["values","ranker"],take:["values","count"],takeLast:["values","count"]},typesMap={list:"List",none:"None",number:"Math",object:"Obj",set:"Set",string:"Str",table:"Table"};variants={},modules.Overloads={};for(const[name,params]of Object.entries(overloads)){const types=[];variants[name]=[];for(const[type,modName]of Object.entries(typesMap)){const value=modules[modName]?.[name];value&&(variants[name].push(value),types.push(type))}const overload=new Func((...args)=>{checkType(args[0],...types);const modName=typesMap[getType(args[0])];return modules[modName][name].call(...args)},`Overloads.${name}`,params);globals[name]=overload,modules.Overloads[name]=overload}}(),function(){const defs={};for(const name of Object.keys(modules).toSorted())defs[name]=im.OrderedMap(modules[name]);Object.assign(defs,globals),std=new Env(null,new Map(Object.entries(defs)))}()),std.spawn()}const cache=new Map,prefixChars=/^(?:([a-z]+):)?/;async function getImport(root,path){let prefix=path.match(prefixChars)[1];prefix?path=path.slice(prefix.length+1):prefix="";const relPath=resolve(root,path);let absPath;try{absPath=await realpath(relPath)}catch{throw new Panic$1("cannot read file",{path:relPath})}const cachePath=`${prefix}:${absPath}`;if(cache.has(cachePath)){const result=cache.get(cachePath);if(void 0===result)throw new Panic$1("circular import",{path:relPath});return result}cache.set(cachePath,void 0);const result=await async function(prefix,relPath,absPath){if("raw"===prefix)return im.List(await readFile(absPath));const source=await readFile(absPath,"utf8");switch(prefix){case"text":return source;case"lines":return im.List(source.replace(/\r?\n^/,"").split(/\r?\n/g));case"csv":return Table$1.fromCsv(source);case"json":return string=source,convert(JSON.parse(string));case"":{const statements=parse$1(tokenize(relPath,source));return await async function(statements){return(await spawnStd()).eval(statements)}(statements)}default:throw new Panic$1("invalid import prefix",{prefix:prefix})}var string}(prefix,relPath,absPath);return cache.set(cachePath,result),result}const env=await spawnStd();async function runInput(input){const statements=parse$1(tokenize("repl",input));for(const statement of statements){const ans=await env.eval(statement);"def"!==statement.type&&(console.log(repr(ans)),env.defs.set("ans",ans))}}!async function(){try{argv.length>2?await getImport(argv[2],"./"):await async function(){for(;;)try{const input=await getLine(">> ");await runInput(input)}catch(err){if(!(err instanceof Panic$1))throw err;if("EOF interrupt"===err.message)return;console.log(String(err))}}()}catch(err){throw err instanceof Panic$1&&console.log(String(err)),err}}();
